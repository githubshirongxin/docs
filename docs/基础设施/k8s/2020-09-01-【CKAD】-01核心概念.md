---
layout: post
title: 【CKAD】核心概念
---

尽管安装和配置Kubernetes集群不是CKAD考试的目标之一，但重要的一点是要获得本课程中涵盖的概念的实际操作经验。因此，拥有一个Kubernetes集群非常有用，您可以用它进行实验并尝试整个课程中涉及的内容。本课程将指导您完成构建基本集群的过程，您可以在进行后续操作时进行试验。

### 课程参考

如果您想继续学习，下面有本课程中使用的命令的参考。

#### 在所有3台服务器上

首先，设置Docker和Kubernetes存储库：

```
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -

sudo add-apt-repository    "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
   $(lsb_release -cs) \
   stable"

curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -

cat << EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list
deb https://apt.kubernetes.io/ kubernetes-xenial main
EOF
```

安装Docker和Kubernetes软件包：

请注意，如果要使用Kubernetes的较新版本，请更改为kubelet，kubeadm和kubectl安装的版本。确保所有三个使用相同的版本。

**注意**：Kubernetes 1.13.4（及更早版本）中当前存在一个错误，该错误可能导致安装软件包时出现问题。使用1.13.5-00可以避免此问题。

```
sudo apt-get update

sudo apt-get install -y docker-ce=18.06.1~ce~3-0~ubuntu kubelet=1.14.5-00 kubeadm=1.14.5-00 kubectl=1.14.5-00

sudo apt-mark hold docker-ce kubelet kubeadm kubectl
```

启用iptables桥接呼叫：

```
echo "net.bridge.bridge-nf-call-iptables=1" | sudo tee -a /etc/sysctl.conf

sudo modprobe br_netfilter

sudo sysctl -p
```

#### 在Kube主服务器上

初始化集群：

```
sudo nano /proc/sys/net/ipv4/ip_forward
(Change from 0 to 1) 

sudo kubeadm init --pod-network-cidr=10.244.0.0/16
```

设置本地kubeconfig：

```
mkdir -p $HOME/.kube

sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config

sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

安装Flannel网络：

```
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/bc79dd1505b0c8681ece4de4c0d86c5cd2643275/Documentation/kube-flannel.yml
```

**注意：**如果您正在使用Kubernetes 1.16或更高版本，则需要使用更新的法兰绒安装yaml：

```
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/3f7d3e6c24f641e7ff557ebcea1136fdf4b1b6a1/Documentation/kube-flannel.yml
```

#### 在每个Kube节点服务器上

将节点加入集群。通过在初始化主节点时从输出中复制提供的行来执行此操作。请记住，复制命令时，如果系统在Web终端中跨多行，则系统将添加换行符。要解决此问题，请将命令复制到文本编辑器，并确保其适合整行。它看起来应该如下所示：

```
sudo kubeadm join $controller_private_ip:6443 --token $token --discovery-token-ca-cert-hash $hash
```

#### 在Kube主服务器上

验证所有节点已加入并准备就绪：

```
kubectl get nodes
```

您应该看到所有三台服务器的状态为“就绪”：

```
NAME                      STATUS   ROLES    AGE   VERSION
wboyd1c.mylabserver.com   Ready    master   54m   v1.13.4
wboyd2c.mylabserver.com   Ready    <none>   49m   v1.13.4
wboyd3c.mylabserver.com   Ready    <none>   49m   v1.13.4
```
