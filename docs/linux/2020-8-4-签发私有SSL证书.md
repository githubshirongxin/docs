---
layout: post
title: 【私有SSL证书】签发私有SSL证书，给nginx
---

以nexus配置nginx的SSL私有证书为例。

# 签发私有证书

## 生成私钥
正式生产环境建议使用商业证书！
使用openssl工具生成一个RSA私钥

`openssl genrsa -des3 -out nexus1.key 2048`

```
Generating RSA private key, 2048 bit long modulus
.......................+++
......+++
e is 65537 (0x10001)
Enter pass phrase for nexus.key:                   # 输入一个至少4位的密码
Verifying - Enter pass phrase for nexus.key:       # 重复输入密码
复制代码删除nexus.key中的密码
# openssl rsa -in nexus.key -out nexus.key
Enter pass phrase for nexus.key:                 # 输入刚才创建时的密码
writing RSA key
```

## 去掉key的密码 

`openssl rsa -in nexus1.key -out nexus.key`


## 生成CSR（证书签名请求）
```
# openssl req -new -key nexus.key -out nexus.csr
```

```
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:cn             # 国家
State or Province Name (full name) []:Sichuan    # 地区 
Locality Name (eg, city) [Default City]:Chengdu  # 城市
Organization Name (eg, company) [Default Company Ltd]:akiya  # 组织
Organizational Unit Name (eg, section) []:akiya  # 组织单位
Common Name (eg, your name or your server's hostname) []:akiya    # 常用名可填自己名字或域名
Email Address []:a@b.com                         # 邮件地址

Please enter the following 'extra' attributes
to be sent with your certificate request      
A challenge password []:       # 可留空
An optional company name []:   # 可留空
```


## 生成自签名证书
注意：在使用自签名的临时证书时，浏览器会提示证书的颁发机构是未知的。 

```
echo subjectAltName = IP:192.168.3.120 > extfile.cnf
openssl x509 -req -days 365 -in nexus.csr -signkey nexus.key -out nexus.crt -extfile extfile.cnf
```

```
Signature ok
subject=/C=cn/ST=Sichuan/L=Chengdu/O=akiya/OU=akiya/CN=akiya/emailAddress=a@b.com
Getting Private key
```

## 存放证书
拷贝到nginx的证书目录 cp nexus.* /etc/nginx/certs/

## 配置证书到nginx
```
# vim /etc/nginx/nginx.conf
# 替换 http 上下文的内容
http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    proxy_send_timeout 120;
    proxy_read_timeout 300;
    proxy_buffering    off;
    keepalive_timeout  5 5;
    tcp_nodelay        on;
    sendfile        on;
    #tcp_nopush     on;
    #gzip  on;

    include /etc/nginx/conf.d/*.conf;
}


# vim /etc/nginx/conf.d/nexus.conf
server {
    listen 2222 ssl;
    server_name nexus.ccbjb.com.cn;

    ssl_certificate /etc/nginx/certs/nexus.crt;
    ssl_certificate_key /etc/nginx/certs/nexus.key;
    ssl_session_cache shared:SSL:50m;

    location / {
        proxy_set_header        Host $host:$server_port;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_redirect          http:// https://;
        proxy_pass              http://192.168.3.124:8082;
        client_max_body_size       1024m;
        client_body_buffer_size    128k;
    }
}

server {
    listen 3333 ssl;
    server_name nexus.ccbjb.com.cn;

    ssl_certificate /etc/nginx/certs/nexus.crt;
    ssl_certificate_key /etc/nginx/certs/nexus.key;
    ssl_session_cache shared:SSL:50m;

    location / {
        proxy_set_header        Host $host:$server_port;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_redirect          http:// https://;
        proxy_pass              http://192.168.3.124:8083;
        client_max_body_size       1024m;
        client_body_buffer_size    128k;
    }
}


# 添加 https 配置
# vim /etc/nginx/conf.d/ssl.conf
server {
    listen   443 ssl;
    server_name  nexus.ccbjb.com.cn;

    # 允许大文件上传
    client_max_body_size 1G;

    # 对大于 1G 文件的下载进行优化
    #proxy_max_temp_file_size 2G;

    #ssl on;
    ssl_certificate      /etc/nginx/certs/nexus.crt;
    ssl_certificate_key  /etc/nginx/certs/nexus.key;

    location / {
        proxy_pass http://192.168.3.124:8081/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto "https";
    }
}

```
检查语法错误  
`nginx -t`  

启动nginx  
`systemctl start nginx`  

启动出错，查看`systemctl status nginx`
```
[root@centos124 ~]# systemctl start nginx
Job for nginx.service failed because the control process exited with error code. See "systemctl status nginx.service" and "journalctl -xe" for details.
[root@centos124 ~]# systemctl status nginx.service
● nginx.service - nginx - high performance web server
   Loaded: loaded (/usr/lib/systemd/system/nginx.service; disabled; vendor preset: disabled)
   Active: failed (Result: exit-code) since 二 2020-08-04 14:54:21 CST; 17s ago
     Docs: http://nginx.org/en/docs/
  Process: 4812 ExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.conf (code=exited, status=1/FAILURE)

8月 04 14:54:21 centos124 systemd[1]: Starting nginx - high performance web server...
8月 04 14:54:21 centos124 nginx[4812]: nginx: [emerg] bind() to 0.0.0.0:2222 failed (13: Permission denied)
8月 04 14:54:21 centos124 systemd[1]: nginx.service: control process exited, code=exited status=1
8月 04 14:54:21 centos124 systemd[1]: Failed to start nginx - high performance web server.
8月 04 14:54:21 centos124 systemd[1]: Unit nginx.service entered failed state.
8月 04 14:54:21 centos124 systemd[1]: nginx.service failed.
```

- 原因：nginx: [emerg] bind() to 0.0.0.0:2222 failed (13: Permission denied)

- 解决：
https://blog.csdn.net/RunSnail2018/article/details/81185653
这篇文章是安装semanage增加允许的tcp端口。

而我干脆关闭selinux。
```
sed -i 's/enforcing/disabled/' /etc/selinux/config
setenforce 0
```


## 测试
https://nexus.ccbjb.com.cn
```
502 Bad Gateway
```
nginx配置文件中http://127.0.0.1 修改成http://192.168.3.124


![](/docs/images/2020-08-04-15-25-47.png)