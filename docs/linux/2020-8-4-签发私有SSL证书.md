---
layout: post
title: 【私有SSL证书】签发私有SSL证书，给nginx
---

以nexus配置nginx的SSL私有证书为例。

# 签发私有证书

## 生成私钥
正式生产环境建议使用商业证书！
使用openssl工具生成一个RSA私钥

`openssl genrsa -des3 -out nexus1.key 2048`

```
Generating RSA private key, 2048 bit long modulus
.......................+++
......+++
e is 65537 (0x10001)
Enter pass phrase for nexus.key:                   # 输入一个至少4位的密码
Verifying - Enter pass phrase for nexus.key:       # 重复输入密码
复制代码删除nexus.key中的密码
# openssl rsa -in nexus.key -out nexus.key
Enter pass phrase for nexus.key:                 # 输入刚才创建时的密码
writing RSA key
```

## 去掉key的密码 

`openssl rsa -in nexus1.key -out nexus.key`


## 生成CSR（证书签名请求）
```
# openssl req -new -key nexus.key -out nexus.csr
```

```
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:cn             # 国家
State or Province Name (full name) []:Sichuan    # 地区 
Locality Name (eg, city) [Default City]:Chengdu  # 城市
Organization Name (eg, company) [Default Company Ltd]:akiya  # 组织
Organizational Unit Name (eg, section) []:akiya  # 组织单位
Common Name (eg, your name or your server's hostname) []:akiya    # 常用名可填自己名字或域名
Email Address []:a@b.com                         # 邮件地址

Please enter the following 'extra' attributes
to be sent with your certificate request      
A challenge password []:       # 可留空
An optional company name []:   # 可留空
```


## 生成自签名证书
注意：在使用自签名的临时证书时，浏览器会提示证书的颁发机构是未知的。 

```
echo subjectAltName = IP:192.168.3.120 > extfile.cnf
openssl x509 -req -days 365 -in nexus.csr -signkey nexus.key -out nexus.crt -extfile extfile.cnf
```

```
Signature ok
subject=/C=cn/ST=Sichuan/L=Chengdu/O=akiya/OU=akiya/CN=akiya/emailAddress=a@b.com
Getting Private key
```

## 存放证书
拷贝到nginx的证书目录 cp nexus.* /etc/nginx/certs/

## 配置证书到nginx
vim /etc/nginx/conf.d/nexus.conf
```
server {
    listen 2222 ssl;
    server_name nexus.ccbjb.com.cn;

    # SSL 证书
    ssl_certificate ./certs/nexus.crt;
    # SSL 私钥
    ssl_certificate_key ./certs/nexus.key;
    ssl_session_cache shared:SSL:50m;

    location / {
        proxy_set_header        Host $host:$server_port;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_redirect          http:// https://;
        proxy_pass              http://127.0.0.1:8082;
        client_max_body_size       1024m;
        client_body_buffer_size    128k;
    }
}

server {
    listen 3333 ssl;
    server_name registry.ntpstat.com;

    # SSL 证书
    ssl_certificate ./certs/nexus.crt;
    # SSL 私钥
    ssl_certificate_key ./certs/nexus.key;
    ssl_session_cache shared:SSL:50m;

    location / {
        proxy_set_header        Host $host:$server_port;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_redirect          http:// https://;
        proxy_pass              http://127.0.0.1:8083;
        client_max_body_size       1024m;
        client_body_buffer_size    128k;
    }
}
```

## 测试
https://nexus.ccbjb.com.cn
