<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>【docker】nginx反向代理harbor两节点共享NFS存储、DB，弱可用Harobor部署（后续改善） | blog</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/docs/logo.png">
    <meta name="description" content="思想persistent">
    <meta name="name" content="cjb的资料库">
    <meta name="keywords" content="java,cobol,分布式存储">
    <link rel="preload" href="/docs/assets/css/0.styles.723bd2fc.css" as="style"><link rel="preload" href="/docs/assets/js/app.f386372b.js" as="script"><link rel="preload" href="/docs/assets/js/5.a6977be1.js" as="script"><link rel="preload" href="/docs/assets/js/2.e00a8c90.js" as="script"><link rel="preload" href="/docs/assets/js/13.1425402c.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.e343b0b6.js"><link rel="prefetch" href="/docs/assets/js/11.3b74e65f.js"><link rel="prefetch" href="/docs/assets/js/12.3b2ddc4b.js"><link rel="prefetch" href="/docs/assets/js/14.defca7f4.js"><link rel="prefetch" href="/docs/assets/js/15.3d03e241.js"><link rel="prefetch" href="/docs/assets/js/16.5123ca0a.js"><link rel="prefetch" href="/docs/assets/js/17.fa5bb948.js"><link rel="prefetch" href="/docs/assets/js/18.7d95182d.js"><link rel="prefetch" href="/docs/assets/js/19.c706c1f5.js"><link rel="prefetch" href="/docs/assets/js/20.d0bf4b53.js"><link rel="prefetch" href="/docs/assets/js/21.5eb4d332.js"><link rel="prefetch" href="/docs/assets/js/22.d03be815.js"><link rel="prefetch" href="/docs/assets/js/23.33044dbb.js"><link rel="prefetch" href="/docs/assets/js/24.8740c341.js"><link rel="prefetch" href="/docs/assets/js/25.4db8bbd3.js"><link rel="prefetch" href="/docs/assets/js/26.b498f1fc.js"><link rel="prefetch" href="/docs/assets/js/27.1c3cfc23.js"><link rel="prefetch" href="/docs/assets/js/28.2415869c.js"><link rel="prefetch" href="/docs/assets/js/29.658ee863.js"><link rel="prefetch" href="/docs/assets/js/3.798339e2.js"><link rel="prefetch" href="/docs/assets/js/30.6a677974.js"><link rel="prefetch" href="/docs/assets/js/31.eb6bb87e.js"><link rel="prefetch" href="/docs/assets/js/32.a410ec2b.js"><link rel="prefetch" href="/docs/assets/js/33.fcf595f6.js"><link rel="prefetch" href="/docs/assets/js/34.71e7dc02.js"><link rel="prefetch" href="/docs/assets/js/35.994875d4.js"><link rel="prefetch" href="/docs/assets/js/36.981b8d05.js"><link rel="prefetch" href="/docs/assets/js/37.6aa62685.js"><link rel="prefetch" href="/docs/assets/js/38.9aa91437.js"><link rel="prefetch" href="/docs/assets/js/39.2e20aef9.js"><link rel="prefetch" href="/docs/assets/js/4.5835baff.js"><link rel="prefetch" href="/docs/assets/js/40.a7f04927.js"><link rel="prefetch" href="/docs/assets/js/41.ce860d67.js"><link rel="prefetch" href="/docs/assets/js/42.a266ed85.js"><link rel="prefetch" href="/docs/assets/js/43.b6e51fc8.js"><link rel="prefetch" href="/docs/assets/js/44.40513992.js"><link rel="prefetch" href="/docs/assets/js/45.d746c9b8.js"><link rel="prefetch" href="/docs/assets/js/46.c8abb7cb.js"><link rel="prefetch" href="/docs/assets/js/47.831e9b80.js"><link rel="prefetch" href="/docs/assets/js/48.cc9167fc.js"><link rel="prefetch" href="/docs/assets/js/49.71a74d6f.js"><link rel="prefetch" href="/docs/assets/js/50.720fc9a0.js"><link rel="prefetch" href="/docs/assets/js/51.8f7991a6.js"><link rel="prefetch" href="/docs/assets/js/52.2b9ee7f3.js"><link rel="prefetch" href="/docs/assets/js/53.71405838.js"><link rel="prefetch" href="/docs/assets/js/54.f437e981.js"><link rel="prefetch" href="/docs/assets/js/55.dfa7a100.js"><link rel="prefetch" href="/docs/assets/js/56.9a374196.js"><link rel="prefetch" href="/docs/assets/js/57.955ed5df.js"><link rel="prefetch" href="/docs/assets/js/58.0637d0db.js"><link rel="prefetch" href="/docs/assets/js/59.b125cbab.js"><link rel="prefetch" href="/docs/assets/js/6.6775d64b.js"><link rel="prefetch" href="/docs/assets/js/60.1677497a.js"><link rel="prefetch" href="/docs/assets/js/61.f5f9de45.js"><link rel="prefetch" href="/docs/assets/js/62.9af689fa.js"><link rel="prefetch" href="/docs/assets/js/63.951ed4ea.js"><link rel="prefetch" href="/docs/assets/js/64.d2d08635.js"><link rel="prefetch" href="/docs/assets/js/65.9f1c49f4.js"><link rel="prefetch" href="/docs/assets/js/66.bb90f0b8.js"><link rel="prefetch" href="/docs/assets/js/67.cf61fdb1.js"><link rel="prefetch" href="/docs/assets/js/68.d4659c58.js"><link rel="prefetch" href="/docs/assets/js/69.fe1295a7.js"><link rel="prefetch" href="/docs/assets/js/7.7cde2ee1.js"><link rel="prefetch" href="/docs/assets/js/70.2cd0c750.js"><link rel="prefetch" href="/docs/assets/js/71.413d16d2.js"><link rel="prefetch" href="/docs/assets/js/72.6828f7db.js"><link rel="prefetch" href="/docs/assets/js/73.4c09a4e3.js"><link rel="prefetch" href="/docs/assets/js/74.a7a73ba4.js"><link rel="prefetch" href="/docs/assets/js/75.41e08d78.js"><link rel="prefetch" href="/docs/assets/js/76.91408c9c.js"><link rel="prefetch" href="/docs/assets/js/77.3a85c802.js"><link rel="prefetch" href="/docs/assets/js/78.575838a0.js"><link rel="prefetch" href="/docs/assets/js/79.aa5e35e7.js"><link rel="prefetch" href="/docs/assets/js/8.111e690c.js"><link rel="prefetch" href="/docs/assets/js/80.e9b133d8.js"><link rel="prefetch" href="/docs/assets/js/81.71843d67.js"><link rel="prefetch" href="/docs/assets/js/82.9cf58d8e.js"><link rel="prefetch" href="/docs/assets/js/83.cf09cd50.js"><link rel="prefetch" href="/docs/assets/js/84.39422758.js"><link rel="prefetch" href="/docs/assets/js/9.871bb046.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.723bd2fc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><img src="/docs/logo.png" alt="blog" class="logo"> <span class="site-name can-hide">blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="elasticSearch" class="dropdown-title"><span class="title">elasticSearch</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/elasticSearch/" class="nav-link">
  elasticSearch
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="vuepress" class="dropdown-title"><span class="title">vuepress</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/vuepress/" class="nav-link">
  vuepress
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="webpack" class="dropdown-title"><span class="title">webpack</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/webpack/" class="nav-link">
  webpack
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="docker" class="dropdown-title"><span class="title">docker</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/docker/" class="nav-link router-link-active">
  docker
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="gitlab" class="dropdown-title"><span class="title">gitlab</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/gitlab/" class="nav-link">
  gitlab
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="vscode" class="dropdown-title"><span class="title">vscode</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/vscode/" class="nav-link">
  vscode
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="linux" class="dropdown-title"><span class="title">linux</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/linux/" class="nav-link">
  linux
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="高可用系统" class="dropdown-title"><span class="title">高可用系统</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/高可用系统/" class="nav-link">
  高可用系统
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="NFS" class="dropdown-title"><span class="title">NFS</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/NFS/" class="nav-link">
  NFS
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="git" class="dropdown-title"><span class="title">git</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/git/" class="nav-link">
  git
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="k8s" class="dropdown-title"><span class="title">k8s</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/k8s/" class="nav-link">
  k8s
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="elasticSearch" class="dropdown-title"><span class="title">elasticSearch</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/elasticSearch/" class="nav-link">
  elasticSearch
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="vuepress" class="dropdown-title"><span class="title">vuepress</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/vuepress/" class="nav-link">
  vuepress
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="webpack" class="dropdown-title"><span class="title">webpack</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/webpack/" class="nav-link">
  webpack
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="docker" class="dropdown-title"><span class="title">docker</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/docker/" class="nav-link router-link-active">
  docker
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="gitlab" class="dropdown-title"><span class="title">gitlab</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/gitlab/" class="nav-link">
  gitlab
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="vscode" class="dropdown-title"><span class="title">vscode</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/vscode/" class="nav-link">
  vscode
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="linux" class="dropdown-title"><span class="title">linux</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/linux/" class="nav-link">
  linux
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="高可用系统" class="dropdown-title"><span class="title">高可用系统</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/高可用系统/" class="nav-link">
  高可用系统
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="NFS" class="dropdown-title"><span class="title">NFS</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/NFS/" class="nav-link">
  NFS
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="git" class="dropdown-title"><span class="title">git</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/git/" class="nav-link">
  git
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="k8s" class="dropdown-title"><span class="title">k8s</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/k8s/" class="nav-link">
  k8s
</a></li></ul></div></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><p>共享存储，NFS以及DB仍旧有单点故障。Nginx也有单点故障。以后：DB可以做成集群。nginx可以做成主从。NFS换成ceph。</p> <p>感谢原作者akiya的分享。这篇文章写得已经算是不错了。至少给了一个尝试的方案。我略加整理，并解决了一下小Bug。亲测可以push。
https://juejin.im/post/5d973e246fb9a04dfa0963fb</p> <p>下面是思路：
nginx负责负载均衡，nginx提供https。
nginx后面的两个harobr使用http服务。
网页访问的时候访问最前端的nginx。
客户端需要docker的daemon.json中加入最前端nginx的domain。</p> <p><img src="/docs/images/2020-07-16-10-50-44.png" alt=""></p> <p>如果最终生产环境集群中服务器较多，依赖做完LB的Harbor也无法完全达到需求时，可以使用如下架构，部署下级Harbor节点从主节点同步镜像，然后再分发给生产服务器。
<img src="/docs/images/2020-07-16-10-51-12.png" alt=""></p> <h2 id="环境"><a href="#环境" class="header-anchor">#</a> 环境</h2> <table><thead><tr><th>IP</th> <th>用途</th> <th>安装的服务</th></tr></thead> <tbody><tr><td>192.168.3.120</td> <td>NFS服务器，Nginx服务器，Harbor存储层</td> <td>NFS、Redis、PostgressSQL、Nginx、Docker、docker-compose</td></tr> <tr><td>192.168.3.108</td> <td>Harbor无状态节点</td> <td>docker、docker-compose、harbor（http方式）</td></tr> <tr><td>192.168.3.109</td> <td>Harbor无状态节点</td> <td>docker、docker-compose、harbor（http方式）</td></tr></tbody></table> <table><thead><tr><th>软件</th> <th>版本</th></tr></thead> <tbody><tr><td>Docker</td> <td>19.06.3-ce</td></tr> <tr><td>docker-compose</td> <td>1.25.0-rc2</td></tr> <tr><td>Harbor</td> <td>1.10.0</td></tr> <tr><td>Nginx</td> <td>1.16.1</td></tr> <tr><td>PostgreSQL</td> <td>9.6.14</td></tr> <tr><td>Redis</td> <td>4.0.14</td></tr></tbody></table> <p>版本的确定，首先你下载一个Harbor，然后用下面方法确认好redis，postgress的版本。</p> <h2 id="_1-192-168-3-120-部署"><a href="#_1-192-168-3-120-部署" class="header-anchor">#</a> 1. 192.168.3.120 部署</h2> <p>上安装registry、clair、notarysigner、notaryserver、Redis、NFS、证书</p> <h3 id="怎么查看harbor用的redis版本"><a href="#怎么查看harbor用的redis版本" class="header-anchor">#</a> 怎么查看harbor用的redis版本</h3> <p><code>docker exec -it redis /bin/bash</code></p> <div class="language- extra-class"><pre class="language-text"><code>redis [ ~ ]$ redis-server --version
Redis server v=4.0.14 sha=00000000:0 malloc=jemalloc-4.0.3 bits=64 build=1e2a11bfe971a20a
</code></pre></div><h3 id="怎么查看harbor用的postgress版本"><a href="#怎么查看harbor用的postgress版本" class="header-anchor">#</a> 怎么查看harbor用的postgress版本</h3> <p><code>docker exec -it harbor-db /bin/bash</code></p> <div class="language- extra-class"><pre class="language-text"><code>postgres [ / ]$ psql
psql (9.6.14)
Type &quot;help&quot; for help.

postgres=# select version();
 PostgreSQL 9.6.14 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 6.3.0, 64-bit
(1 row)
</code></pre></div><h3 id="_1-1-签发私有证书"><a href="#_1-1-签发私有证书" class="header-anchor">#</a> 1.1 签发私有证书</h3> <h4 id="生成私钥"><a href="#生成私钥" class="header-anchor">#</a> 生成私钥</h4> <h4 id="正式生产环境建议使用商业证书！"><a href="#正式生产环境建议使用商业证书！" class="header-anchor">#</a> 正式生产环境建议使用商业证书！</h4> <h5 id="使用openssl工具生成一个rsa私钥"><a href="#使用openssl工具生成一个rsa私钥" class="header-anchor">#</a> 使用openssl工具生成一个RSA私钥</h5> <p><code># openssl genrsa -des3 -out harbor.key 2048</code></p> <div class="language- extra-class"><pre class="language-text"><code>Generating RSA private key, 2048 bit long modulus
.......................+++
......+++
e is 65537 (0x10001)
Enter pass phrase for harbor.key:                   # 输入一个至少4位的密码
Verifying - Enter pass phrase for harbor.key:       # 重复输入密码
复制代码删除harbor.key中的密码
# openssl rsa -in harbor.key -out harbor.key
Enter pass phrase for harbor.key:                 # 输入刚才创建时的密码
writing RSA key
</code></pre></div><h5 id="生成csr（证书签名请求）"><a href="#生成csr（证书签名请求）" class="header-anchor">#</a> 生成CSR（证书签名请求）</h5> <p><code># openssl req -new -key harbor.key -out harbor.csr</code></p> <div class="language- extra-class"><pre class="language-text"><code>You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:cn             # 国家
State or Province Name (full name) []:Sichuan    # 地区 
Locality Name (eg, city) [Default City]:Chengdu  # 城市
Organization Name (eg, company) [Default Company Ltd]:akiya  # 组织
Organizational Unit Name (eg, section) []:akiya  # 组织单位
Common Name (eg, your name or your server's hostname) []:akiya    # 常用名可填自己名字或域名
Email Address []:a@b.com                         # 邮件地址

Please enter the following 'extra' attributes
to be sent with your certificate request      
A challenge password []:       # 可留空
An optional company name []:   # 可留空
</code></pre></div><h5 id="生成自签名证书"><a href="#生成自签名证书" class="header-anchor">#</a> 生成自签名证书</h5> <p>注意：在使用自签名的临时证书时，浏览器会提示证书的颁发机构是未知的。
<code># echo subjectAltName = IP:192.168.3.120 &gt; extfile.cnf</code> <code># openssl x509 -req -days 365 -in harbor.csr -signkey harbor.key -out harbor.crt -extfile extfile.cnf</code></p> <div class="language- extra-class"><pre class="language-text"><code>Signature ok
subject=/C=cn/ST=Sichuan/L=Chengdu/O=akiya/OU=akiya/CN=akiya/emailAddress=a@b.com
Getting Private key
</code></pre></div><h5 id="存放证书"><a href="#存放证书" class="header-anchor">#</a> 存放证书</h5> <p>复制证书到/www/certs待用
<code># mkdir -p /www/certs &amp;&amp; cp harbor.crt harbor.key /www/certs</code></p> <h2 id="_1-2-docker"><a href="#_1-2-docker" class="header-anchor">#</a> 1.2 Docker</h2> <h5 id="官方一键脚本安装"><a href="#官方一键脚本安装" class="header-anchor">#</a> 官方一键脚本安装</h5> <p><code># curl -sSL https://get.docker.com/ | sh</code></p> <h5 id="先安装必要的依赖环境"><a href="#先安装必要的依赖环境" class="header-anchor">#</a> 先安装必要的依赖环境</h5> <p><code># yum -y install yum-utils device-mapper-persistent-data lvm2</code></p> <h5 id="添加软件源信息使用阿里云源安装"><a href="#添加软件源信息使用阿里云源安装" class="header-anchor">#</a> 添加软件源信息使用阿里云源安装</h5> <p><code># yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</code></p> <h5 id="更新缓存"><a href="#更新缓存" class="header-anchor">#</a> 更新缓存</h5> <p><code># yum makecache fast</code></p> <h5 id="安装docker或安装指定版本docker"><a href="#安装docker或安装指定版本docker" class="header-anchor">#</a> 安装Docker或安装指定版本Docker</h5> <div class="language- extra-class"><pre class="language-text"><code># yum -y install docker
# yum -y install docker-ce-18.06.3.ce-3.el7
</code></pre></div><h5 id="查看docker版本"><a href="#查看docker版本" class="header-anchor">#</a> 查看Docker版本</h5> <div class="language- extra-class"><pre class="language-text"><code># docker --version
Docker version 18.06.3-ce, build d7080c1
</code></pre></div><h5 id="修改docker仓库为国内镜像站"><a href="#修改docker仓库为国内镜像站" class="header-anchor">#</a> 修改Docker仓库为国内镜像站</h5> <div class="language- extra-class"><pre class="language-text"><code># curl -sSL https://get.daocloud.io/daotools/set_mirror.sh | sh -s http://f1361db2.m.daocloud.io
</code></pre></div><h5 id="启动docker服务并添加至开机自启"><a href="#启动docker服务并添加至开机自启" class="header-anchor">#</a> 启动Docker服务并添加至开机自启</h5> <div class="language- extra-class"><pre class="language-text"><code># systemctl start docker
# systemctl enable docker
</code></pre></div><h2 id="_1-3-compose"><a href="#_1-3-compose" class="header-anchor">#</a> 1.3 Compose</h2> <p>compose是Docker提供的一个命令行工具，用来定义和运行由多个容器组成的应用。使用compose，我们可以通过YAML文件声明式的定义应用程序的各个服务，并由单个命令完成应用的创建和启动。
由于国内政策原因，可能在海外网站上下载文件速度较慢，建议下载本地后上传至服务器</p> <h5 id="下载docker-compose并赋予可执行权限"><a href="#下载docker-compose并赋予可执行权限" class="header-anchor">#</a> 下载docker-compose并赋予可执行权限</h5> <div class="language- extra-class"><pre class="language-text"><code># curl -L https://github.com/docker/compose/releases/download/1.25.0-rc2/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose

# chmod +x /usr/local/bin/docker-compose

//查看compose本地版本
# docker-compose -v

docker-compose version 1.25.0-rc2, build 661ac20e
</code></pre></div><h2 id="_1-4-四个服务的安装"><a href="#_1-4-四个服务的安装" class="header-anchor">#</a> 1.4 四个服务的安装</h2> <p>由于Harbor v1.9.0使用的是PostgreSQL，我们也同样独立部署一套PostgreSQL与Redis，此次演示使用Docker部署，实际生产环境按需要选择是否部署至宿主机。</p> <h5 id="postgresql"><a href="#postgresql" class="header-anchor">#</a> PostgreSQL</h5> <p>通过查看已安装的Harbor v1.9.0单机版中运行的harbor-db容器可得知此次运行的PostgreSQL版本为9.6.14</p> <div class="language- extra-class"><pre class="language-text"><code># docker exec -it harbor-db /bin/bash
postgres [ / ]$ psql
psql (9.6.14)
Type &quot;help&quot; for help.

postgres=# select version();
                                    version
-------------------------------------------------------------------------------
 PostgreSQL 9.6.14 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 6.3.0, 64-bit
(1 row)
</code></pre></div><h5 id="redis"><a href="#redis" class="header-anchor">#</a> Redis</h5> <p>根据官方文档描述，使用Redis需要4.0.10-1.ph2版本。同样，此次我们为了演示也使用docker-compose来部署。</p> <h5 id="yaml脚本"><a href="#yaml脚本" class="header-anchor">#</a> yaml脚本</h5> <p>那么我们使用同一版本的PostgreSQL与Redis，编写docker-compose.yml 内容如下：</p> <div class="language- extra-class"><pre class="language-text"><code># author:akiya
version: &quot;3&quot;

networks:
  harbor:
    driver: bridge

services:
  registry:
    image: postgres:9.6.14
    container_name: harbor-registry
    restart: always
    environment:
      POSTGRES_DB: registry
      POSTGRES_PASSWORD: root123
    volumes:
      - $PWD/postgres/registry:/var/lib/postgresql/data
    networks:
      - harbor
    ports:
      - 20010:5432
  clair:
    image: postgres:9.6.14
    container_name: harbor-clair
    restart: always
    environment:
      POSTGRES_DB: clair
      POSTGRES_PASSWORD: root123
    volumes:
      - $PWD/postgres/clair:/var/lib/postgresql/data
    networks:
      - harbor
    ports:
      - 20011:5432
  notarysigner:
    image: postgres:9.6.14
    container_name: harbor-notarysigner
    restart: always
    environment:
      POSTGRES_DB: notarysigner
      POSTGRES_PASSWORD: root123
    volumes:
      - $PWD/postgres/notarysigner:/var/lib/postgresql/data
    networks:
      - harbor
    ports:
      - 20012:5432
  notaryserver:
    image: postgres:9.6.14
    container_name: harbor-notaryserver
    restart: always
    environment:
      POSTGRES_DB: notaryserver
      POSTGRES_PASSWORD: root123
    volumes:
      - $PWD/postgres/notaryserver:/var/lib/postgresql/data
    networks:
      - harbor
    ports:
      - 20013:5432
  Redis:
    image: redis:4.0.10
    container_name: harbor-redis
    command: redis-server /usr/local/etc/redis/redis.conf
    restart: always
    volumes:
      - $PWD/redis/data:/data
      - $PWD/redis/redis.conf:/usr/local/etc/redis/redis.conf
    networks:
      - harbor
    ports:
      - 20000:6379
</code></pre></div><p>保存后我们用<code>docker-compose up -d</code>命令启动相应的容器.
并在防火墙中开放对应的端口</p> <div class="language- extra-class"><pre class="language-text"><code># docker-compose up -d
# firewall-cmd --zone=public --permanent --add-port=20000/tcp
# firewall-cmd --zone=public --permanent --add-port=20010/tcp
# firewall-cmd --zone=public --permanent --add-port=20011/tcp
# firewall-cmd --zone=public --permanent --add-port=20012/tcp
# firewall-cmd --zone=public --permanent --add-port=20013/tcp
# firewall-cmd --reload
</code></pre></div><blockquote><p>我一般推荐关闭防火墙。在内网里面开启防火墙没有任何意义。</p></blockquote> <h2 id="_1-5-nfs"><a href="#_1-5-nfs" class="header-anchor">#</a> 1.5 NFS</h2> <h3 id="_1-5-1-服务端-192-168-3-120"><a href="#_1-5-1-服务端-192-168-3-120" class="header-anchor">#</a> 1.5.1 服务端 192.168.3.120</h3> <h5 id="创建nfs共享文件路径"><a href="#创建nfs共享文件路径" class="header-anchor">#</a> 创建NFS共享文件路径</h5> <p><code># mkdir -p /data/nfs</code></p> <h5 id="安装nfs（在安装完nfs-utils后，rpcbind默认是启动了的）"><a href="#安装nfs（在安装完nfs-utils后，rpcbind默认是启动了的）" class="header-anchor">#</a> 安装NFS（在安装完nfs-utils后，rpcbind默认是启动了的）</h5> <p><code># yum -y install nfs-utils rpcbind</code></p> <h5 id="启动nfs相关服务并设置开机启动"><a href="#启动nfs相关服务并设置开机启动" class="header-anchor">#</a> 启动NFS相关服务并设置开机启动</h5> <div class="language- extra-class"><pre class="language-text"><code># systemctl start rpcbind
# systemctl enable rpcbind
# systemctl start nfs-server
# systemctl enable nfs-server
# systemctl start nfs-lock
# systemctl enable nfs-lock
# systemctl start nfs-idmap
# systemctl enable nfs-idmap
</code></pre></div><h5 id="使用如下命令像-etc-exports中添加配置"><a href="#使用如下命令像-etc-exports中添加配置" class="header-anchor">#</a> 使用如下命令像/etc/exports中添加配置</h5> <div class="language- extra-class"><pre class="language-text"><code># echo '/data     192.168.3.0/24(rw,sync,no_root_squash,no_all_squash)' &gt;&gt; /etc/exports
# exportfs -a      # 使exports的修改生效
</code></pre></div><h5 id="检查nfs共享目录是否正确"><a href="#检查nfs共享目录是否正确" class="header-anchor">#</a> 检查NFS共享目录是否正确</h5> <div class="language- extra-class"><pre class="language-text"><code># showmount -e localhost
Export list for localhost:
/data 192.168.3.0/24
</code></pre></div><h5 id="放行防火墙相应服务"><a href="#放行防火墙相应服务" class="header-anchor">#</a> 放行防火墙相应服务</h5> <div class="language- extra-class"><pre class="language-text"><code># firewall-cmd --add-service=nfs --permanent --zone=public
# firewall-cmd --add-service=mountd --permanent --zone=public
# firewall-cmd --add-service=rpc-bind --permanent --zone=public
# firewall-cmd --reload
</code></pre></div><h3 id="_1-5-2-客户端-192-168-3-108，192-168-3-109"><a href="#_1-5-2-客户端-192-168-3-108，192-168-3-109" class="header-anchor">#</a> 1.5.2 客户端 192.168.3.108，192.168.3.109</h3> <h5 id="创建nfs挂载文件路径"><a href="#创建nfs挂载文件路径" class="header-anchor">#</a> 创建NFS挂载文件路径</h5> <p><code># mkdir /data</code></p> <h5 id="安装nfs"><a href="#安装nfs" class="header-anchor">#</a> 安装NFS</h5> <p><code># yum -y install nfs-utils</code></p> <h5 id="检查nfs远程共享目录是否存在"><a href="#检查nfs远程共享目录是否存在" class="header-anchor">#</a> 检查NFS远程共享目录是否存在</h5> <div class="language- extra-class"><pre class="language-text"><code># showmount -e 192.168.3.120
Export list for 192.168.3.120:
/data 192.168.3.0/24
</code></pre></div><h5 id="挂载远程nfs共享文件路径"><a href="#挂载远程nfs共享文件路径" class="header-anchor">#</a> 挂载远程NFS共享文件路径</h5> <p><code># mount -t nfs 192.168.3.120:/data /data</code></p> <h5 id="添加到系统开机自动挂载"><a href="#添加到系统开机自动挂载" class="header-anchor">#</a> 添加到系统开机自动挂载</h5> <p><code># echo '192.168.3.120:/data /data nfs defaults 0 0' &gt;&gt; /etc/fstab</code></p> <h5 id="测试"><a href="#测试" class="header-anchor">#</a> 测试</h5> <div class="language- extra-class"><pre class="language-text"><code>在客户端上挂载完NFS后创建一个测试文件
# touch /data/test
然后切换到服务器查看是否存在
# ls /data/nfs/
test
</code></pre></div><h2 id="_1-6-nginx"><a href="#_1-6-nginx" class="header-anchor">#</a> 1.6 Nginx</h2> <h3 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h3> <h5 id="添加nginx源"><a href="#添加nginx源" class="header-anchor">#</a> 添加Nginx源</h5> <div class="language- extra-class"><pre class="language-text"><code># rpm -ivh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm
</code></pre></div><h5 id="yum安装nginx"><a href="#yum安装nginx" class="header-anchor">#</a> yum安装Nginx</h5> <p><code># yum -y install nginx</code></p> <h5 id="启动nginx"><a href="#启动nginx" class="header-anchor">#</a> 启动Nginx</h5> <div class="language- extra-class"><pre class="language-text"><code># systemctl start nginx
# systemctl enable nginx
</code></pre></div><h5 id="编写配置"><a href="#编写配置" class="header-anchor">#</a> 编写配置</h5> <p>创建<code>/etc/nginx/conf.d/harbor.conf</code>文件，并写入如下内容</p> <div class="language-json extra-class"><pre class="language-json"><code>upstream harbor <span class="token punctuation">{</span>
    ip_hash;
    server <span class="token number">192.168</span>.<span class="token number">3.108</span><span class="token operator">:</span><span class="token number">80</span>;
    server <span class="token number">192.168</span>.<span class="token number">3.109</span><span class="token operator">:</span><span class="token number">80</span>;
<span class="token punctuation">}</span>
server <span class="token punctuation">{</span>
   listen       <span class="token number">80</span>;
   # 提供访问的域名或者IP
   server_name  harbor.ccbjb.com.cn;
   return      <span class="token number">308</span> https<span class="token operator">:</span><span class="token comment">//$host$request_uri;</span>
<span class="token punctuation">}</span>
server <span class="token punctuation">{</span>
    listen  <span class="token number">443</span> ssl;
    server_name harbor.ccbjb.com.cn;
    
    # SSL 证书
    ssl_certificate ./certs/harbor.crt;
    # SSL 私钥
    ssl_certificate_key ./certs/harbor.key;
    client_max_body_size <span class="token number">0</span>;
    chunked_transfer_encoding on;

    location / <span class="token punctuation">{</span>
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto https;
        proxy_redirect off;
        proxy_ssl_verify off;
        proxy_ssl_session_reuse on;
        proxy_pass http<span class="token operator">:</span><span class="token comment">//harbor;</span>
        proxy_http_version <span class="token number">1.1</span>;
    <span class="token punctuation">}</span>
    location /v<span class="token number">2</span>/ <span class="token punctuation">{</span>
        proxy_pass http<span class="token operator">:</span><span class="token comment">//harbor/v2/;</span>
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_ssl_verify off;
        proxy_ssl_session_reuse on;
        proxy_buffering off;
        proxy_request_buffering off;
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="启动nginx-2"><a href="#启动nginx-2" class="header-anchor">#</a> 启动Nginx</h4> <h5 id="验证nginx配置正确性"><a href="#验证nginx配置正确性" class="header-anchor">#</a> 验证Nginx配置正确性</h5> <p><code># nginx -t</code></p> <h5 id="平滑重启nginx"><a href="#平滑重启nginx" class="header-anchor">#</a> 平滑重启Nginx</h5> <p><code># nginx -s reload</code></p> <h5 id="开放防火墙80-443端口"><a href="#开放防火墙80-443端口" class="header-anchor">#</a> 开放防火墙80/443端口</h5> <div class="language- extra-class"><pre class="language-text"><code># firewall-cmd --zone=public --permanent --add-port=80/tcp
# firewall-cmd --zone=public --permanent --add-port=443/tcp
# firewall-cmd --reload
</code></pre></div><h3 id="问题处理"><a href="#问题处理" class="header-anchor">#</a> 问题处理</h3> <p>Nginx</p> <h5 id="问题：使用自签证书时报错"><a href="#问题：使用自签证书时报错" class="header-anchor">#</a> 问题：使用自签证书时报错</h5> <div class="language- extra-class"><pre class="language-text"><code>emerg] 31815#31815: cannot load certificate &quot;/www/certs/harbor.crt&quot;: BIO_new_file() failed (SSL: error:0200100D:system library:fopen:Permission denied:fopen('/www/certs/harbor.crt','r') error:2006D002:BIO routines:BIO_new_file:system lib)
</code></pre></div><h5 id="解决方法：创建-etc-nginx-certs路径，并复制证书到此路径"><a href="#解决方法：创建-etc-nginx-certs路径，并复制证书到此路径" class="header-anchor">#</a> 解决方法：创建/etc/nginx/certs路径，并复制证书到此路径</h5> <div class="language- extra-class"><pre class="language-text"><code>mkdir -p /etc/nginx/certs &amp;&amp; cp /www/certs/ ./certs
// 修改harbor.conf中证书相关路径
# 刚才我们自己签发的证书
ssl_certificate ./certs/harbor.crt;
# 证书对应的私钥
ssl_certificate_key ./certs/harbor.key;
</code></pre></div><h2 id="_2-两台harbor节点安装harbor"><a href="#_2-两台harbor节点安装harbor" class="header-anchor">#</a> 2. 两台Harbor节点安装Harbor</h2> <h3 id="_2-1-修改配置文件"><a href="#_2-1-修改配置文件" class="header-anchor">#</a> 2.1 修改配置文件</h3> <h4 id="修改harbor-yml配置文件"><a href="#修改harbor-yml配置文件" class="header-anchor">#</a> 修改harbor.yml配置文件</h4> <p><code># vim harbor.yml</code></p> <p>主要配置参数如下，由于我们这里使用外置PostgreSQL与Redis所以直接注释掉database相关配置改用external_database与external_redis</p> <p>以192.168.3.108为例，192.168.3.109只需要修改hostname</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># 修改为当前服务器内网IP地址即可</span>
<span class="token key atrule">hostname</span><span class="token punctuation">:</span> 192.168.3.108 <span class="token comment"># 另一台修改为192.168.3.109</span>
<span class="token comment"># HTTP相关配置</span>
<span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token comment"># HTTPS相关配置，这里由于我们会在前端加一个Nginx</span>
<span class="token comment"># 所以我们直接使用HTTP，而在Nginx上做SSL</span>
<span class="token comment">#https:</span>
<span class="token comment">#  # HTTPS端口</span>
<span class="token comment">#  port: 443</span>
<span class="token comment">#  # TLS证书</span>
<span class="token comment">#  certificate: /www/certs/harbor.crt</span>
<span class="token comment">#  # TLS私钥</span>
<span class="token comment">#  private_key: /www/certs/harbor.key</span>
<span class="token comment"># 默认管理员密码</span>
<span class="token key atrule">harbor_admin_password</span><span class="token punctuation">:</span> Harbor12345
<span class="token comment"># Harbor DB配置，由于使用外部数据库，所以这里我们注释掉</span>
<span class="token comment"># database:</span>
<span class="token comment">#   password: root123</span>
<span class="token comment">#   max_idle_conns: 50</span>
<span class="token comment">#   max_open_conns: 100</span>
<span class="token punctuation">...</span>
<span class="token comment"># 外部PostgreSQL，由于Harbor使用了4个数据库，这里我们也需要对相应数据库地址进行配置</span>
<span class="token key atrule">external_database</span><span class="token punctuation">:</span>
  <span class="token key atrule">harbor</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.3.120
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">20010</span>
    <span class="token key atrule">db_name</span><span class="token punctuation">:</span> registry
    <span class="token key atrule">username</span><span class="token punctuation">:</span> postgres
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root123
    <span class="token key atrule">ssl_mode</span><span class="token punctuation">:</span> disable
    <span class="token key atrule">max_idle_conns</span><span class="token punctuation">:</span> <span class="token number">2</span>
    <span class="token key atrule">max_open_conns</span><span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token key atrule">clair</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.3.120
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">20011</span>
    <span class="token key atrule">db_name</span><span class="token punctuation">:</span> clair
    <span class="token key atrule">username</span><span class="token punctuation">:</span> postgres
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root123
    <span class="token key atrule">ssl_mode</span><span class="token punctuation">:</span> disable
  <span class="token key atrule">notary_signer</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.3.120
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">20012</span>
    <span class="token key atrule">db_name</span><span class="token punctuation">:</span> notarysigner
    <span class="token key atrule">username</span><span class="token punctuation">:</span> postgres
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root123
    <span class="token key atrule">ssl_mode</span><span class="token punctuation">:</span> disable
  <span class="token key atrule">notary_server</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.3.120
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">20013</span>
    <span class="token key atrule">db_name</span><span class="token punctuation">:</span> notaryserver
    <span class="token key atrule">username</span><span class="token punctuation">:</span> postgres
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root123
    <span class="token key atrule">ssl_mode</span><span class="token punctuation">:</span> disable
<span class="token comment"># 使用外部Redis，取消相应注释即可</span>
<span class="token key atrule">external_redis</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.3.120
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">20000</span>
  <span class="token key atrule">password</span><span class="token punctuation">:</span>
  <span class="token key atrule">registry_db_index</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">jobservice_db_index</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">chartmuseum_db_index</span><span class="token punctuation">:</span> <span class="token number">3</span>
</code></pre></div><h3 id="_2-2-安装harbor"><a href="#_2-2-安装harbor" class="header-anchor">#</a> 2.2 安装Harbor</h3> <h5 id="生成harbor运行的必要文件（环境）以及docker-compose-yml文件；"><a href="#生成harbor运行的必要文件（环境）以及docker-compose-yml文件；" class="header-anchor">#</a> 生成harbor运行的必要文件（环境）以及docker-compose.yml文件；</h5> <p>执行后会通过网络获取Docker Image，建议提前修改好国内镜像站加速。
<code># ./prepare</code></p> <p><code># ./install.sh</code></p> <h5 id="开放harbor端口"><a href="#开放harbor端口" class="header-anchor">#</a> 开放Harbor端口</h5> <div class="language- extra-class"><pre class="language-text"><code># firewall-cmd --zone=public --permanent --add-port=80/tcp
# firewall-cmd --reload
</code></pre></div><blockquote><p>推荐关闭防火墙，就不需要这步了</p></blockquote> <h4 id="以上就是原文的全部了。这里有一处漏记。"><a href="#以上就是原文的全部了。这里有一处漏记。" class="header-anchor">#</a> 以上就是原文的全部了。这里有一处漏记。</h4> <p>如果不处理，会有push镜像失败的问题。</p> <h3 id="_2-3-修改harbor的nginx配置"><a href="#_2-3-修改harbor的nginx配置" class="header-anchor">#</a> 2.3 修改harbor的nginx配置</h3> <h6 id="参考："><a href="#参考：" class="header-anchor">#</a> 参考：</h6> <p>https://goharbor.io/docs/2.0.0/install-config/troubleshoot-installation/</p> <blockquote><p>使用nginx或负载平衡
如果Harbor在nginx代理或弹性负载平衡之后运行，请打开文件common/config/nginx/nginx.conf并搜索以下行。
proxy_set_header X-Forwarded-Proto $scheme;
如果代理已经有类似的设置，从部分删除
location /，
location /v2/
location /service/
和重新部署港湾。有关如何重新部署Harbor的说明，请参阅 重新配置Harbor和管理Harbor生命周期。</p></blockquote> <h5 id="首先，修改两个nginx节点的nginx配置文件"><a href="#首先，修改两个nginx节点的nginx配置文件" class="header-anchor">#</a> 首先，修改两个nginx节点的nginx配置文件</h5> <p>harbor安装目录（harbor.xml同级目录）<code>/root/harbor</code>，修改nginx的配置文件
<code>/root/harbor/common/config/nginx/nginx.conf</code> 三处，注意只改三处。
否则，push的时候会一直retring！！！！！！！！
<font color="red">该配置文件的注释会有误导，导致你都注释掉，就怎么也push不成功,  注意只改三处!</font></p> <div class="language- extra-class"><pre class="language-text"><code> location / {
      proxy_pass http://portal/;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      # When setting up Harbor behind other proxy, such as an Nginx instance, remove the below line if the proxy already has similar settings.
      # proxy_set_header X-Forwarded-Proto $scheme;

      proxy_buffering off;
      proxy_request_buffering off;
    }
location /v2/ {
      proxy_pass http://core/v2/;
      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      # When setting up Harbor behind other proxy, such as an Nginx instance, remove the below line if the proxy already has similar settings.
      # proxy_set_header X-Forwarded-Proto $scheme;
      proxy_buffering off;
      proxy_request_buffering off;

      proxy_send_timeout 900;
      proxy_read_timeout 900;
    }
 location /service/ {
      proxy_pass http://core/service/;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      # When setting up Harbor behind other proxy, such as an Nginx instance, remove the below line if the proxy already has similar settings.
      # proxy_set_header X-Forwarded-Proto $scheme;

      proxy_buffering off;
      proxy_request_buffering off;
    }
</code></pre></div><h5 id="然后，重启harbor服务"><a href="#然后，重启harbor服务" class="header-anchor">#</a> 然后，重启harbor服务</h5> <div class="language- extra-class"><pre class="language-text"><code>docker-compose down
docker-compose up -d
</code></pre></div><h2 id="_3-dockers客户端测试push"><a href="#_3-dockers客户端测试push" class="header-anchor">#</a> 3. dockers客户端测试push</h2> <h5 id="_192-168-3-107-上测试push"><a href="#_192-168-3-107-上测试push" class="header-anchor">#</a> 192.168.3.107 上测试push</h5> <h6 id="客户端上修改docker配置文件"><a href="#客户端上修改docker配置文件" class="header-anchor">#</a> 客户端上修改docker配置文件</h6> <div class="language- extra-class"><pre class="language-text"><code># vi /etc/docker/daemon.json
{
 &quot;insecure-registries&quot;: [&quot;harbor.ccbjb.com.cn&quot;]
}

// 修改/etc/docker/daemon.json完成后reload配置文件
# sudo systemctl daemon-reload

// 重启docker服务
# sudo systemctl restart docker.service

</code></pre></div><p>不修改login不进去，push不让</p> <div class="language- extra-class"><pre class="language-text"><code># docker login -u admin harbor.ccbjb.com.cn
password:
输入harbor.xml里Harbor12345（当然我已经改成别的了，输入你自己的密码）
Login Succeeded

# docker tag node harbor.ccbjb.com.cn/library/vue/js

# docker push harbor.ccbjb.com.cn/library/vue/js
The push refers to a repository [harbor.ccbjb.com.cn/library/vuejs/ci]
3cb56e88501e: Pushed
5fe5f08a709e: Pushed
99ad6967cf69: Pushed
2aa1c54ebc66: Pushed
89cb25530034: Pushed
c4b55423085b: Pushed
b5e9932b9936: Pushed
d5644f4d8741: Pushed
4a03ae8d3bee: Pushed
a9286fedbd63: Pushed
d50e7be1e737: Pushed
6b114a2dd6de: Pushed
bb9315db9240: Pushed
latest: digest: sha256:3b766dda613fcd2dce50e4e2ba6ef9ae0e322a52ca1fff6d9e466a06e2a8a0e6 size: 3063
</code></pre></div><h5 id="同一个网段192-168-3-随便哪台机器"><a href="#同一个网段192-168-3-随便哪台机器" class="header-anchor">#</a> 同一个网段192.168.3.*随便哪台机器</h5> <p>https://harbor.ccbjb.com.cn/
admin
Harbor12345
都能够看到已经上传的镜像文件。</p> <hr> <h1 id="以下：一次失败的把-harbor安装在samba挂载上的经历（不要尝试）"><a href="#以下：一次失败的把-harbor安装在samba挂载上的经历（不要尝试）" class="header-anchor">#</a> 以下：一次失败的把 Harbor安装在samba挂载上的经历（不要尝试）</h1> <p>修改docker卷位置
首先把公司分给我的raid盘挂载过来。
然后把harbor默认的dockers卷修改在这块磁盘上。这样至少存储上提高了点安全性。</p> <h2 id="_1，作为samba的客户端挂载服务端的磁盘"><a href="#_1，作为samba的客户端挂载服务端的磁盘" class="header-anchor">#</a> 1，作为samba的客户端挂载服务端的磁盘</h2> <p><a href="https://githubshirongxin.github.io/Smba%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E7%A3%81%E7%9B%98/" target="_blank" rel="noopener noreferrer">samba实现分布式磁盘<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>已经挂完 /data_cjb/</p> <ul><li>确认一下挂载情况：</li></ul> <div class="language- extra-class"><pre class="language-text"><code>mount | grep data_cjb
或者
df -hT | grep data_cjb
或者
cat /etc/fstab
</code></pre></div><h2 id="_2，修改harbor-docker-compose-yml-harbor-yml"><a href="#_2，修改harbor-docker-compose-yml-harbor-yml" class="header-anchor">#</a> 2，修改harbor/docker-compose.yml , harbor.yml</h2> <h3 id="harbor-yml"><a href="#harbor-yml" class="header-anchor">#</a> harbor.yml</h3> <div class="language- extra-class"><pre class="language-text"><code> # Log configurations
   location: /var/log/harbor # 不改了，这块丢就丢了。
 # The default data volume
 #  data_volume: /data #这得改成mount好的raid盘目录
 data_volume: /data_cjb/harbordata
</code></pre></div><h3 id="docker-compose-yml"><a href="#docker-compose-yml" class="header-anchor">#</a> docker-compose.yml</h3> <p>所有/data/ 都改成/data_cjb/harbordata/</p> <h2 id="_3，执行-install-sh"><a href="#_3，执行-install-sh" class="header-anchor">#</a> 3，执行<code>./install.sh</code></h2> <p>最后/root/harbor/prepare 执行的时候报错。
说容器内没有/data/secret/cert/目录没有permission denied</p> <h2 id="结论：samba共享目录上无法安装harbor"><a href="#结论：samba共享目录上无法安装harbor" class="header-anchor">#</a> 结论：samba共享目录上无法安装harbor</h2> <p>另外，我在nfs上共享目录上就能安装harbor。</p> <hr></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">7/31/2020, 2:52:42 PM</span></div></footer> <!---->  <Vssue options="[object Object]" class="theme-default-content content__default"></Vssue></main></div><div class="global-ui"></div></div>
    <script src="/docs/assets/js/app.f386372b.js" defer></script><script src="/docs/assets/js/5.a6977be1.js" defer></script><script src="/docs/assets/js/2.e00a8c90.js" defer></script><script src="/docs/assets/js/13.1425402c.js" defer></script>
  </body>
</html>
