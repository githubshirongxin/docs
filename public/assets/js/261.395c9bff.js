(window.webpackJsonp=window.webpackJsonp||[]).push([[261],{742:function(s,n,e){"use strict";e.r(n);var a=e(59),r=Object(a.a)({},(function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"docker-容器日志占用空间过大解决办法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#docker-容器日志占用空间过大解决办法"}},[s._v("#")]),s._v(" Docker 容器日志占用空间过大解决办法")]),s._v(" "),e("ol",[e("li",[e("p",[s._v("问题"),e("br"),s._v("\ndocker容器日志导致主机磁盘空间满了。docker logs -f container_name噼里啪啦一大堆，很占用空间，不用的日志可以清理掉了。")])]),s._v(" "),e("li",[e("p",[s._v("解决方法"),e("br"),s._v("\n2.1 找出Docker容器日志"),e("br"),s._v("\n在linux上，容器日志一般存放在/var/lib/docker/containers/container_id/下面，查看各个日志文件大小的脚本docker_log_size.sh，内容如下：")])])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('#!/bin/sh \necho "======== docker containers logs file size ========"  \n\nlogs=$(find /var/lib/docker/containers/ -name *-json.log)  \n\nfor log in $logs  \n        do  \n             ls -lh $log   \n        done\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# chmod +x docker_log_size.sh\n\n# ./docker_log_size.sh\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("2.2 清理Docker容器日志（治标）"),e("br"),s._v("\n如果docker容器正在运行，那么使用rm -rf方式删除日志后，通过df -h会发现磁盘空间并没有释放。原因是在Linux或者Unix系统中，通过rm -rf或者文件管理器删除文件，将会从文件系统的目录结构上解除链接（unlink）。如果文件是被打开的（有一个进程正在使用），那么进程将仍然可以读取该文件，磁盘空间也一直被占用。正确姿势是cat /dev/null > *-json.log，当然你也可以通过rm -rf删除后重启docker。接下来，提供一个日志清理脚本clean_docker_log.sh，内容如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('#!/bin/sh \necho "======== start clean docker containers logs ========"  \n\nlogs=$(find /var/lib/docker/containers/ -name *-json.log)  \n\nfor log in $logs  \n        do  \n                echo "clean logs : $log"  \n                cat /dev/null > $log  \n        done  \n\necho "======== end clean docker containers logs ========"\n\n# chmod +x clean_docker_log.sh\n\n# ./clean_docker_log.sh\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br")])]),e("p",[s._v("但是，这样清理之后，随着时间的推移，容器日志会像杂草一样，卷土重来。")]),s._v(" "),e("p",[s._v("2.3 设置Docker容器日志大小（治本）"),e("br"),s._v("\n设置一个容器服务的日志大小上限"),e("br"),s._v("\n上述方法，日志文件迟早又会涨回来。要从根本上解决问题，需要限制容器服务的日志大小上限。这个通过配置容器docker-compose的max-size选项来实现")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("nginx: \n  image: nginx:1.12.1 \n  restart: always \n  logging: \n    driver: “json-file” \n    options: \n      max-size: “5g” \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("重启nginx容器之后，其日志文件的大小就被限制在5GB，再也不用担心了。")]),s._v(" "),e("p",[s._v("全局设置"),e("br"),s._v("\n新建/etc/docker/daemon.json，若有就不用新建了。添加log-dirver和log-opts参数，样例如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('# vim /etc/docker/daemon.json\n\n{\n  "log-driver":"json-file",\n  "log-opts": {"max-size":"500m", "max-file":"3"}\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("max-size=500m，意味着一个容器日志大小上限是500M，"),e("br"),s._v("\nmax-file=3，意味着一个容器有三个日志，分别是id+.json、id+1.json、id+2.json。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("// 重启docker守护进程\n\n# systemctl daemon-reload\n\n# systemctl restart docker\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("注意：设置的日志大小，只对新建的容器有效。")])])}),[],!1,null,null,null);n.default=r.exports}}]);