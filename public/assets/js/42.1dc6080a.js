(window.webpackJsonp=window.webpackJsonp||[]).push([[42],{518:function(t,a,e){"use strict";e.r(a);var s=e(55),r=Object(s.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h2",{attrs:{id:"harbor安装"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#harbor安装"}},[t._v("#")]),t._v(" harbor安装")]),t._v(" "),e("p",[t._v("略，参考前两篇文章。\n"),e("a",{attrs:{href:"https://githubshirongxin.github.io/DockerHarborInstall/",target:"_blank",rel:"noopener noreferrer"}},[t._v("【docker】harbor 单机https安装（成功安装）"),e("OutboundLink")],1),t._v(" "),e("a",{attrs:{href:"https://githubshirongxin.github.io/DockerHarborInstall2/",target:"_blank",rel:"noopener noreferrer"}},[t._v("【docker】nginx反向代理harbor两节点共享NFS存储、DB，弱可用Harobor部署（后续改善）"),e("OutboundLink")],1)]),t._v(" "),e("h2",{attrs:{id:"修改harbor以及k8s各个节点的daemon-json"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#修改harbor以及k8s各个节点的daemon-json"}},[t._v("#")]),t._v(" 修改harbor以及k8s各个节点的daemon.json")]),t._v(" "),e("p",[t._v("都加上一句话")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("vi")]),t._v(" /etc/docker/daemon.json\n"),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"insecure-registries"')]),t._v(":"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://harbor.ccbjb.com.cn"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),e("p",[t._v("这url是你的harbor的域名。\n我这个域名已经加入到公司的域名服务器里了，所以不用修改每天机器的hosts。")]),t._v(" "),e("p",[t._v("因为是自签证书，所以每个客户端dockers配置文件都需要加入此配置\n强制承认该URL是安全的。")]),t._v(" "),e("p",[e("font",{attrs:{color:"red"}},[t._v("注意，前面如果有内容，别忘了在上一行后面加逗号！，否则docker启动失败")])],1),t._v(" "),e("h2",{attrs:{id:"然后重新启动docker"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#然后重新启动docker"}},[t._v("#")]),t._v(" 然后重新启动docker")]),t._v(" "),e("p",[e("code",[t._v("systemctl daemon-reload && systemctl restart docker.service")])]),t._v(" "),e("h2",{attrs:{id:"验证docker-push-到harbor-ok吗？"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#验证docker-push-到harbor-ok吗？"}},[t._v("#")]),t._v(" 验证docker push 到Harbor ok吗？")]),t._v(" "),e("p",[t._v("k8s的各个节点用docker命令能否push镜像到harbor\n然后在harbor网页上看镜像是否已经传上来了。\n具体参考，前面的文章。")]),t._v(" "),e("h2",{attrs:{id:"测试k8s与harbor连接"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#测试k8s与harbor连接"}},[t._v("#")]),t._v(" 测试k8s与harbor连接")]),t._v(" "),e("p",[t._v("k8s从harbor得到镜像并运行pod（减轻了外网压力、方便了共享。）")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("kubectl --help\nkubectl run nginx-deployment --image=harbor.ccbjb.com.cn/library/myapp:v1 -port=80 --replicas=1 \nkubectl get deployment\nkubectl get rs\nkubectl get pod\nkubectl get pod -o wide\ncurl 上一个命令的私有IP\ncurl 私有IP/hostname.html //获取pod容器的hostname\n\n到运行节点\ndocker ps -a \n")])])]),e("p",[t._v("到harbor上，看该镜像的下载次数+=1")]),t._v(" "),e("h2",{attrs:{id:"方便容灾和扩容"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方便容灾和扩容"}},[t._v("#")]),t._v(" 方便容灾和扩容")]),t._v(" "),e("h3",{attrs:{id:"容灾测试"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#容灾测试"}},[t._v("#")]),t._v(" 容灾测试")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("kubectl delete pod 刚刚的get pod获得的pod "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v("\nkubectl get pod //会发现又生成了一个pod，并且id不同\n")])])]),e("h3",{attrs:{id:"扩容测试"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#扩容测试"}},[t._v("#")]),t._v(" 扩容测试")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("kubectl get deployment //获得deployment name\nkubectl scale --replicas"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" deployment/deployment的name\nkubectl get pod //能看到3个pod\nkubectl get pod -o wide //能看到3个pod运行在不同的节点上\n")])])]),e("h3",{attrs:{id:"再验证容灾"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#再验证容灾"}},[t._v("#")]),t._v(" 再验证容灾")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('kubectl get pod\nkubectl delete pod "刚刚的get pod获得的pod id"\nkubectl get pod //还是三个pod，会发现又生成了一个pod, id不同\n')])])]),e("h3",{attrs:{id:"怎么访问这三台pod？"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#怎么访问这三台pod？"}},[t._v("#")]),t._v(" 怎么访问这三台pod？")]),t._v(" "),e("h4",{attrs:{id:"只能内部能访问的方式：类型clusterip"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#只能内部能访问的方式：类型clusterip"}},[t._v("#")]),t._v(" 只能内部能访问的方式：类型ClusterIP")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("kubectl expose --help\n\n// 访问服务的80端口，实际上访问呢的就是容器的8000\nkubectl expose deployment nginx-deployment --port"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("30000")]),t._v(" --target-port"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v(" //deployment名字自己查查\n\nkubectl get svc\n\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" 【该service对应的clusterIP】:【30000】  // OK\n//每次curl都是从不同的pod上传回来的。轮询三个不同的pod。负载均衡。\n\n// 这个地址是内部地址，外部访问不了\nhttp://【该service对应的clusterIP】:【30000】  // NG\n\nkubectl get svc \n")])])]),e("p",[e("img",{attrs:{src:"/docs/images/2020-07-17-15-21-11.png",alt:""}})]),t._v(" "),e("h4",{attrs:{id:"修改成让外部也能访问：类型nodeport"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#修改成让外部也能访问：类型nodeport"}},[t._v("#")]),t._v(" 修改成让外部也能访问：类型NodePort")]),t._v(" "),e("p",[t._v("修改svc的type：ClusterIp→NodePort")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("kubectl edit svc nginx-deployment\n\n修改：\nType：ClusterIp 为 Type：NodePort \n\nkubectl get svc\n")])])]),e("p",[t._v("这样，"),e("strong",[t._v("所有节点")]),t._v("都暴漏了该端口。")]),t._v(" "),e("p",[e("img",{attrs:{src:"/docs/images/2020-07-17-15-23-25.png",alt:""}})]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("netstat")]),t._v(" -anpt"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("31859")]),t._v("\n//有了\n")])])]),e("p",[t._v("外部访问：\nhttp://192.168.3.105:31859 OK了\nhttp://192.168.3.106:31859 OK了\nhttp://192.168.3.107:31859 OK了")])])}),[],!1,null,null,null);a.default=r.exports}}]);