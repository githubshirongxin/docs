(window.webpackJsonp=window.webpackJsonp||[]).push([[72],{556:function(a,t,s){"use strict";s.r(t);var e=s(59),r=Object(e.a)({},(function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"gitlab备份、迁移、恢复和升级"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#gitlab备份、迁移、恢复和升级"}},[a._v("#")]),a._v(" "),s("a",{attrs:{href:"https://www.cnblogs.com/ssgeek/p/9392104.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("Gitlab备份、迁移、恢复和升级"),s("OutboundLink")],1)]),a._v(" "),s("p",[a._v("Gitlab备份、迁移、恢复和升级")]),a._v(" "),s("p",[a._v("自建的Gitlab服务器常常会因为使用时间的增长，其空间容量等硬件需求都需要升级，或者迁移至更高配置的服务器上。备份、迁移、恢复、升级过程如下")]),a._v(" "),s("h2",{attrs:{id:"_1、gitlab备份"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1、gitlab备份"}},[a._v("#")]),a._v(" 1、gitlab备份")]),a._v(" "),s("p",[a._v("备份前gitlab的项目如图所示")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://images2018.cnblogs.com/blog/1347532/201807/1347532-20180730182620361-3444825.png",alt:""}})]),a._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[a._v("WARNING")]),a._v(" "),s("ul",[s("li",[a._v("备份时需要保持gitlab处于正常运行状态，")]),a._v(" "),s("li",[a._v("直接执行"),s("code",[a._v("gitlab-rake gitlab:backup:create")]),a._v("进行备份")])])]),a._v(" "),s("p",[a._v("使用以上命令会在/var/opt/gitlab/backups目录下创建一个名称类似为\n"),s("code",[a._v("1530156812\\_2018\\_06\\_28\\_10.8.4\\_gitlab\\_backup.tar")]),a._v("的压缩包, 这个压缩包就是Gitlab整个的完整部分, 其中开头的"),s("code",[a._v("1530156812\\_2018\\_06\\_28\\_10.8.4")]),a._v("是备份创建的日期")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://images2018.cnblogs.com/blog/1347532/201807/1347532-20180730182622237-764141147.png",alt:""}})]),a._v(" "),s("p",[a._v("/etc/gitlab/gitlab.rb 配置文件须备份")]),a._v(" "),s("p",[a._v("/var/opt/gitlab/nginx/conf nginx配置文件")]),a._v(" "),s("p",[a._v("/etc/postfix/main.cfpostfix 邮件配置备份")]),a._v(" "),s("p",[s("img",{attrs:{src:"/docs/images/2020-10-11-17-53-38.png",alt:""}})]),a._v(" "),s("p",[a._v("/home 目录还有42G，目前只用了1%。\n"),s("img",{attrs:{src:"/docs/images/2020-10-11-17-54-16.png",alt:""}})]),a._v(" "),s("h3",{attrs:{id:"_1-1-修改备份文件目录"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-修改备份文件目录"}},[a._v("#")]),a._v(" 1.1 修改备份文件目录")]),a._v(" "),s("p",[a._v("可以通过/etc/gitlab/gitlab.rb配置文件来修改默认存放备份文件的目录")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("gitlab\\_rails\\['backup\\_path'\\] = \"/var/opt/gitlab/backups\"\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("修改完成之后使用gitlab-ctl reconfigure命令重载配置文件即可")]),a._v(" "),s("h3",{attrs:{id:"_1-2-设置备份过期时间"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-设置备份过期时间"}},[a._v("#")]),a._v(" 1.2 设置备份过期时间")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("\\[root\\@gitlab \\~\\]# vim /etc/gitlab/gitlab.rb\n\ngitlab\\_rails\\['backup\\_keep\\_time'\\] = 604800        #以秒为单位\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("h3",{attrs:{id:"_1-3-gitlab自动备份"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-gitlab自动备份"}},[a._v("#")]),a._v(" 1.3 gitlab自动备份")]),a._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[a._v("TIP")]),a._v(" "),s("p",[a._v("在宿主机（3.111上）创建定时任务。每天23：59执行一次备份。")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@centos111 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# crontab -e")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("59")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("23")]),a._v(" * * * docker "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exec")]),a._v(" -it gitlab gitlab-rake gitlab:backup:create\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("p"),a._v(" "),s("h2",{attrs:{id:"_2、gitlab迁移"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2、gitlab迁移"}},[a._v("#")]),a._v(" 2、gitlab迁移")]),a._v(" "),s("p",[a._v("迁移的整体思路是：")]),a._v(" "),s("h3",{attrs:{id:"_2-1、在新服务器上安装相同版本的gitlab"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1、在新服务器上安装相同版本的gitlab"}},[a._v("#")]),a._v(" 2.1、在新服务器上安装相同版本的gitlab")]),a._v(" "),s("h3",{attrs:{id:"_2-2、将备份生成的备份文件发送到新服务器的相同目录下"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2、将备份生成的备份文件发送到新服务器的相同目录下"}},[a._v("#")]),a._v(" 2.2、将备份生成的备份文件发送到新服务器的相同目录下")]),a._v(" "),s("p",[a._v("这里在10.0.0.6的机器上安装了相同版本的gitlab并能正常运行使用")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://images2018.cnblogs.com/blog/1347532/201807/1347532-20180730182624264-1023775088.png",alt:""}})]),a._v(" "),s("p",[a._v("在老服务器上将备份文件发送至新服务器的相应目录下")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("\\[root\\@gitlab \\~\\]# scp /var/opt/gitlab/backups/1530156812\\_2018\\_06\\_28\\_10.8.4\\_gitlab\\_backup.tar root\\@10.0.0.6:/var/opt/gitlab/backups/\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p"),a._v(" "),s("h3",{attrs:{id:"_2-3、gitlab恢复"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-3、gitlab恢复"}},[a._v("#")]),a._v(" 2.3、gitlab恢复")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("\\[root\\@gitlab \\~\\]# gitlab-ctl stop unicorn        #停止相关数据连接服务\n\n\\[root\\@gitlab \\~\\]# gitlab-ctl stop sidekiq\n\n\\[root\\@gitlab-new \\~\\]# chmod 777 /var/opt/gitlab/backups/1530156812\\_2018\\_06\\_28\\_10.8.4\\_gitlab\\_backup.tar\n#修改权限，如果是从本服务器恢复可以不修改\n\n\\[root\\@gitlab \\~\\]# gitlab-rake gitlab:backup:restore BACKUP=1530156812\\_2018\\_06\\_28\\_10.8.4    \n\n#从1530156812\\_2018\\_06\\_28\\_10.8.4编号备份中恢复\n\n按照提示输入两次yes并回车\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br")])]),s("p",[s("img",{attrs:{src:"https://images2018.cnblogs.com/blog/1347532/201807/1347532-20180730182626232-107761343.png",alt:""}})]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("\\[root\\@gitlab \\~\\]# gitlab-ctl start                #启动gitlab\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("浏览器访问新服务器的地址进行查看，迁移成功")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://images2018.cnblogs.com/blog/1347532/201807/1347532-20180730182628214-1929623760.png",alt:""}})]),a._v(" "),s("p",[a._v("在实际情况中访问gitlab可能是用域名访问，我们可以修改gitlab配置文件中的url再进行备份，这样就不会影响迁移过程，恢复完成后需要进行的只是修改域名对应的dns解析ip地址")]),a._v(" "),s("p"),a._v(" "),s("h2",{attrs:{id:"_4、gitlab升级"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4、gitlab升级"}},[a._v("#")]),a._v(" 4、gitlab升级")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("\\[root\\@gitlab \\~\\]# gitlab-ctl stop        #关闭gitlab服务\n\n\\[root\\@gitlab \\~\\]# gitlab-rake gitlab:backup:create        #备份\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("p",[a._v("下载新版gitlab的rpm包安装，安装时选择升级")]),a._v(" "),s("h3",{attrs:{id:"安装的过程中可能会出现报错"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装的过程中可能会出现报错"}},[a._v("#")]),a._v(" 安装的过程中可能会出现报错")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("Error executing action \\`run\\` on resource 'ruby\\_block\\[directory resource: /var/opt/gitlab/git-data/repositories\\]'\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("h3",{attrs:{id:"解决方法为"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#解决方法为"}},[a._v("#")]),a._v(" 解决方法为")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("\\[root\\@gitlab \\~\\]# chmod 2770 /var/opt/gitlab/git-data/repositories\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("h3",{attrs:{id:"安装成功后重新加载配置并启动"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装成功后重新加载配置并启动"}},[a._v("#")]),a._v(" 安装成功后重新加载配置并启动")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("\\[root\\@gitlab \\~\\]# gitlab-ctl reconfigure\n\n\\[root\\@gitlab \\~\\]# gitlab-ctl restart\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("p"),a._v(" "),s("h2",{attrs:{id:"_5、gitlab更改默认的nginx"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5、gitlab更改默认的nginx"}},[a._v("#")]),a._v(" 5、gitlab更改默认的nginx")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("\\[root\\@gitlab \\~\\]# vim /etc/gitlab/gitlab.rb\n\nnginx\\['enable'\\] = false        #不启用nginx\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("p",[a._v("检查默认nginx配置文件，并迁移至新Nginx服务")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("/var/opt/gitlab/nginx/conf/nginx.conf #nginx配置文件,包含gitlab-http.conf文件\n\n/var/opt/gitlab/nginx/conf/gitlab-http.conf #gitlab核心nginx配置文件\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("p",[a._v("重启 nginx、gitlab服务")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("\\[root\\@gitlab \\~\\]# gitlab-ctl restart\n\n\\[root\\@gitlab \\~\\]# systemctl restart nginx.service\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("p",[a._v("访问可能出现报502。原因是nginx用户无法访问gitlab用户的socket文件。 重启gitlab需要重新授权")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("\\[root\\@gitlab \\~\\]# chmod \\-R o+x /var/opt/gitlab/gitlab-rails\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p"),a._v(" "),s("p",[a._v("参考来源："),s("a",{attrs:{href:"http://www.xuliangwei.com/xubusi/803.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("http://www.xuliangwei.com/xubusi/803.html"),s("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=r.exports}}]);