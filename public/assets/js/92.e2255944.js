(window.webpackJsonp=window.webpackJsonp||[]).push([[92],{580:function(s,e,a){"use strict";a.r(e);var t=a(59),n=Object(t.a)({},(function(){var s=this,e=s.$createElement,a=s._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("ul",[a("li",[a("a",{attrs:{href:"#1-%E5%AE%89%E8%A3%85-masterworker%E9%9D%9E%E9%AB%98%E5%8F%AF%E7%94%A8"}},[s._v("1. 安装 master、worker(非高可用)")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E9%83%BD%E6%89%A7%E8%A1%8C%E7%9A%84%E5%91%BD%E4%BB%A4"}},[s._v("所有节点都执行的命令")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E5%8F%AA%E6%9C%89%E5%9C%A8master%E4%B8%8A%E6%89%A7%E8%A1%8C"}},[s._v("只有在Master上执行")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E5%8F%AA%E5%9C%A8worker%E4%B8%8A%E6%89%A7%E8%A1%8C%E5%B0%B1%E4%B8%80%E5%8F%A5join"}},[s._v("只在worker上执行，就一句join")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E6%9C%80%E5%90%8E%E9%AA%8C%E8%AF%81%E4%B8%80%E4%B8%8B%E5%B0%B1%E4%B8%80%E5%8F%A5"}},[s._v("最后验证一下。就一句")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E6%96%87%E5%AD%97%E5%91%BD%E4%BB%A4"}},[s._v("文字命令")])])])]),s._v(" "),a("li",[a("a",{attrs:{href:"#2-%E9%AB%98%E5%8F%AF%E7%94%A8cluster"}},[s._v("2. 高可用cluster")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#3-securing-k8s"}},[s._v("3. securing k8s")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#31-apiserver%E6%8E%A5%E5%8F%97%E8%AF%B7%E6%B1%82%E7%9A%84%E8%BF%87%E7%A8%8B"}},[s._v("3.1 apiserver接受请求的过程")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#%E9%A6%96%E5%85%88apiserver%E6%8E%A5%E5%8F%97%E8%AF%B7%E6%B1%82%E5%81%9A%E4%B8%8B%E9%9D%A2%E5%9B%9B%E6%AD%A5"}},[s._v("首先，apiserver接受请求。做下面四步")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E6%9C%80%E5%90%8E%E6%8A%8A%E7%BB%93%E6%9E%9C%E5%86%99%E5%85%A5etcd"}},[s._v("最后，把结果写入etcd")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E6%BC%94%E7%A4%BA"}},[s._v("演示")])])])]),s._v(" "),a("li",[a("a",{attrs:{href:"#32-%E8%AF%B7%E6%B1%82%E5%8F%91%E8%B5%B7%E7%AB%AF%E7%9A%84serviceaccount"}},[s._v("3.2 请求发起端的ServiceAccount")])])])]),s._v(" "),a("li",[a("a",{attrs:{href:"#4-%E7%AB%AF%E5%88%B0%E7%AB%AF%E6%B5%8B%E8%AF%95%E9%AA%8C%E8%AF%81pod%E7%8A%B6%E6%80%81%E6%AD%A3%E5%B8%B8"}},[s._v("4. 端到端测试，验证pod状态正常")]),s._v("\nminikube是最好用的单节点k8s")])]),s._v(" "),a("h2",{attrs:{id:"_1-安装-master、worker-非高可用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装-master、worker-非高可用"}},[s._v("#")]),s._v(" 1. 安装 master、worker(非高可用)")]),s._v(" "),a("p",[s._v('PS1="node0:~$ "\nPS1="node1:~$ "\nPS1="node2:~$ "')]),s._v(" "),a("h3",{attrs:{id:"所有节点都执行的命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#所有节点都执行的命令"}},[s._v("#")]),s._v(" 所有节点都执行的命令")]),s._v(" "),a("p",[a("img",{attrs:{src:"/docs/images/2020-08-21-10-34-09.png",alt:""}})]),s._v(" "),a("h3",{attrs:{id:"只有在master上执行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#只有在master上执行"}},[s._v("#")]),s._v(" 只有在Master上执行")]),s._v(" "),a("p",[a("img",{attrs:{src:"/docs/images/2020-08-21-10-37-28.png",alt:""}})]),s._v(" "),a("h3",{attrs:{id:"只在worker上执行-就一句join"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#只在worker上执行-就一句join"}},[s._v("#")]),s._v(" 只在worker上执行，就一句join")]),s._v(" "),a("p",[a("img",{attrs:{src:"/docs/images/2020-08-21-10-38-58.png",alt:""}})]),s._v(" "),a("h3",{attrs:{id:"最后验证一下。就一句"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#最后验证一下。就一句"}},[s._v("#")]),s._v(" 最后验证一下。就一句")]),s._v(" "),a("p",[a("img",{attrs:{src:"/docs/images/2020-08-21-10-40-02.png",alt:""}})]),s._v(" "),a("h3",{attrs:{id:"文字命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#文字命令"}},[s._v("#")]),s._v(" 文字命令")]),s._v(" "),a("p",[s._v("Get the Docker gpg key:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -fsSL https://download.docker.com/linux/ubuntu/gpg "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" apt-key "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" -\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("Add the Docker repository:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" add-apt-repository    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"deb [arch=amd64] https://download.docker.com/linux/ubuntu \\\n   '),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("lsb_release -cs"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v(' \\\n   stable"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("Get the Kubernetes gpg key:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -s https://packages.cloud.google.com/apt/doc/apt-key.gpg "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" apt-key "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" -\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("Add the Kubernetes repository:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" EOF "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tee")]),s._v(" /etc/apt/sources.list.d/kubernetes.list\ndeb https://apt.kubernetes.io/ kubernetes-xenial main\nEOF\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("Update your packages:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" update\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("Install Docker, kubelet, kubeadm, and kubectl:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y docker-ce"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(":19.03.12~3-0~ubuntu-bionic "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("kubelet")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.17")]),s._v(".8-00 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("kubeadm")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.17")]),s._v(".8-00 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("kubectl")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.17")]),s._v(".8-00\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("Hold them at the current version:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" apt-mark hold docker-ce kubelet kubeadm kubectl\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("Add the iptables rule to sysctl.conf:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"net.bridge.bridge-nf-call-iptables=1"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tee")]),s._v(" -a /etc/sysctl.conf\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("Enable iptables immediately:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" sysctl -p\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("Initialize the cluster (run only on the master):")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" kubeadm init --pod-network-cidr"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".0.0/16\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("Set up local kubeconfig (run only on the master):")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/.kube\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" -i /etc/kubernetes/admin.conf "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/.kube/config\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" -u"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" -g"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v(" "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/.kube/config\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("Apply Calico CNI network overlay (run only on the master):")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl apply -f https://docs.projectcalico.org/v3.14/manifests/calico.yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("Join the worker nodes to the cluster:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" kubeadm "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("your unique string from the kubeadm init command"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("Verify the worker nodes have joined the cluster successfully:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl get nodes\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("Compare this result of the kubectl get nodes command:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("NAME                            STATUS   ROLES    AGE   VERSION\nchadcrowell1c.mylabserver.com   Ready    master   4m18s v1.17.8\nchadcrowell2c.mylabserver.com   Ready    none     82s   v1.17.8\nchadcrowell3c.mylabserver.com   Ready    none     69s   v1.17.8\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h2",{attrs:{id:"_2-高可用cluster"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-高可用cluster"}},[s._v("#")]),s._v(" 2. 高可用cluster")]),s._v(" "),a("p",[a("img",{attrs:{src:"/docs/images/2020-08-23-08-52-53.png",alt:""}}),s._v(" "),a("img",{attrs:{src:"/docs/images/2020-08-23-08-59-49.png",alt:""}})]),s._v(" "),a("p",[s._v("You can provide high availability for cluster components by running multiple instances — however, some replicated components must remain in standby mode. The scheduler and the controller manager are actively watching the cluster state and take action when it changes. If multiples are running, it creates the possibility of unwarranted duplicates of pods.")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos3 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pods -o custom-columns=POD:metadata.name,NODE:spec.nodeName --sort-by spec.nodeName -n kube-system")]),s._v("\nPOD                                     NODE\nkube-proxy-tscrk                        centos1\ncoredns-bccdc95cf-ss9q9                 centos1\netcd-centos1                            centos1\nkube-apiserver-centos1                  centos1\nkube-controller-manager-centos1         centos1\nkube-scheduler-centos1                  centos1\nkube-flannel-ds-amd64-rn7mc             centos1\ncoredns-bccdc95cf-hsvt6                 centos1\nkube-proxy-5lz2q                        centos2\nkube-flannel-ds-amd64-xcsg4             centos2\nkube-proxy-hjlrp                        centos3\nkube-flannel-ds-amd64-8ztst             centos3\nkubernetes-dashboard-574b546db9-7frfw   centos3\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos3 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos3 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get endpoints kube-scheduler -n kube-system -o yaml")]),s._v("\napiVersion: v1\nkind: Endpoints\nmetadata:\n  annotations:\n    control-plane.alpha.kubernetes.io/leader: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{"holderIdentity":"centos1_4f42572f-05d7-40a6-8963-ecc1876242a5","leaseDurationSeconds":15,"acquireTime":"2020-08-17T05:23:55Z","renewTime":"2020-08-23T00:55:40Z","leaderTransitions":7}\'')]),s._v("\n  creationTimestamp: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2020-06-29T11:23:40Z"')]),s._v("\n  name: kube-scheduler\n  namespace: kube-system\n  resourceVersion: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"4866299"')]),s._v("\n  selfLink: /api/v1/namespaces/kube-system/endpoints/kube-scheduler\n  uid: a14548f8-b5a9-4440-8a44-b835ffbb678d\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos3 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br")])]),a("p",[s._v("Create a file called kubeadm-config.yaml")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubeadm.k8s.io/v1beta2\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ClusterConfiguration\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kubernetesVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" stable\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("controlPlaneEndpoint")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"LOAD_BALANCER_DNS:LOAD_BALANCER_PORT"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("etcd")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("external")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("endpoints")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//ETCD_0_IP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2379")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//ETCD_1_IP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2379")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//ETCD_2_IP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2379")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("caFile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/kubernetes/pki/etcd/ca.crt\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("certFile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/kubernetes/pki/apiserver"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("etcd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("client.crt\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("keyFile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/kubernetes/pki/apiserver"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("etcd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("client.key\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("Create a stacked etcd topology using kubeadm:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubeadm init --config"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubeadm-config.yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("Watch as pods are created in the default namespace:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl get pods -n kube-system -w\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("Helpful Links:")])]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://kubernetes.io/docs/setup/independent/high-availability/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Creating Highly Available Kubernetes Clusters with kubeadm"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://kubernetes.io/docs/setup/independent/ha-topology/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Highly Available Topologies in Kubernetes"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Operating a Highly Available etcd Cluster"),a("OutboundLink")],1)])]),s._v(" "),a("h2",{attrs:{id:"_3-securing-k8s"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-securing-k8s"}},[s._v("#")]),s._v(" 3. securing k8s")]),s._v(" "),a("p",[a("img",{attrs:{src:"/docs/images/2020-08-23-10-03-53.png",alt:""}})]),s._v(" "),a("h3",{attrs:{id:"_3-1-apiserver接受请求的过程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-apiserver接受请求的过程"}},[s._v("#")]),s._v(" 3.1 apiserver接受请求的过程")]),s._v(" "),a("p",[s._v("apiserver会接收两种请求，一种是命令行执行的kubectl，还有一种是\npod里执行的请求。")]),s._v(" "),a("h4",{attrs:{id:"首先-apiserver接受请求。做下面四步"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#首先-apiserver接受请求。做下面四步"}},[s._v("#")]),s._v(" 首先，apiserver接受请求。做下面四步")]),s._v(" "),a("p",[s._v("authentiation: 从请求的header中识别出user，group\nauthorization：判断改user和group是否有权限在改namespace\nadmission：增改删资源例如pod，需要发送给admission control。\nresource validate:")]),s._v(" "),a("h4",{attrs:{id:"最后-把结果写入etcd"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#最后-把结果写入etcd"}},[s._v("#")]),s._v(" 最后，把结果写入etcd")]),s._v(" "),a("h4",{attrs:{id:"演示"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#演示"}},[s._v("#")]),s._v(" 演示")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos3 kubernetes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls")]),s._v("\nadmin.conf  bootstrap-kubelet.conf  kubelet.conf  manifests  pki\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos3 kubernetes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat admin.conf")]),s._v("\napiVersion: v1\nclusters:\n- cluster:\n    certificate-authority-data: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN5RENDQWJDZ0F3SUJBdHUwbjJNbz0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n    server: https://192.168.3.105:6443\n  name: kubernetes\ncontexts:\n- context:\n    cluster: kubernetes\n    user: kubernetes-admin\n  name: kubernetes-admin@kubernetes\ncurrent-context: kubernetes-admin@kubernetes\nkind: Config\npreferences: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nusers:\n- name: kubernetes-admin\n  user:\n    client-certificate-data: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM4akNDQWRxZ0F3SUJBLQo")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n    client-key-data: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBVkFURSBLRVktLS0tLQo")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("h3",{attrs:{id:"_3-2-请求发起端的serviceaccount"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-请求发起端的serviceaccount"}},[s._v("#")]),s._v(" 3.2 请求发起端的ServiceAccount")]),s._v(" "),a("p",[s._v("创建pod的时候就会有serviceAccout。并带着一个tokenfile。\n例如进入到某个pod的sh，打印出改pod的serviceAccount的token。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /var/secrets/kubernetes.io/serviceaccount/tocken\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[a("p",[s._v("pod请求时的serviceaccount\n当pod请求apiserver的时候，就是把这个serviceAccount发送给apiserver去提出user，验证user权限。")])]),s._v(" "),a("li",[a("p",[s._v("kubectl请求时的servcieaccount\n默认的serviceaccount.如果不想使用默认service account，必须在manifest目录指定serviceaccount。但是（pod不能指定别的ns的serviceaccount。只能指定自己的ns里的。）")])])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos3 kubernetes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get serviceaccounts")]),s._v("\nNAME      SECRETS   AGE\ndefault   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("         54d\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos3 kubernetes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[a("img",{attrs:{src:"/docs/images/2020-08-23-10-12-05.png",alt:""}}),s._v("\nRole-binding：决定了谁能做这些事\nrole：角色能做哪些事")]),s._v(" "),a("p",[s._v("为了防止未经授权的用户修改群集状态，使用了RBAC，它为用户定义了角色和角色绑定。为Pod创建一个服务帐户资源，以确定它如何控制群集状态。例如，默认服务帐户将不允许您在名称空间中列出服务。")]),s._v(" "),a("p",[s._v("查看kube-config：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" .kube/config "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("more")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("查看服务帐户令牌：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl get secrets\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("创建一个新的名称空间my-ns：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl create ns my-ns\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("在my-ns名称空间中运行kube-proxy pod ：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl run "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" --image"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("chadmcrowell/kubectl-proxy -n my-ns\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("列出my-ns命名空间中的Pod ：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl get pods -n my-ns\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("在新创建的pod中运行shell：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("name-of-pod"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" -n my-ns "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("通过API调用在名称空间中列出服务：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" localhost:8001/api/v1/namespaces/my-ns/services\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("从Pod中查看令牌文件：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /var/run/secrets/kubernetes.io/serviceaccount/token\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("列出集群中的服务帐户资源：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl get serviceaccounts\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[s._v("有用的网址"),a("br"),s._v(" "),a("a",{attrs:{href:"https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/",target:"_blank",rel:"noopener noreferrer"}},[s._v("服务帐号"),a("OutboundLink")],1),a("br"),s._v(" "),a("a",{attrs:{href:"http://kubernetes.io/docs/admin",target:"_blank",rel:"noopener noreferrer"}},[s._v("群集管理概述"),a("OutboundLink")],1),a("br"),s._v(" "),a("a",{attrs:{href:"https://kubernetes.io/docs/concepts/cluster-administration/cluster-administration-overview/#securing-a-cluster",target:"_blank",rel:"noopener noreferrer"}},[s._v("保护集群"),a("OutboundLink")],1),a("br"),s._v(" "),a("a",{attrs:{href:"https://kubernetes.io/docs/reference/access-authn-authz/controlling-access/",target:"_blank",rel:"noopener noreferrer"}},[s._v("控制对API的访问"),a("OutboundLink")],1),a("br"),s._v(" "),a("a",{attrs:{href:"https://kubernetes.io/docs/reference/access-authn-authz/authorization/",target:"_blank",rel:"noopener noreferrer"}},[s._v("授权书"),a("OutboundLink")],1),a("br"),s._v(" "),a("a",{attrs:{href:"https://kubernetes.io/docs/tasks/extend-kubernetes/http-proxy-access-api/",target:"_blank",rel:"noopener noreferrer"}},[s._v("使用代理访问API"),a("OutboundLink")],1)])]),s._v(" "),a("h2",{attrs:{id:"_4-端到端测试-验证pod状态正常"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-端到端测试-验证pod状态正常"}},[s._v("#")]),s._v(" 4. 端到端测试，验证pod状态正常")]),s._v(" "),a("p",[s._v("运行端到端测试可确保您的应用程序高效运行，而不必担心群集运行状况问题。Kubetest是提供端到端测试的有用工具-但是，它不在本考试范围内。在本课程中，我们将通过实践来测试我们运行部署，运行Pod，暴露容器，从容器执行命令，运行服务以及检查节点和Pod的整体运行状况的能力。")]),s._v(" "),a("p",[s._v("运行一个简单的nginx部署：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl create deployment nginx --image"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("查看集群中的部署：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl get deployments\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("查看集群中的Pod：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl get pods\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("使用端口转发直接访问Pod：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl port-forward "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pod_name")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8081")]),s._v(":80\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("直接从Nginx窗格获得响应：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" --head http://127.0.0.1:8081\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("从窗格中查看日志：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl logs "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pod_name")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("直接从容器运行命令：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$pod_name")]),s._v(" -- nginx -v\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("通过暴露nginx部署的端口80创建服务：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl expose deployment nginx --port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(" --type NodePort\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("列出集群中的服务：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl get services\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("取得服务的回应：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -I localhost:"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$node_port")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("列出节点的状态：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl get nodes\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("查看有关节点的详细信息：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl describe nodes\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("查看有关吊舱的详细信息：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl describe pods\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("有用的网址：")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/kubernetes/community/blob/master/contributors/devel/sig-testing/e2e-tests.md",target:"_blank",rel:"noopener noreferrer"}},[s._v("Kubetest"),a("OutboundLink")],1),s._v(" "),a("a",{attrs:{href:"https://kubernetes.io/docs/getting-started-guides/ubuntu/",target:"_blank",rel:"noopener noreferrer"}},[s._v("测试一个枣簇"),a("OutboundLink")],1)])])}),[],!1,null,null,null);e.default=n.exports}}]);