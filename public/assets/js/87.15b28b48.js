(window.webpackJsonp=window.webpackJsonp||[]).push([[87],{564:function(_,v,t){"use strict";t.r(v);var l=t(55),i=Object(l.a)({},(function(){var _=this,v=_.$createElement,t=_._self._c||v;return t("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[t("p",[_._v("属于感性理解还可以，并不适合上手。\n讲得方方面面很多，但都不深入。也不能实操。")]),_._v(" "),t("h1",{attrs:{id:"高可用架构设计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#高可用架构设计"}},[_._v("#")]),_._v(" 高可用架构设计")]),_._v(" "),t("h2",{attrs:{id:"第一课：什么是高可用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第一课：什么是高可用"}},[_._v("#")]),_._v(" 第一课：什么是高可用")]),_._v(" "),t("p",[_._v("如何评价高可用？断开服务时间和运行时间的比例\n99% = 88小时 /一年\n99.9% = 8小时/一年\n99.99% = 8分钟/一年")]),_._v(" "),t("h2",{attrs:{id:"第二课：高可用架构分层："}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第二课：高可用架构分层："}},[_._v("#")]),_._v(" 第二课：高可用架构分层：")]),_._v(" "),t("h3",{attrs:{id:"_2-1-不是越多越好"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-不是越多越好"}},[_._v("#")]),_._v(" 2.1 不是越多越好")]),_._v(" "),t("ul",[t("li",[_._v("前台： MVC")]),_._v(" "),t("li",[_._v("后台：\n"),t("ul",[t("li",[_._v("按功能分4~5层：接入层、（异步消息队列序列化层）、逻辑层、数据层、存储层")]),_._v(" "),t("li",[_._v("按业务垂直拆分：\n"),t("ul",[t("li",[_._v("房产，招聘")]),_._v(" "),t("li",[_._v("IM，交友")])])])])]),_._v(" "),t("li",[_._v("分的少：耦合")]),_._v(" "),t("li",[_._v("分的多：维护成本高，延迟，定位问题复杂度增加，定位时间增加")])]),_._v(" "),t("h3",{attrs:{id:"_2-2-为什么需要分层？"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-为什么需要分层？"}},[_._v("#")]),_._v(" 2.2 为什么需要分层？")]),_._v(" "),t("p",[_._v("耦合，扩展性不强，增加了down的几率。")]),_._v(" "),t("font",{attrs:{color:"red"}},[_._v("\n+ 传统开发spring或struts分开开发mvc是然后做一个war或jar，这叫逻辑分层。（发布上）（进程上）"),t("br"),_._v("\n+ 而这里说的分层，指的是物理分层，就像微服务。每层上有多个服务。层之间靠api来通信。"),t("br"),_._v("\n+ 服务的切分。\n")]),_._v(" "),t("h3",{attrs:{id:"_2-3-到底分几层？怎么去分层"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-到底分几层？怎么去分层"}},[_._v("#")]),_._v(" 2.3 到底分几层？怎么去分层")]),_._v(" "),t("p",[_._v("A: 必须看业务场景。不看业务场景谈架构是没有意义的。来源于业务场景服务于业务场景。")]),_._v(" "),t("ul",[t("li",[t("ol",[t("li",[_._v("创业初期 - 让公司先活下来再说\n"),t("ul",[t("li",[_._v("满足业务快速发展")]),_._v(" "),t("li",[_._v("可用性低也行")]),_._v(" "),t("li",[_._v("分层少 OK。不分也OK")]),_._v(" "),t("li",[_._v("ALL in one （MVC）完全OK")])])])])]),_._v(" "),t("li",[t("ol",{attrs:{start:"2"}},[t("li",[_._v("请求量和数据量在快速爆发时期\n"),t("ul",[t("li",[_._v("引入分层")]),_._v(" "),t("li",[_._v("接入层、逻辑层、数据层")]),_._v(" "),t("li",[_._v("满足业务增长需求")])])])])]),_._v(" "),t("li",[t("ol",{attrs:{start:"3"}},[t("li",[_._v("业务高并发、海量存储\n"),t("ul",[t("li",[_._v("每层进一步细化")]),_._v(" "),t("li",[_._v("分布式存储、NoSql、RDBMS分库分表")])])])])]),_._v(" "),t("li",[t("ol",{attrs:{start:"4"}},[t("li",[_._v("业务多、请求多、关系复杂\n"),t("ul",[t("li",[_._v("58列表页 、详情页问题")]),_._v(" "),t("li",[_._v("服务化（API接口来互相衔接，而不是jar包互相依赖）")]),_._v(" "),t("li",[_._v("解耦、稳定")])])])])])]),_._v(" "),t("h3",{attrs:{id:"_2-4-分层的真实最佳实践案例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-分层的真实最佳实践案例"}},[_._v("#")]),_._v(" 2.4 分层的真实最佳实践案例")]),_._v(" "),t("h4",{attrs:{id:"_2-4-1-案例1：58帮帮"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-1-案例1：58帮帮"}},[_._v("#")]),_._v(" 2.4.1 案例1：58帮帮")]),_._v(" "),t("p",[_._v("定位：传统IM，满足58用户和商户沟通。就像淘宝旺旺。\n性能：千万用户同时在线。\n"),t("img",{attrs:{src:"/docs/images/2020-07-09-16-07-25.png",alt:""}}),_._v("\n架构：\n"),t("img",{attrs:{src:"/docs/images/2020-07-09-16-07-39.png",alt:""}})]),_._v(" "),t("ul",[t("li",[_._v("接入层：\n"),t("ul",[t("li",[_._v("长连接加密（TCP），")]),_._v(" "),t("li",[_._v("web上js-http长连接。")]),_._v(" "),t("li",[_._v("用户连接后没有操作，后台就断掉连接：攻防。")]),_._v(" "),t("li",[_._v("用户身份校验（用户名）")]),_._v(" "),t("li",[_._v("转发逻辑层")])])]),_._v(" "),t("li",[_._v("逻辑层：\n"),t("ul",[t("li",[_._v("黑名单加入了没有，加入了就忽略消息")]),_._v(" "),t("li",[_._v("antispam系统")])])]),_._v(" "),t("li",[_._v("路由层：\n"),t("ul",[t("li",[_._v("在线的状态信息。隐身、离开等与session相关信息。没必要保留在数据库中，而是缓存在RS层。")]),_._v(" "),t("li",[_._v("记录了每个用户接入层的节点。")]),_._v(" "),t("li",[_._v("发消息是，在路由层找到该用户的接入层，就找到该用户用的长连接。就发消息过去了。")])])])]),_._v(" "),t("h4",{attrs:{id:"_2-4-2-案例2：-服务器推送消息文本、图片、音频、视频"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-2-案例2：-服务器推送消息文本、图片、音频、视频"}},[_._v("#")]),_._v(" 2.4.2 案例2： 服务器推送消息文本、图片、音频、视频")]),_._v(" "),t("p",[_._v("移动互联网的最基础需求，因为移动互联网的网络是不稳定的，所以需要异步推送消息。保证通知到。\n定位：58同一的移动push推送平台\n吞吐量：10W+QPS\n推送两：每天10亿+\n很多App接入该平台。")]),_._v(" "),t("ul",[t("li",[_._v("接入层：\n"),t("img",{attrs:{src:"/docs/images/2020-07-09-17-20-26.png",alt:""}}),_._v(" "),t("ul",[t("li",[_._v("push entry 消息队列入口")]),_._v(" "),t("li",[_._v("push transfer： 校验（token）和转发")])])]),_._v(" "),t("li",[_._v("出口层\n"),t("ul",[t("li",[_._v("android出口")]),_._v(" "),t("li",[_._v("ios 出口")]),_._v(" "),t("li",[_._v("第三方推送平台：\n"),t("ul",[t("li",[_._v("苹果：apns")])])])])])]),_._v(" "),t("h4",{attrs:{id:"_2-4-3-案例3：电商平台-c2c-转转"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-3-案例3：电商平台-c2c-转转"}},[_._v("#")]),_._v(" 2.4.3 案例3：电商平台 C2C 转转")]),_._v(" "),t("p",[_._v("定位：全国最大的个人闲置交易平台\n功能：用户、商品、社交、交易、圈子、推荐、\n功能多\n业务复杂\n未来扩展\n高可用\n"),t("img",{attrs:{src:"/docs/images/2020-07-09-17-24-06.png",alt:""}})]),_._v(" "),t("h4",{attrs:{id:"_2-5【思考】高可用分层的潜在问题是什么？"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-5【思考】高可用分层的潜在问题是什么？"}},[_._v("#")]),_._v(" 2.5【思考】高可用分层的潜在问题是什么？")]),_._v(" "),t("ul",[t("li",[_._v("我觉得：运维成本高。最短时间也比直接all in one要慢。以后开发比较复杂。")]),_._v(" "),t("li",[_._v("缺点：维护成本高，延迟，定位问题复杂度增加，定位时间增加")]),_._v(" "),t("li",[_._v("优点：可扩展性好")])]),_._v(" "),t("hr"),_._v(" "),t("h2",{attrs:{id:"第三课：高可用硬件如何选择"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第三课：高可用硬件如何选择"}},[_._v("#")]),_._v(" 第三课：高可用硬件如何选择")]),_._v(" "),t("p",[_._v("这是软件开发人员的短板。大家都不是很熟悉。\n主流硬件：")]),_._v(" "),t("ul",[t("li",[_._v("CPU：\n"),t("ul",[t("li",[_._v("32processor（8物理核心，每核心2个处理器，开启超线程）")]),_._v(" "),t("li",[_._v("2.5GHZ")])])]),_._v(" "),t("li",[_._v("内存：\n"),t("ul",[t("li",[_._v("32G→64G→96G→128G")])])]),_._v(" "),t("li",[_._v("磁盘：\n"),t("ul",[t("li",[_._v("SATA机械盘 → SAS机械盘 → SSD固态硬盘")]),_._v(" "),t("li",[_._v("价格10被")]),_._v(" "),t("li",[_._v("IO性能50倍")]),_._v(" "),t("li",[_._v("读写越来越快 300M/s 读写都是很正常的。")]),_._v(" "),t("li",[_._v("硬件成本越来越高")]),_._v(" "),t("li",[_._v("1TB")])])]),_._v(" "),t("li",[_._v("网卡：\n"),t("ul",[t("li",[_._v("100mbs")]),_._v(" "),t("li",[_._v("1000mbs")])])])]),_._v(" "),t("p",[t("code",[_._v("cat /proc/cpuinfo")]),_._v(" "),t("code",[_._v("free -g")]),_._v(" //以G为单位")]),_._v(" "),t("ul",[t("li",[t("p",[_._v("buffer和cache有什么区别？")])]),_._v(" "),t("li",[t("p",[_._v("从OS角度看还有多少剩余内存？从app角度看还有多少剩余内存？")])])]),_._v(" "),t("h3",{attrs:{id:"_3-1-如何选择硬件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-如何选择硬件"}},[_._v("#")]),_._v(" 3.1 如何选择硬件")]),_._v(" "),t("p",[t("img",{attrs:{src:"/docs/images/2020-07-09-18-02-32.png",alt:""}}),_._v("\nC6100 2U指什么？ 服务器的长宽高和接口，U=就是这个规范单位。用于上机架用。")]),_._v(" "),t("h5",{attrs:{id:"机型分类："}},[t("a",{staticClass:"header-anchor",attrs:{href:"#机型分类："}},[_._v("#")]),_._v(" 机型分类：")]),_._v(" "),t("ul",[t("li",[_._v("内存性质\n"),t("ul",[t("li",[_._v("8corex2 mem:128G Dis:SAS600Gx6 Raid5 //CPU一般，内存大")]),_._v(" "),t("li",[_._v("8corex2 mem:192G Dis:SAS600Gx6 Raid5")])])]),_._v(" "),t("li",[_._v("IO性质\n"),t("ul",[t("li",[_._v("8Corex2 mem:128G Disk:SAS600Gx2 Raid1 + Intel S3700 800Gx6 Raid5 // 硬盘好")])])]),_._v(" "),t("li",[_._v("存储型：\n"),t("ul",[t("li",[_._v("8Corex2 MEM192G DISk 600Gx2 Raid1 + SATA 4TB * 12 Non-raid (Spark) //硬盘大")]),_._v(" "),t("li",[_._v("8Corex2 MEM192G DISk 600Gx2 Raid1 + SAS 1TB * 24 Non-rad /raid5  //硬盘大")])])]),_._v(" "),t("li",[_._v("CPU计算性质\n"),t("ul",[t("li",[_._v("10Corex4 MEM:192G Disk:SAS 600G * 6 Raid5 // CPU核心多")]),_._v(" "),t("li",[_._v("8Core*2 mem:192G Disk:SAS 600G * 6 Raid5 GPU卡 //基于GPU计算")])])])]),_._v(" "),t("h3",{attrs:{id:"_3-2-选择什么硬件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-选择什么硬件"}},[_._v("#")]),_._v(" 3.2 选择什么硬件")]),_._v(" "),t("p",[_._v("取决于业务场景：")]),_._v(" "),t("table",[t("thead",[t("tr",[t("th",{staticStyle:{"text-align":"left"}},[_._v("业务逻辑")]),_._v(" "),t("th",{staticStyle:{"text-align":"left"}},[_._v("服务器类型")])])]),_._v(" "),t("tbody",[t("tr",[t("td",{staticStyle:{"text-align":"left"}},[_._v("web业务（tomcat，nginx）")]),_._v(" "),t("td",{staticStyle:{"text-align":"left"}},[_._v("内存型/计算型")])]),_._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[_._v("逻辑业务（判断，拼装等计算密集型）")]),_._v(" "),t("td",{staticStyle:{"text-align":"left"}},[_._v("计算型")])]),_._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[_._v("Cache业务（memcached，redis）")]),_._v(" "),t("td",{staticStyle:{"text-align":"left"}},[_._v("内存型")])]),_._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[_._v("测试应用（测试人员测试）")]),_._v(" "),t("td",{staticStyle:{"text-align":"left"}},[_._v("虚拟机（机器硬件过剩可以拆分成多个物理隔离）")])]),_._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[_._v("数据库存储型")]),_._v(" "),t("td",{staticStyle:{"text-align":"left"}},[_._v("SSD")])]),_._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[_._v("实时计算Spark/Storm")]),_._v(" "),t("td",{staticStyle:{"text-align":"left"}},[_._v("大规模存储SATA，对CPU内存不要求")])]),_._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[_._v("离线计算场景Hadoop")]),_._v(" "),t("td",{staticStyle:{"text-align":"left"}},[_._v("大规模存储SATA，对CPU内存不要求")])]),_._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[_._v("海量存储文件，图片")]),_._v(" "),t("td",{staticStyle:{"text-align":"left"}},[_._v("存储型pulic")])]),_._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[_._v("图像识别")]),_._v(" "),t("td",{staticStyle:{"text-align":"left"}},[_._v("计算型GPU")])]),_._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[_._v("线下，边缘业务")]),_._v(" "),t("td",{staticStyle:{"text-align":"left"}},[_._v("虚拟机")])])])]),_._v(" "),t("p",[_._v("虚拟机裸机：30%的性能消耗\n宿主机重新也不影响应用，这才叫高可用。我完全可以实验。")]),_._v(" "),t("h3",{attrs:{id:"_3-3-硬件上如何保证高可用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-硬件上如何保证高可用"}},[_._v("#")]),_._v(" 3.3 硬件上如何保证高可用")]),_._v(" "),t("ul",[t("li",[_._v("传统企业级应用\n"),t("ul",[t("li",[_._v("“IO1” ：IBM大型或小型机 + ORACLE + EMC存储 // 价格昂贵，保证了高可用和性能")]),_._v(" "),t("li",[_._v("直接All in one 就好了。能保证一定可用性。")])])]),_._v(" "),t("li",[_._v("互联网打法\n"),t("ul",[t("li",[_._v("PC级服务器（价格低廉）\n"),t("ul",[t("li",[_._v("1年down机一次是大概率事件")]),_._v(" "),t("li",[_._v("高强度读写普通磁盘，损坏概率更高一些")]),_._v(" "),t("li",[_._v("硬件可用性进一步下降")])])]),_._v(" "),t("li",[_._v("怎么做到PC级服务器高可用呢？\n"),t("ul",[t("li",[_._v("尽可能采用配置比较高的服务器。生命周期比较长。")]),_._v(" "),t("li",[_._v("没办法的话，就改善磁盘NAS等，SSD等。 关注磁盘高可用。数据是最重要的。")])])]),_._v(" "),t("li",[_._v("磁盘：\n"),t("ul",[t("li",[_._v("SATA：串行ATA。 ~10M/s")]),_._v(" "),t("li",[_._v("SCSI：小型计算机接口。")]),_._v(" "),t("li",[_._v("SAS ：串行接口。")]),_._v(" "),t("li",[_._v("SSD ：功耗小，耐震，耐高温。贵。 是SATA的50倍 300~500M/s")])])]),_._v(" "),t("li",[_._v("对磁盘的高可用：\n"),t("ul",[t("li",[_._v("Raid（磁盘阵列）：价格便宜的磁盘构成磁盘组。并行读写 + 冗余备份。提高性能和可用性。\n"),t("ul",[t("li",[_._v("raid 0 ：拆分文件，并行写入。加速读写，没有冗余备份")]),_._v(" "),t("li",[_._v("raid 1 ：只做冗余备份。 可用率 50%。")]),_._v(" "),t("li",[_._v("raid 2 ：")]),_._v(" "),t("li",[_._v("raid 5 ：每个磁盘都是单独校验。有一个块磁盘坏了没问题。\n"),t("ul",[t("li",[_._v("可用率：所有磁盘减去一个磁盘。")]),_._v(" "),t("li",[_._v("速度： 4硬盘raid5是raid 0的速度，比三硬盘更快。价格差一倍。")])])]),_._v(" "),t("li",[_._v("raid 6 ：几乎同上。性能更佳。允许同时坏两块硬盘。")]),_._v(" "),t("li",[_._v("raid 10 ： Raid0 + raid1的结合。先顶层Raid1 在 底层Raid0. 才具备可用性。  可用率50%")])])])])]),_._v(" "),t("li",[_._v("单机层面保证磁盘高可用\n"),t("ul",[t("li",[_._v("系统保存数据：RAID/SAS")]),_._v(" "),t("li",[_._v("系统不存储数据 ： 不Raid")]),_._v(" "),t("li",[_._v("DB ： Raid /固态硬盘")]),_._v(" "),t("li",[_._v("如果是整个机器挂掉了")])])]),_._v(" "),t("li",[_._v("Raid的优化\n"),t("ul",[t("li",[_._v("词条元素大小 8kb，16kb，32kb，64kb，128kb 越大性能越好")]),_._v(" "),t("li",[_._v("读写策略：fore wb with no battery")])])]),_._v(" "),t("li",[_._v("单机+raid还是不靠谱，怎么办？\n"),t("ul",[t("li",[_._v("系统多机冗余 （普通"),t("strong",[_._v("PC服务器")]),_._v("：Dell R410，R420，C6100，R710，1950，R720）//几千块钱一个万元以内。")]),_._v(" "),t("li",[_._v("数据多机冗余 （设计到数据同步）")]),_._v(" "),t("li",[_._v("保证高可用性")])])])])])]),_._v(" "),t("h3",{attrs:{id:"_3-4-最佳实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-最佳实践"}},[_._v("#")]),_._v(" 3.4 最佳实践")]),_._v(" "),t("ul",[t("li",[_._v("单个机器： 普通PC服务器\n"),t("ul",[t("li",[_._v("（普通"),t("strong",[_._v("PC服务器")]),_._v("：Dell R410，R420，C6100，R710，1950，R720）")]),_._v(" "),t("li",[_._v("内存型 128GB")]),_._v(" "),t("li",[_._v("硬盘型 SATA → SAS → SSD")]),_._v(" "),t("li",[_._v("CPU型 2.5Hz 16core → 32 core → 64 core → 128core.")]),_._v(" "),t("li",[_._v("在磁盘上做一些Raid，挂载在PC服务器上")])])]),_._v(" "),t("li",[_._v("多机冗余（上面的那种机器）\n"),t("ul",[t("li",[_._v("模块数（就是应用程序）\n"),t("ul",[t("li",[_._v("至少两个节点，取决于吞吐量和单机吞吐量。")])])]),_._v(" "),t("li",[_._v("存储\n"),t("ul",[t("li",[_._v("Master-slave 例如Mysql。读写分离。写在主，读在从。提高性能。")]),_._v(" "),t("li",[_._v("Replic-Sets  例如MongoDb。可自动恢复的MS模式。")])])])])])]),_._v(" "),t("h4",{attrs:{id:"作业：-假设1000w记录-1kb。bmsyql，ssd。假设3kqps-tps。读写比例10：1。问数据库能抗住吗？需要加缓存吗？"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#作业：-假设1000w记录-1kb。bmsyql，ssd。假设3kqps-tps。读写比例10：1。问数据库能抗住吗？需要加缓存吗？"}},[_._v("#")]),_._v(" 作业： 假设1000w记录*1kb。bmsyql，ssd。假设3kqps/TPS。读写比例10：1。问数据库能抗住吗？需要加缓存吗？")]),_._v(" "),t("p",[_._v("QPS：每秒请求次数\nTPS：每秒交易完成次数\n每秒3kQPS =\n主要看写需要每秒多少M。 每秒 3k个请求（DB操作） * 0.1 = 每秒写的请求数 = 300约等。\n每次写一条记录的话 ，每秒写入的数据 = 300 * 1kb = 0.3M/s\n看起来还行啊。估计不是这么算的。")]),_._v(" "),t("p",[_._v("思路：考虑硬件读写速度。300M/s ssd的极限，ssd加上数据库后也就200M/s\n3000qps\n每次读1条数据 3000 * 1 * 1k =3M\n每次读10条数据 3000 * 10 * 1k =30M")]),_._v(" "),t("p",[_._v("不用加缓存。")]),_._v(" "),t("p",[_._v("改善方法：\n单机的话：加缓存\n多机的话：数据库垂直拆分，多机拆分。")]),_._v(" "),t("p",[_._v("https://blog.csdn.net/qq_29347295/article/details/85116229")]),_._v(" "),t("h3",{attrs:{id:"_3-5-思考：企业自己搭建私有云架构还有没有必要，还是统统所有业务都直接上阿里云完事？"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-思考：企业自己搭建私有云架构还有没有必要，还是统统所有业务都直接上阿里云完事？"}},[_._v("#")]),_._v(" 3.5 思考：企业自己搭建私有云架构还有没有必要，还是统统所有业务都直接上阿里云完事？")]),_._v(" "),t("h4",{attrs:{id:"不能上阿里云共有云的："}},[t("a",{staticClass:"header-anchor",attrs:{href:"#不能上阿里云共有云的："}},[_._v("#")]),_._v(" 不能上阿里云共有云的：")]),_._v(" "),t("p",[_._v("需要提供给国家审查的\n自己需要800多个节点的，私有云（openstack）会比公有云便宜\n需要更高性能的时候\n想控制权")]),_._v(" "),t("h4",{attrs:{id:"什么适合放在共有云上"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#什么适合放在共有云上"}},[_._v("#")]),_._v(" 什么适合放在共有云上")]),_._v(" "),t("p",[_._v("不太重要多的研发系统和测试系统\n没有预算的小公司最适合上公有云了。用公有云的Paas或Saas开发点程序就挣钱。\n有钱的公司，且规模需求大的，还是私有云便宜。")]),_._v(" "),t("h4",{attrs:{id:"谁一直在公有云上"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#谁一直在公有云上"}},[_._v("#")]),_._v(" 谁一直在公有云上")]),_._v(" "),t("p",[_._v("初创新公司，从诞生那天开始就在公有云上。他会一直用公有云。也很香。")]),_._v(" "),t("h4",{attrs:{id:"有哪些方案，成本和性能如何"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#有哪些方案，成本和性能如何"}},[_._v("#")]),_._v(" 有哪些方案，成本和性能如何")]),_._v(" "),t("table",[t("thead",[t("tr",[t("th",[_._v("方案")]),_._v(" "),t("th",[_._v("成本")]),_._v(" "),t("th",[_._v("性能")])])]),_._v(" "),t("tbody",[t("tr",[t("td",[_._v("私有云")]),_._v(" "),t("td",[_._v("最高")]),_._v(" "),t("td",[_._v("中")])]),_._v(" "),t("tr",[t("td",[_._v("公有云")]),_._v(" "),t("td",[_._v("居中")]),_._v(" "),t("td",[_._v("高")])]),_._v(" "),t("tr",[t("td",[_._v("ICD")]),_._v(" "),t("td",[_._v("最低")]),_._v(" "),t("td",[_._v("低")])])])]),_._v(" "),t("h4",{attrs:{id:"结论："}},[t("a",{staticClass:"header-anchor",attrs:{href:"#结论："}},[_._v("#")]),_._v(" 结论：")]),_._v(" "),t("p",[_._v("没钱的，直接上公有云。别搞什么私有云。\n有钱，没规模，直接上公有云。\n有钱，规模需求大的，800节点以上，私有云。\n巨私密敏感数据，私有云。\n数据无所为，上公有云。\n既然公有云初级阶段就可以上，测试开发都可以上，所以，一般公司都有公有云。等上规模或做大规模程序节点中多的时候，放到私有云，最后，公司既有公有云又有私有云（混合云），需要更高技术团队来维护。")]),_._v(" "),t("hr"),_._v(" "),t("h2",{attrs:{id:"第四课，dns高可用？自己的dns服务器？"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第四课，dns高可用？自己的dns服务器？"}},[_._v("#")]),_._v(" 第四课，DNS高可用？自己的DNS服务器？")]),_._v(" "),t("p",[_._v("什么是DNS，DNS原理（Domain Name System）\n将域名转换成IP")]),_._v(" "),t("h4",{attrs:{id:"dns服务器：分布式服务器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dns服务器：分布式服务器"}},[_._v("#")]),_._v(" DNS服务器：分布式服务器")]),_._v(" "),t("h4",{attrs:{id:"dns协议："}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dns协议："}},[_._v("#")]),_._v(" DNS协议：")]),_._v(" "),t("ul",[t("li",[_._v("Time to live ：到生效开始的时间")]),_._v(" "),t("li",[_._v("Type\n"),t("ul",[t("li",[_._v("A: ipv4")]),_._v(" "),t("li",[_._v("CNAME ：别名 （另外一个域名）")])])])]),_._v(" "),t("h4",{attrs:{id:"dns解析过程："}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dns解析过程："}},[_._v("#")]),_._v(" DNS解析过程：")]),_._v(" "),t("ul",[t("li",[_._v("首先查找localserver【运营商：电信，联通，移动】")]),_._v(" "),t("li",[_._v("localserver有就直接返回给你，没有就查找rootserver")]),_._v(" "),t("li",[_._v("rootserver返回权威服务器地址")]),_._v(" "),t("li",[_._v("localserver继续查找权威服务器")]),_._v(" "),t("li",[_._v("最后由localserver返回给你地址")])]),_._v(" "),t("h4",{attrs:{id:"域名缓存"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#域名缓存"}},[_._v("#")]),_._v(" 域名缓存")]),_._v(" "),t("p",[_._v("不变化的域名：1周\n不断变化的域名~ip：半小时 （time to live）")]),_._v(" "),t("h4",{attrs:{id:"域名查找工具"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#域名查找工具"}},[_._v("#")]),_._v(" 域名查找工具")]),_._v(" "),t("p",[t("code",[_._v("dig www.baidu.com -t A +short")]),_._v(" //查找域名对应的A记录（ipv4）\n"),t("code",[_._v("dig www.baidu.com +trace")]),_._v(" //从跟域名到自己的域名服务器经过的所有域名服务器")]),_._v(" "),t("hr"),_._v(" "),t("h3",{attrs:{id:"_4-1-传统dns会有什么问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-传统dns会有什么问题"}},[_._v("#")]),_._v(" 4.1 传统DNS会有什么问题")]),_._v(" "),t("ul",[t("li",[t("p",[_._v("2009 巴西银行被DNS劫持，被钓鱼")])]),_._v(" "),t("li",[t("p",[_._v("2010 百度域名被DNS劫持，百度主页访问不了一上午")])]),_._v(" "),t("li",[t("p",[_._v("2012 日本三井银行被DNS劫持，钓鱼攻击，导致800万用户感染病毒")])]),_._v(" "),t("li",[t("p",[_._v("2014年中国顶级域名故障，大部分网站无法访问。有一家公司却可以被访问，他们采用了DNS高可用。使用本地预知IP？")])])]),_._v(" "),t("p",[_._v("损失：")]),_._v(" "),t("ul",[t("li",[t("ol",[t("li",[_._v("经济收入")])])]),_._v(" "),t("li",[t("ol",{attrs:{start:"2"}},[t("li",[_._v("公司形象和品牌形象，股价")])])]),_._v(" "),t("li",[t("ol",{attrs:{start:"3"}},[t("li",[_._v("技术实例的损失")])])])]),_._v(" "),t("h4",{attrs:{id:"_4-1-2-dns劫持：-域名服务器不保证映射是否正确"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-2-dns劫持：-域名服务器不保证映射是否正确"}},[_._v("#")]),_._v(" 4.1.2 DNS劫持： 域名服务器不保证映射是否正确")]),_._v(" "),t("p",[_._v("所以，黑客修改local server把某域名设置成另外一个A记录。\n返回给客户错误的地址。")]),_._v(" "),t("p",[_._v("被黑客恶意修改了数据库。")]),_._v(" "),t("p",[_._v("例如，被竞争对手或流氓软件，引导入别的网页。赚取流量或干脆不让别人访问你的网站。")]),_._v(" "),t("h5",{attrs:{id:"如何查看域名对应的地址呢？"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#如何查看域名对应的地址呢？"}},[_._v("#")]),_._v(" 如何查看域名对应的地址呢？")]),_._v(" "),t("p",[t("code",[_._v("nslookup gitlab.ccbjb.com.cn")]),_._v(" //查看对应域名解析出来的IP")]),_._v(" "),t("h5",{attrs:{id:"看这个ip归属于谁"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#看这个ip归属于谁"}},[_._v("#")]),_._v(" 看这个ip归属于谁")]),_._v(" "),t("ul",[t("li",[_._v("linux\n"),t("code",[_._v("whois 61.135.169.121")]),_._v(" // linux")]),_._v(" "),t("li",[_._v("windows上直接网页查看ip归属\n"),t("img",{attrs:{src:"/docs/images/2020-07-10-10-21-47.png",alt:""}}),_._v("\n如果不是百度的，那就被劫持了。")])]),_._v(" "),t("h4",{attrs:{id:"_4-1-3-dns欺骗"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-3-dns欺骗"}},[_._v("#")]),_._v(" 4.1.3 DNS欺骗")]),_._v(" "),t("p",[_._v("用一个假的DNS应答\n对个人来说，很难发现。运营商来发现这个事情还是比较简单的。")]),_._v(" "),t("p",[_._v("如何发现有没有被DNS欺骗呢？\n1.首先nslookup查看ip拥有方，查ip看ip拥有方。\n和DNS劫持一样")]),_._v(" "),t("hr"),_._v(" "),t("h3",{attrs:{id:"_4-2-dns防止被劫持的手段"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-dns防止被劫持的手段"}},[_._v("#")]),_._v(" 4.2 DNS防止被劫持的手段")]),_._v(" "),t("p",[_._v("数据合法性验证：应用级别的。校验是不是我希望的数据，数据格式的校验。例如，socker包解包的验证码iso8583包。\n监控（同上）：应用接口的返回值和预想的不一样。例如，返回用户列表和以前的不一样或格式都不一样。")]),_._v(" "),t("p",[_._v("解决：商务同学（就是网管）投诉localserver DNS拥有方。")]),_._v(" "),t("p",[_._v("不太可能让用户主动选择DNS服务器的方式，不现实。")]),_._v(" "),t("p",[_._v("DNS解决方案：")]),_._v(" "),t("h4",{attrs:{id:"_4-2-1-直接使用ip地址"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-1-直接使用ip地址"}},[_._v("#")]),_._v(" 4.2.1 直接使用IP地址")]),_._v(" "),t("p",[_._v("不使用域名，不用解析域名。那就需要在客户端预置ip列表。\nDNS服务器有时充当了负载均衡的功能。")]),_._v(" "),t("p",[_._v("直接指定IP之后，负载均衡功能就丢失了，怎么解决呢？\n→：客户端（安卓，ios端）得负责负载均衡。")]),_._v(" "),t("ul",[t("li",[_._v("随机访问某个ip。")])]),_._v(" "),t("h4",{attrs:{id:"_4-2-2-httpdns"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-2-httpdns"}},[_._v("#")]),_._v(" 4.2.2 HttpDns")]),_._v(" "),t("p",[_._v("DNS协议也是http协议。\nDNS协议的端口是53.\n绕过DNS协议，解决运营local DNS劫持问题。")]),_._v(" "),t("p",[_._v("使用HTTP协议来解析域名。\n增加一个HttpDNS服务器。\n万一HttpDns服务器挂了，就用原来的方式DNS协议访问与英商的localDNS服务器。\n"),t("img",{attrs:{src:"/docs/images/2020-07-10-10-39-34.png",alt:""}})]),_._v(" "),t("p",[_._v("好处：")]),_._v(" "),t("ul",[t("li",[_._v("省掉了域名解析的过程。")]),_._v(" "),t("li",[_._v("更安全")])]),_._v(" "),t("p",[_._v("需要引入SDK")]),_._v(" "),t("ul",[t("li",[_._v("在安卓或ios客户端程序上需要特俗的SDK。")])]),_._v(" "),t("h4",{attrs:{id:"_4-1-4-流量劫持"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-4-流量劫持"}},[_._v("#")]),_._v(" 4.1.4 流量劫持")]),_._v(" "),t("ul",[t("li",[_._v("DNS劫持")]),_._v(" "),t("li",[_._v("CDN劫持")]),_._v(" "),t("li",[_._v("网关劫持\n"),t("ul",[t("li",[_._v("随心所欲")]),_._v(" "),t("li",[_._v("HTTPS")]),_._v(" "),t("li",[_._v("SSL")]),_._v(" "),t("li",[_._v("加密")])])])]),_._v(" "),t("p",[_._v("→ 尽量https机密")]),_._v(" "),t("hr"),_._v(" "),t("h3",{attrs:{id:"_4-3-高可用dns如何设计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-高可用dns如何设计"}},[_._v("#")]),_._v(" 4.3 高可用DNS如何设计")]),_._v(" "),t("ul",[t("li",[_._v("移动方向\n"),t("ul",[t("li",[_._v("选用httpDNS")]),_._v(" "),t("li",[_._v("基于IP地址直连")])])]),_._v(" "),t("li",[_._v("其它方向\n"),t("ul",[t("li",[_._v("使用IP地址直连")]),_._v(" "),t("li",[_._v("监控\n"),t("ul",[t("li",[_._v("nslookup")]),_._v(" "),t("li",[_._v("投诉联通你dns被篡改了。")]),_._v(" "),t("li",[_._v("传统DSN监控，及时报警")])])])])])]),_._v(" "),t("hr"),_._v(" "),t("h3",{attrs:{id:"_4-4-高可用dns最佳实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-高可用dns最佳实践"}},[_._v("#")]),_._v(" 4.4 高可用DNS最佳实践")]),_._v(" "),t("h4",{attrs:{id:"_4-4-1-案例1：im"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-1-案例1：im"}},[_._v("#")]),_._v(" 4.4.1 案例1：IM")]),_._v(" "),t("p",[_._v("需要TCP长连接")]),_._v(" "),t("p",[_._v("传统DNS就不能满足要求了。每次随机一个IP")]),_._v(" "),t("p",[_._v("DNS解析优化：\n"),t("img",{attrs:{src:"/docs/images/2020-07-10-10-58-37.png",alt:""}})]),_._v(" "),t("p",[_._v("客户第一次，通过域名拉取iplist\n以后就不访问了。\n如果DNS被劫持，就通过iplist来访问。")]),_._v(" "),t("p",[_._v("问题：")]),_._v(" "),t("ul",[t("li",[_._v("复杂均衡问题\n"),t("ul",[t("li",[_._v("APP随机选择ip-list中的一个即可。")])])]),_._v(" "),t("li",[_._v("扩容nginx增加一个后端服务器，没有影响。如果不用nginx，怎么水平扩容，增加一个ip\n"),t("ul",[t("li",[_._v("在httpsDns服务器上增加一个ip")])])]),_._v(" "),t("li",[_._v("每次都访问iplist，费流量也容易被劫持\n"),t("ul",[t("li",[_._v("增加httpsDns的iplist版本号，本地和服务器上iplist对比版本号（时间戳）。一样就不拉取。不一样就拉取。")]),_._v(" "),t("li",[_._v("省流量，省电量。")])])]),_._v(" "),t("li",[_._v("nginx不好做异构服务器的负载均衡。但iplist可以增加一个权重。app随机ip的时候，用权重来随机ip。类似抽选。")])]),_._v(" "),t("h4",{attrs:{id:"_4-4-2-案例2：流量劫持，应用中插入东西"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-2-案例2：流量劫持，应用中插入东西"}},[_._v("#")]),_._v(" 4.4.2 案例2：流量劫持，应用中插入东西")]),_._v(" "),t("p",[_._v("流量劫持")]),_._v(" "),t("p",[_._v("A公司的手机APP上，出现了别的公司的广告。\n"),t("img",{attrs:{src:"/docs/images/2020-07-10-11-28-08.png",alt:""}})]),_._v(" "),t("p",[_._v("hacker注入了广告。转包给你。")]),_._v(" "),t("h4",{attrs:{id:"_4-4-3-案例3：链路修改，把你的请求修改掉"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-3-案例3：链路修改，把你的请求修改掉"}},[_._v("#")]),_._v(" 4.4.3 案例3：链路修改，把你的请求修改掉")]),_._v(" "),t("p",[t("img",{attrs:{src:"/docs/images/2020-07-10-14-13-02.png",alt:""}})]),_._v(" "),t("p",[_._v("复制一份请求出来，发一个reset请求，到服务端，关掉服务，于是hacker拿到请求控制权，\n返回给你任意消息。")]),_._v(" "),t("ol",[t("li",[_._v("通过某个网关，复制一个请求。")]),_._v(" "),t("li",[_._v("发送reset请求给服务器")]),_._v(" "),t("li",[_._v("给你发随意的字符串")])]),_._v(" "),t("h4",{attrs:{id:"_4-4-4-【作业】在应用层是否能被修改？"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-4-【作业】在应用层是否能被修改？"}},[_._v("#")]),_._v(" 4.4.4 【作业】在应用层是否能被修改？")]),_._v(" "),t("hr"),_._v(" "),t("h2",{attrs:{id:"第五课-cdn加速系统"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第五课-cdn加速系统"}},[_._v("#")]),_._v(" 第五课 CDN加速系统")]),_._v(" "),t("p",[_._v("CDN： content delivery network ，内容分发网络。\nOrigin：你的源站点。\n加速站点：从Origin拷贝静态文本。")]),_._v(" "),t("p",[_._v("一般缓存静态资源，永远不会变化的资源。\ncss，html，image")]),_._v(" "),t("h3",{attrs:{id:"_5-1-cdn技术点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-cdn技术点"}},[_._v("#")]),_._v(" 5.1 CDN技术点")]),_._v(" "),t("p",[_._v("CDN架构：\n"),t("img",{attrs:{src:"/docs/images/2020-07-10-14-26-10.png",alt:""}})]),_._v(" "),t("p",[_._v("先走传统DNS，localserver返回CDN CName，访问CDN。\n经过全局CDN节点平衡器。获得CDN的IP\n获取最优的CDN节点IP。返回给用户，用户范围该CDN节点获得内容。")]),_._v(" "),t("p",[_._v("CDN没有内容，就访问origin\nCDN有内容，就返回内容。")]),_._v(" "),t("h4",{attrs:{id:"架构的概念"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#架构的概念"}},[_._v("#")]),_._v(" 架构的概念")]),_._v(" "),t("ul",[t("li",[_._v("全局负载均衡器")]),_._v(" "),t("li",[_._v("局部负载均衡器")]),_._v(" "),t("li",[_._v("CDN节点")])]),_._v(" "),t("h4",{attrs:{id:"cdn也是很多机器，很多内容。"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#cdn也是很多机器，很多内容。"}},[_._v("#")]),_._v(" CDN也是很多机器，很多内容。")]),_._v(" "),t("ul",[t("li",[_._v("内容的监控机制。")]),_._v(" "),t("li",[_._v("内容的缓存和存储")]),_._v(" "),t("li",[_._v("源内容存储：\n"),t("ul",[t("li",[_._v("用分布式存储系统，因为存储的内容比较多。")])])]),_._v(" "),t("li",[_._v("CDN内容存储：\n"),t("ul",[t("li",[_._v("支持各种格式")]),_._v(" "),t("li",[_._v("缓存命中率高")]),_._v(" "),t("li",[_._v("可靠性")]),_._v(" "),t("li",[_._v("稳定性")])])]),_._v(" "),t("li",[_._v("CDN内容管理：\n"),t("ul",[t("li",[_._v("提高存储利用率")]),_._v(" "),t("li",[_._v("CDN本地内容索引")]),_._v(" "),t("li",[_._v("CDN本地内容拷贝（主从）")]),_._v(" "),t("li",[_._v("CDN本地内容访问状态信息收集")])])])]),_._v(" "),t("p",[_._v("（没有深入展开）")]),_._v(" "),t("h4",{attrs:{id:"内容分发：-源服务器怎么放到cdn"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#内容分发：-源服务器怎么放到cdn"}},[_._v("#")]),_._v(" 内容分发： 源服务器怎么放到CDN")]),_._v(" "),t("ol",[t("li",[t("p",[_._v("方法1 ：主动分发 Origin push to CDN\n有改动就主动同步数据到CDN")])]),_._v(" "),t("li",[t("p",[_._v("方法2：被动拉取 CDN pull from Origin\n用户请求CDN，没有内容，就从Origin获得并缓存起来。")])])]),_._v(" "),t("h4",{attrs:{id:"cdn的路由"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#cdn的路由"}},[_._v("#")]),_._v(" CDN的路由")]),_._v(" "),t("p",[_._v("路由把请求分配到对这个用户来说的最佳节点\n离用户最近\nCDN节点的负载比较低")]),_._v(" "),t("p",[_._v("所以，第一，全局的负载均衡器。\n第二，本地的负载均衡器。")]),_._v(" "),t("p",[_._v("负责路由和分发。")]),_._v(" "),t("h5",{attrs:{id:"实现方式："}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实现方式："}},[_._v("#")]),_._v(" 实现方式：")]),_._v(" "),t("ul",[t("li",[_._v("DNS")]),_._v(" "),t("li",[_._v("应用层重定向")]),_._v(" "),t("li",[_._v("数据层重定向")])]),_._v(" "),t("h4",{attrs:{id:"关键技术"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#关键技术"}},[_._v("#")]),_._v(" 关键技术")]),_._v(" "),t("ul",[t("li",[_._v("索引建立")]),_._v(" "),t("li",[_._v("缓存，")]),_._v(" "),t("li",[_._v("推送，")]),_._v(" "),t("li",[_._v("组播技术")])]),_._v(" "),t("h5",{attrs:{id:"协作式推送技术"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#协作式推送技术"}},[_._v("#")]),_._v(" 协作式推送技术")]),_._v(" "),t("ul",[t("li",[_._v("CDN节点上数据共享")]),_._v(" "),t("li",[_._v("避免了复制和更新的成本")]),_._v(" "),t("li",[_._v("CDN维护CDN节点与源内容的映射表")]),_._v(" "),t("li",[_._v("源主动推送内容给CDN")])]),_._v(" "),t("h5",{attrs:{id:"非协作式拉取技术"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#非协作式拉取技术"}},[_._v("#")]),_._v(" 非协作式拉取技术")]),_._v(" "),t("ul",[t("li",[_._v("重定向到最近的CDN")]),_._v(" "),t("li",[_._v("有内容返回")]),_._v(" "),t("li",[_._v("没内容向Orign请求内容")])]),_._v(" "),t("h5",{attrs:{id:"协作式拉取技术"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#协作式拉取技术"}},[_._v("#")]),_._v(" 协作式拉取技术")]),_._v(" "),t("ul",[t("li",[_._v("用户重定向到最近的CDN节点")]),_._v(" "),t("li",[_._v("有内容返回")]),_._v(" "),t("li",[_._v("没内容向其它CDN请求内容")]),_._v(" "),t("li",[_._v("其它CDN没内容，再想ORigin请求")]),_._v(" "),t("li",[_._v("减少了Origin带宽")]),_._v(" "),t("li",[_._v("现在还不成熟")])]),_._v(" "),t("h3",{attrs:{id:"_5-2-为什么使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-为什么使用"}},[_._v("#")]),_._v(" 5.2 为什么使用")]),_._v(" "),t("ul",[t("li",[t("p",[_._v("加速请求静态资源")])]),_._v(" "),t("li",[t("p",[_._v("缓解Origin访问压力")])]),_._v(" "),t("li",[t("p",[_._v("解决了跨地区跨运营商速度慢的问题。")]),_._v(" "),t("ul",[t("li",[_._v("Origin在北京。用户在广州。没有CDN需要很长的链路才能走到。")]),_._v(" "),t("li",[_._v("用了CDN，离用户很近。就不用那么长链路了。")])])]),_._v(" "),t("li",[t("p",[_._v("突然迸发的流量")]),_._v(" "),t("ul",[t("li",[_._v("例如618，1111. 会弄挂Origin")]),_._v(" "),t("li",[_._v("CDN能解决一些问题。")])])]),_._v(" "),t("li",[t("p",[_._v("合理利用互联网资源")]),_._v(" "),t("ul",[t("li",[_._v("在放点别的资源到CDN")])])]),_._v(" "),t("li",[t("p",[_._v("防止单点故障")]),_._v(" "),t("ul",[t("li",[_._v("当然Orign不可能是单点。")]),_._v(" "),t("li",[_._v("就算Orign会挂，你还能访问CDN")])])]),_._v(" "),t("li",[t("p",[_._v("CDN统计了用户反问信息。")]),_._v(" "),t("ul",[t("li",[_._v("统计了用户行为。")])])]),_._v(" "),t("li",[t("p",[_._v("防止黑客攻击 ，why？ DDOS")]),_._v(" "),t("ul",[t("li",[_._v("没有CDN，所有请求就到Orign")]),_._v(" "),t("li",[_._v("有CDN，CDN多节点能平均分配Orign。降低了DDoS攻击的强度。")])])]),_._v(" "),t("li",[t("p",[_._v("还可以对直播 做CDN ？\n"),t("font",{attrs:{color:"red"}},[_._v("直播呀！！！")])],1)]),_._v(" "),t("li",[t("p",[_._v("对中小企业租用虚拟服务器慢的问题")]),_._v(" "),t("ul",[t("li",[_._v("虚拟机")]),_._v(" "),t("li",[_._v("云主机公用")]),_._v(" "),t("li",[_._v("加速访问")])])]),_._v(" "),t("li",[t("p",[_._v("解决加速问题")]),_._v(" "),t("ul",[t("li",[_._v("静态图片")]),_._v(" "),t("li",[_._v("静态文本")]),_._v(" "),t("li",[_._v("静态视频")])])])]),_._v(" "),t("h3",{attrs:{id:"_5-3-发展历史"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-发展历史"}},[_._v("#")]),_._v(" 5.3 发展历史")]),_._v(" "),t("p",[_._v("三代：最早源与代理服务器，服务器集群技术。")]),_._v(" "),t("p",[_._v("第一代，静态内容加速\n第二代，视频也可以加速了\n第三代，基于社团（一些共享协作）的CDN")]),_._v(" "),t("h3",{attrs:{id:"_5-4-国内应用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-国内应用"}},[_._v("#")]),_._v(" 5.4 国内应用")]),_._v(" "),t("ul",[t("li",[_._v("大型网站\n"),t("ul",[t("li",[_._v("自建CDN")]),_._v(" "),t("li",[_._v("BAT、京东")])])]),_._v(" "),t("li",[_._v("中小型网站\n"),t("ul",[t("li",[_._v("第三方合作（要求的质量没有那么高）")]),_._v(" "),t("li",[_._v("蓝X，网易，世纪华联")])])]),_._v(" "),t("li",[_._v("小网站\n"),t("ul",[t("li",[_._v("不用CDN")])])])]),_._v(" "),t("p",[_._v("L1-cache：最核心，最访问频繁的 80%的数据量。但是站整个量的10%\nL2-Cache：次核心的数据。站总量的10%。\n最热点最核心的数据放到最外层。\n"),t("img",{attrs:{src:"/docs/images/2020-07-10-15-01-45.png",alt:""}})]),_._v(" "),t("hr"),_._v(" "),t("h3",{attrs:{id:"_5-5-应用领域"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-5-应用领域"}},[_._v("#")]),_._v(" 5.5 应用领域")]),_._v(" "),t("h4",{attrs:{id:"互联网应用："}},[t("a",{staticClass:"header-anchor",attrs:{href:"#互联网应用："}},[_._v("#")]),_._v(" 互联网应用：")]),_._v(" "),t("ul",[t("li",[_._v("流媒体应用\n"),t("ul",[t("li",[_._v("视频点播。录好视频放到某个点")]),_._v(" "),t("li",[_._v("视频直播。通过CDN来做。网红直播。推流到CDN上。")])])]),_._v(" "),t("li",[_._v("大文件下载\n"),t("ul",[t("li",[_._v("图片，视频，文件")])])]),_._v(" "),t("li",[_._v("门户网站→社交网站\n"),t("ul",[t("li",[_._v("QQ，默默")])])]),_._v(" "),t("li",[_._v("电商网站\n"),t("ul",[t("li",[_._v("商品详情")]),_._v(" "),t("li",[_._v("商品描述")]),_._v(" "),t("li",[_._v("商品图片")])])])]),_._v(" "),t("h4",{attrs:{id:"cdn业务升级"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#cdn业务升级"}},[_._v("#")]),_._v(" CDN业务升级")]),_._v(" "),t("ul",[t("li",[_._v("性能提升")]),_._v(" "),t("li",[_._v("数据智能调整")]),_._v(" "),t("li",[_._v("流量管理")]),_._v(" "),t("li",[_._v("负载均衡")])]),_._v(" "),t("h4",{attrs:{id:"视频服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#视频服务"}},[_._v("#")]),_._v(" 视频服务")]),_._v(" "),t("ul",[t("li",[_._v("最关键的服务之一。2005年就开始了。")]),_._v(" "),t("li",[_._v("允许下载和上传视频")])]),_._v(" "),t("h4",{attrs:{id:"iptv三网融合"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#iptv三网融合"}},[_._v("#")]),_._v(" IPTV三网融合")]),_._v(" "),t("ul",[t("li",[_._v("2005三网融合")]),_._v(" "),t("li",[_._v("运营商发展视频")])]),_._v(" "),t("h4",{attrs:{id:"流媒体对传统网络冲击"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#流媒体对传统网络冲击"}},[_._v("#")]),_._v(" 流媒体对传统网络冲击")]),_._v(" "),t("ul",[t("li",[_._v("CDN保证Oos")]),_._v(" "),t("li",[_._v("环节流媒体对主干网络冲击")])]),_._v(" "),t("h4",{attrs:{id:"适用场合："}},[t("a",{staticClass:"header-anchor",attrs:{href:"#适用场合："}},[_._v("#")]),_._v(" 适用场合：")]),_._v(" "),t("ul",[t("li",[t("p",[_._v("静态内容加速和分布")]),_._v(" "),t("ul",[t("li",[_._v("动态内容静态化\n"),t("ul",[t("li",[_._v("页面，脚本")])])]),_._v(" "),t("li",[_._v("静态内容和动态内容分离\n"),t("ul",[t("li",[_._v("静态图片")]),_._v(" "),t("li",[_._v("动态数据")])])])])]),_._v(" "),t("li",[t("p",[_._v("页面 html，html，shtml")])]),_._v(" "),t("li",[t("p",[_._v("图片")])]),_._v(" "),t("li",[t("p",[_._v("流媒体：mp4等")])]),_._v(" "),t("li",[t("p",[_._v("脚本 ：css，xml")])]),_._v(" "),t("li",[t("p",[_._v("Apps，安装包。")])])]),_._v(" "),t("hr"),_._v(" "),t("h3",{attrs:{id:"_5-6-数据一致性"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-6-数据一致性"}},[_._v("#")]),_._v(" 5.6 数据一致性")]),_._v(" "),t("h4",{attrs:{id:"分发方式："}},[t("a",{staticClass:"header-anchor",attrs:{href:"#分发方式："}},[_._v("#")]),_._v(" 分发方式：")]),_._v(" "),t("ul",[t("li",[_._v("主动分发：\n"),t("ul",[t("li",[_._v("分发控制器去源站抓取")]),_._v(" "),t("li",[_._v("提供用户上传接口")]),_._v(" "),t("li",[_._v("不存在数据不一致问题")])])]),_._v(" "),t("li",[_._v("被动抓取\n"),t("ul",[t("li",[_._v("缓存更新不及时")]),_._v(" "),t("li",[_._v("数据不一致问题")]),_._v(" "),t("li",[_._v("设置缓存失效时间\n"),t("ul",[t("li",[_._v("2个小时")]),_._v(" "),t("li",[_._v("能解决最终一致性问题")]),_._v(" "),t("li",[_._v("可能会出现2个小时脏数据")]),_._v(" "),t("li",[_._v("强一致：还是要主动分发来解决")]),_._v(" "),t("li",[_._v("或缩小缓存缩小时间")]),_._v(" "),t("li",[_._v("或增加数据版本号。\n"),t("ul",[t("li",[_._v("版本号低了就去pull。")])])])])])])])]),_._v(" "),t("hr"),_._v(" "),t("h3",{attrs:{id:"_5-7-实践案例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-7-实践案例"}},[_._v("#")]),_._v(" 5.7 实践案例")]),_._v(" "),t("h4",{attrs:{id:"cdn选择："}},[t("a",{staticClass:"header-anchor",attrs:{href:"#cdn选择："}},[_._v("#")]),_._v(" CDN选择：")]),_._v(" "),t("ul",[t("li",[_._v("第三方合作")]),_._v(" "),t("li",[_._v("腾讯")])]),_._v(" "),t("h4",{attrs:{id:"cdn高可用保证"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#cdn高可用保证"}},[_._v("#")]),_._v(" CDN高可用保证")]),_._v(" "),t("ul",[t("li",[_._v("版本号控制")]),_._v(" "),t("li",[_._v("图片，每次上传图片不同url不同。")]),_._v(" "),t("li",[_._v("Apps分发\n"),t("ul",[t("li",[_._v("版本号控制")]),_._v(" "),t("li",[_._v("错峰分发\n"),t("ul",[t("li",[_._v("保证了CDN带宽")]),_._v(" "),t("li",[_._v("客户端随机一段事件sleep 再去访问。")])])]),_._v(" "),t("li",[_._v("多种渠道App分发\n"),t("ul",[t("li",[_._v("几百个渠道")]),_._v(" "),t("li",[_._v("Apps包一样，需要区分渠道号")]),_._v(" "),t("li",[_._v("点击下载js动态获取渠道号，下载对应渠道号App版本")])])])])])]),_._v(" "),t("hr"),_._v(" "),t("h2",{attrs:{id:"第六课"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第六课"}},[_._v("#")]),_._v(" 第六课")]),_._v(" "),t("h3",{attrs:{id:"_6-1-互联网产品通用架构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-互联网产品通用架构"}},[_._v("#")]),_._v(" 6.1 互联网产品通用架构")]),_._v(" "),t("p",[t("img",{attrs:{src:"/docs/images/2020-07-10-17-15-06.png",alt:""}})]),_._v(" "),t("h4",{attrs:{id:"百度某应用："}},[t("a",{staticClass:"header-anchor",attrs:{href:"#百度某应用："}},[_._v("#")]),_._v(" 百度某应用：")]),_._v(" "),t("ul",[t("li",[t("p",[_._v("front：")]),_._v(" "),t("ul",[t("li",[_._v("web server")]),_._v(" "),t("li",[_._v("app server")])])]),_._v(" "),t("li",[t("p",[_._v("backend")]),_._v(" "),t("ul",[t("li",[_._v("ui 接入层\n"),t("ul",[t("li",[_._v("验证身份")]),_._v(" "),t("li",[_._v("转发请求")]),_._v(" "),t("li",[_._v("接受logic再返回给front")])])]),_._v(" "),t("li",[_._v("logic")]),_._v(" "),t("li",[_._v("DB，cache")])])])]),_._v(" "),t("h4",{attrs:{id:"im"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#im"}},[_._v("#")]),_._v(" IM")]),_._v(" "),t("ul",[t("li",[_._v("请求同时在线100W+")]),_._v(" "),t("li",[_._v("机器：百台+")]),_._v(" "),t("li",[_._v("Java/CPP")]),_._v(" "),t("li",[_._v("定位：传统IM")]),_._v(" "),t("li",[_._v("核心功能：\n"),t("ul",[t("li",[_._v("用户关系")]),_._v(" "),t("li",[_._v("添加好友")]),_._v(" "),t("li",[_._v("发送消息")])])])]),_._v(" "),t("p",[t("img",{attrs:{src:"/docs/images/2020-07-10-17-20-28.png",alt:""}})]),_._v(" "),t("p",[_._v("接入层和webim建立长连接的请求。\n号称百万的长连接。")]),_._v(" "),t("p",[_._v("A用户要发消息给B\nA→路由层（用户这次请求的状态信息，ip等）→接入层→B")]),_._v(" "),t("ul",[t("li",[t("p",[_._v("无状态设计，每一层都不存储状态。")])]),_._v(" "),t("li",[t("p",[_._v("每层模块动态高扩展")])]),_._v(" "),t("li",[t("p",[_._v("模块冗余，高可用性保证")])]),_._v(" "),t("li",[t("p",[_._v("动态负载均衡，动态切换可用服务节点")])]),_._v(" "),t("li",[t("p",[_._v("优化效果")]),_._v(" "),t("ul",[t("li",[t("p",[_._v("单机支持50W在线")])]),_._v(" "),t("li",[t("p",[_._v("单机线上3w+qps\n（每秒三万多请求）")])])])])]),_._v(" "),t("h4",{attrs:{id:"转转："}},[t("a",{staticClass:"header-anchor",attrs:{href:"#转转："}},[_._v("#")]),_._v(" 转转：")]),_._v(" "),t("p",[_._v("定位：电商，二手交易平台")]),_._v(" "),t("ul",[t("li",[_._v("用户管理")]),_._v(" "),t("li",[_._v("商品管理")]),_._v(" "),t("li",[_._v("社交：留言，评论，聊天")]),_._v(" "),t("li",[_._v("交易")]),_._v(" "),t("li",[_._v("圈子")]),_._v(" "),t("li",[_._v("推荐")]),_._v(" "),t("li",[_._v("搜索")]),_._v(" "),t("li",[_._v("运营")])]),_._v(" "),t("p",[t("img",{attrs:{src:"/docs/images/2020-07-10-18-32-04.png",alt:""}})]),_._v(" "),t("h4",{attrs:{id:"百度feed系统"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#百度feed系统"}},[_._v("#")]),_._v(" 百度feed系统")]),_._v(" "),t("p",[_._v("好友动态")]),_._v(" "),t("p",[_._v("获取好友的feed")]),_._v(" "),t("p",[_._v("组合好友的feed聚类展示")]),_._v(" "),t("p",[_._v("按照时间倒叙展示")]),_._v(" "),t("p",[_._v("push or pull")]),_._v(" "),t("ul",[t("li",[_._v("pull")])]),_._v(" "),t("hr"),_._v(" "),t("h3",{attrs:{id:"_6-2-接入层作用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-接入层作用"}},[_._v("#")]),_._v(" 6.2 接入层作用")]),_._v(" "),t("p",[_._v("接入层：")]),_._v(" "),t("ul",[t("li",[_._v("管理客户端http/tcp连接")]),_._v(" "),t("li",[_._v("数据合法性校验")]),_._v(" "),t("li",[_._v("建立加密通道")]),_._v(" "),t("li",[_._v("整合少量长连接")]),_._v(" "),t("li",[_._v("session管理")]),_._v(" "),t("li",[_._v("初步的攻防（长久不发消息就回收连接）")]),_._v(" "),t("li",[_._v("转发到逻辑层")])]),_._v(" "),t("hr"),_._v(" "),t("h3",{attrs:{id:"_6-3-接入层session设计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-接入层session设计"}},[_._v("#")]),_._v(" 6.3 接入层Session设计")]),_._v(" "),t("ul",[t("li",[_._v("session是什么：请求读取的上下文。")]),_._v(" "),t("li",[_._v("高可用是基于服务无状态")]),_._v(" "),t("li",[_._v("显示中业务都是有状态的。都得放到session。就是有状态了。\n"),t("ul",[t("li",[_._v("都得记录用户信息")]),_._v(" "),t("li",[_._v("记录用户的购物车信息")]),_._v(" "),t("li",[_._v("这些信息随着用户操作而变化")])])]),_._v(" "),t("li",[_._v("这怎么办呢？")])]),_._v(" "),t("h5",{attrs:{id:"单机环境设计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#单机环境设计"}},[_._v("#")]),_._v(" 单机环境设计")]),_._v(" "),t("ul",[t("li",[_._v("单机不存在session共享问题")]),_._v(" "),t("li",[_._v("处理比较简单")]),_._v(" "),t("li",[_._v("sessin放在本机内存")]),_._v(" "),t("li",[_._v("高可用无法保证\n"),t("ul",[t("li",[_._v("服务进程挂掉")]),_._v(" "),t("li",[_._v("宕机")]),_._v(" "),t("li",[_._v("session丢失，不可用")])])]),_._v(" "),t("li",[_._v("怎么搞？？？？？？")])]),_._v(" "),t("h5",{attrs:{id:"集群设计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#集群设计"}},[_._v("#")]),_._v(" 集群设计")]),_._v(" "),t("h6",{attrs:{id:"session复制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#session复制"}},[_._v("#")]),_._v(" session复制")]),_._v(" "),t("ul",[t("li",[_._v("集群所有节点的接入层服务器之间同步session数据")]),_._v(" "),t("li",[_._v("每台都保存全量session数据")]),_._v(" "),t("li",[_._v("用户请求只需要访问其中一台，读取数据最快")]),_._v(" "),t("li",[_._v("高可用邦长\n"),t("ul",[t("li",[_._v("部分机器宕机，没影响")])])])]),_._v(" "),t("p",[_._v("负载均衡→session共享→接入层（多台），复制session")]),_._v(" "),t("h6",{attrs:{id:"session复制的问题："}},[t("a",{staticClass:"header-anchor",attrs:{href:"#session复制的问题："}},[_._v("#")]),_._v(" session复制的问题：")]),_._v(" "),t("ul",[t("li",[_._v("占用cpu和网络资源")]),_._v(" "),t("li",[_._v("所以适合接入层集群比较少的")]),_._v(" "),t("li",[_._v("存储全量信息对内存占用比较大")]),_._v(" "),t("li",[_._v("对大量集群（千台，几千台）经常会内存不足。session复制就不合适。")])]),_._v(" "),t("h6",{attrs:{id:"session绑定"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#session绑定"}},[_._v("#")]),_._v(" session绑定")]),_._v(" "),t("ul",[t("li",[_._v("一个用户的信息，只存在一台机器上，再复制到另一个台上。master-slave")]),_._v(" "),t("li",[_._v("根据就用户请求（UID）HashID")]),_._v(" "),t("li",[_._v("特定用户请求路由到特定接入层设备")]),_._v(" "),t("li",[_._v("部分网站使用")]),_._v(" "),t("li",[_._v("高可用如何保证\n"),t("ul",[t("li",[_._v("单点问题是存在的。但可以用下列方式解决：\n"),t("ul",[t("li",[_._v("复制机制 来解决单点问题，例如，写完一台之后复制到了另外一台")])])])])])]),_._v(" "),t("h6",{attrs:{id:"session-保存到客户端"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#session-保存到客户端"}},[_._v("#")]),_._v(" session 保存到客户端")]),_._v(" "),t("ul",[t("li",[_._v("客户端保持session存储到客户端\n"),t("ul",[t("li",[_._v("每次请求携带客户端session")]),_._v(" "),t("li",[_._v("服务端更新后送回客户端保存session")]),_._v(" "),t("li",[_._v("c/s\n"),t("ul",[t("li",[_._v("aoos\n"),t("ul",[t("li",[_._v("记录到native中（sqllist）")])])])])]),_._v(" "),t("li",[_._v("b/s\n"),t("ul",[t("li",[_._v("web")]),_._v(" "),t("li",[_._v("记录到cookie")])])])])]),_._v(" "),t("li",[_._v("这种方式，接入层不再保存任何session信息。")]),_._v(" "),t("li",[_._v("问题：\n"),t("ul",[t("li",[_._v("webcookie记录信息大小限制，例如100KB")]),_._v(" "),t("li",[_._v("每次都要传输session，流量性能收影响")]),_._v(" "),t("li",[_._v("用户关闭，清理session时用户请求不正常")])])]),_._v(" "),t("li",[_._v("好处：\n"),t("ul",[t("li",[_._v("方案简单，支持服务端无缝伸缩")]),_._v(" "),t("li",[_._v("方案可用性高。")]),_._v(" "),t("li",[_._v("较多网站都有使用"),t("br"),_._v("\n结论：这总方法也不好")])])])]),_._v(" "),t("h6",{attrs:{id:"session高可用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#session高可用"}},[_._v("#")]),_._v(" session高可用")]),_._v(" "),t("ul",[t("li",[_._v("接入层无状态话")]),_._v(" "),t("li",[_._v("统一的高可用session服务器")]),_._v(" "),t("li",[_._v("接入层分布式读写session集群")]),_._v(" "),t("li",[_._v("状态分离\n"),t("ul",[t("li",[_._v("**接入层本身无状态")]),_._v(" "),t("li",[_._v("session集群有状态**\n"),t("ul",[t("li",[_._v("nosql（memcached/redis）")]),_._v(" "),t("li",[_._v("rdbms（mysql/mongoDB）\n（\n接入层都是无状态\nsession 绑定方式的寻服务器方式,用户ID hash来寻找服务器\nsession 集群，三个节点以上，每个节点包含一个master机器和slave机器\nSM1 + SM2 + SM3 + ...\n）")])])])])])]),_._v(" "),t("hr"),_._v(" "),t("h3",{attrs:{id:"_6-4-接入层数据安全"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-接入层数据安全"}},[_._v("#")]),_._v(" 6.4 接入层数据安全")]),_._v(" "),t("h4",{attrs:{id:"_1-传输的数据解密"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-传输的数据解密"}},[_._v("#")]),_._v(" 1. 传输的数据解密")]),_._v(" "),t("h6",{attrs:{id:"https"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#https"}},[_._v("#")]),_._v(" https")]),_._v(" "),t("ul",[t("li",[_._v("单项加密：\n"),t("ul",[t("li",[_._v("不安全，")]),_._v(" "),t("li",[_._v("中间人攻击")])])]),_._v(" "),t("li",[t("strong",[_._v("双向加密")]),_._v("：\n"),t("ul",[t("li",[_._v("安全")])])]),_._v(" "),t("li",[_._v("客户端证书\n"),t("ul",[t("li",[_._v("配合")])])])]),_._v(" "),t("h6",{attrs:{id:"接口分级"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#接口分级"}},[_._v("#")]),_._v(" 接口分级")]),_._v(" "),t("ul",[t("li",[_._v("https")]),_._v(" "),t("li",[_._v("https + 短信验证")])]),_._v(" "),t("h4",{attrs:{id:"_2-连接的通道加密"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-连接的通道加密"}},[_._v("#")]),_._v(" 2. 连接的通道加密")]),_._v(" "),t("p",[_._v("解决客户端和服务端加密，有个适合一切客户端你的方法：")]),_._v(" "),t("p",[_._v("先解释名词：")]),_._v(" "),t("ul",[t("li",[_._v("对称加密：加密和解密是同一个密钥，ASE")]),_._v(" "),t("li",[_._v("非对称加密：加密和解密使用一对密钥，RSA")]),_._v(" "),t("li",[_._v("公钥： 给别人加密用")]),_._v(" "),t("li",[_._v("私钥：解密用")])]),_._v(" "),t("h5",{attrs:{id:"技术实现方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#技术实现方案"}},[_._v("#")]),_._v(" 技术实现方案")]),_._v(" "),t("ul",[t("li",[t("p",[_._v("客户端-服务端所有请求都得加密。")]),_._v(" "),t("ul",[t("li",[_._v("加密效率低\n"),t("ul",[t("li",[_._v("采用对称加密")]),_._v(" "),t("li",[_._v("对称密钥怎么生成？\n"),t("ul",[t("li",[_._v("使用非对称加密算法两次协商确定")])])])])]),_._v(" "),t("li",[_._v("安全信道必须满足\n"),t("ul",[t("li",[_._v("第三方无法伪造服务器")]),_._v(" "),t("li",[_._v("截获了也无法解密")])])])])]),_._v(" "),t("li",[t("p",[_._v("具体怎么做呢？")]),_._v(" "),t("ul",[t("li",[_._v("客户、服务端都必须有随机生成密钥的过程")]),_._v(" "),t("li",[t("strong",[_._v("四步握手")]),_._v(" "),t("img",{attrs:{src:"/docs/images/2020-07-10-22-41-21.png",alt:""}})])])]),_._v(" "),t("li",[t("p",[_._v("写死在代码中的公钥0（公钥池，每次选一个）")]),_._v(" "),t("ul",[t("li",[_._v("就是多用不同公钥传输几次，最后把key传给客户端")])])])]),_._v(" "),t("h3",{attrs:{id:"_6-5-接入层数据正确性"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-5-接入层数据正确性"}},[_._v("#")]),_._v(" 6.5 接入层数据正确性")]),_._v(" "),t("ul",[t("li",[_._v("数据明问题")]),_._v(" "),t("li",[_._v("截获也没有用")]),_._v(" "),t("li",[_._v("但是：数据篡改无法避免")]),_._v(" "),t("li",[_._v("数据正确性需要保证\n"),t("ul",[t("li",[_._v("如何保证？\n"),t("ul",[t("li",[t("strong",[_._v("数字签名")]),_._v("，对数据签名")]),_._v(" "),t("li",[_._v("md5或者更复杂的签名方法")])])]),_._v(" "),t("li",[_._v("过程\n"),t("ul",[t("li",[_._v("客户端月订签名")]),_._v(" "),t("li",[_._v("服务端生成md5验证码")]),_._v(" "),t("li",[_._v("一致ok，不一致，说明被篡改。")])])])])])]),_._v(" "),t("p",[_._v("例如，双方才知道的key，必须保密")]),_._v(" "),t("p",[_._v("核心：模块和数据分离。模块成无状态。就能动态伸缩。\n状态（session）同一分布式存储\n数据冗余保证")]),_._v(" "),t("h3",{attrs:{id:"_6-6-接入层高可用设计方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-6-接入层高可用设计方案"}},[_._v("#")]),_._v(" 6.6 接入层高可用设计方案")]),_._v(" "),t("p",[_._v("无状态\n动态扩展")]),_._v(" "),t("h3",{attrs:{id:"_6-7-接入层高可用设计最佳实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-7-接入层高可用设计最佳实践"}},[_._v("#")]),_._v(" 6.7 接入层高可用设计最佳实践")]),_._v(" "),t("p",[_._v("模块和数据分离")]),_._v(" "),t("p",[_._v("session绑定")]),_._v(" "),t("ul",[t("li",[_._v("每个session同步复制")])]),_._v(" "),t("p",[_._v("不存储session")]),_._v(" "),t("ul",[t("li",[_._v("接入层不存session + 客户端存储session")]),_._v(" "),t("li")]),_._v(" "),t("h3",{attrs:{id:"_6-8-我们的实践案例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-8-我们的实践案例"}},[_._v("#")]),_._v(" 6.8 我们的实践案例")]),_._v(" "),t("hr"),_._v(" "),t("h2",{attrs:{id:"第七课，业务逻辑层设计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第七课，业务逻辑层设计"}},[_._v("#")]),_._v(" 第七课，业务逻辑层设计")]),_._v(" "),t("p",[t("img",{attrs:{src:"/docs/images/2020-07-11-09-03-23.png",alt:""}})]),_._v(" "),t("p",[_._v("接入层→逻辑层（→路由层）→数据层")]),_._v(" "),t("h3",{attrs:{id:"_7-1-逻辑层都做什么"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-逻辑层都做什么"}},[_._v("#")]),_._v(" 7.1 逻辑层都做什么")]),_._v(" "),t("p",[_._v("实现业务功能。不是基础架构，而是真正商务需求的逻辑在这实现。\n该层是一个无状态的api接口服务器？RPC？Dobble？集群？每台都一样？")]),_._v(" "),t("p",[_._v("还是？一个逻辑上的层。一写类，springboot内部的概念？\nlogicClass？")]),_._v(" "),t("p",[_._v("还是两个类？多个类？都在一个工程里，一个服务器里？")]),_._v(" "),t("p",[_._v("可以是一个文件（一个类）\n可以是多个文件\n可以是多个服务器，一个业务一个进程")]),_._v(" "),t("h3",{attrs:{id:"_7-2-逻辑层整体架构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-逻辑层整体架构"}},[_._v("#")]),_._v(" 7.2 逻辑层整体架构")]),_._v(" "),t("table",[t("thead",[t("tr",[t("th",{staticStyle:{"text-align":"left"}},[_._v("方式")]),_._v(" "),t("th",{staticStyle:{"text-align":"left"}},[_._v("说明")]),_._v(" "),t("th",{staticStyle:{"text-align":"left"}},[_._v("缺点")]),_._v(" "),t("th",{staticStyle:{"text-align":"left"}},[_._v("应用场景")])])]),_._v(" "),t("tbody",[t("tr",[t("td",{staticStyle:{"text-align":"left"}},[_._v("all in one 方式")]),_._v(" "),t("td",{staticStyle:{"text-align":"left"}},[_._v("一个文件")]),_._v(" "),t("td",{staticStyle:{"text-align":"left"}},[_._v("耦合，开发维护成本大,牵一发动全身")]),_._v(" "),t("td",{staticStyle:{"text-align":"left"}},[_._v("创业初期或业务不复杂")])]),_._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[_._v("all in one 方式")]),_._v(" "),t("td",{staticStyle:{"text-align":"left"}},[_._v("一个类")]),_._v(" "),t("td",{staticStyle:{"text-align":"left"}},[_._v("耦合，开发维护成本大,牵一发动全身")]),_._v(" "),t("td",{staticStyle:{"text-align":"left"}},[_._v("创业初期或业务不复杂")])]),_._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[_._v("all in one垂直划分")]),_._v(" "),t("td",{staticStyle:{"text-align":"left"}},[_._v("一个业务一个组件（目录或类）")]),_._v(" "),t("td",{staticStyle:{"text-align":"left"}},[_._v("利于开发维护，业务不互相影响。"),t("br"),_._v("缺点：物理上是一个模块，编译成本高。一个业务修改都需要重新上线，重启影响所有业务，即使滚动更新也会影响")]),_._v(" "),t("td",{staticStyle:{"text-align":"left"}},[_._v("一般脑子没病都会这么做，互联网公司有的多，58和百度都这么用，对日项目基本都这么做。本质上，每个业务还是没有隔离。")])]),_._v(" "),t("tr",[t("td",{staticStyle:{"text-align":"left"}},[_._v("业务建物理垂直划分")]),_._v(" "),t("td",{staticStyle:{"text-align":"left"}},[_._v("每个业务独立的进程（微服务？）"),t("br"),_._v("商品进程"),t("br"),_._v("用户进程"),t("br"),_._v("客服进程")]),_._v(" "),t("td",{staticStyle:{"text-align":"left"}},[_._v("重启上线都不互相影响，业务间完全解耦。单独开发单独运维，开发运维效率高")]),_._v(" "),t("td",{staticStyle:{"text-align":"left"}},[_._v("58,百度开发大规模时也用")])])])]),_._v(" "),t("h3",{attrs:{id:"_7-3逻辑层无状态怎么设计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-3逻辑层无状态怎么设计"}},[_._v("#")]),_._v(" 7. 3逻辑层无状态怎么设计")]),_._v(" "),t("p",[_._v("系统不存储数据，不存储业务的上下文\n每次都是请求携带数据进入逻辑（逻辑里不存储数据，只是处理数据）\n子系统之间完全对称（服务器之间，是无状态）\n请求提交到任何服务器，结果都一样")]),_._v(" "),t("p",[_._v("就可以随意伸缩")]),_._v(" "),t("ul",[t("li",[_._v("关键因素\n"),t("ul",[t("li",[_._v("不保存请求数据")]),_._v(" "),t("li",[_._v("不保存逻辑数据")]),_._v(" "),t("li",[_._v("所有业务逻辑层完全对称")]),_._v(" "),t("li",[_._v("一台或多台宕机没影响")]),_._v(" "),t("li",[_._v("请求可以提交到任意一台服务器")]),_._v(" "),t("li",[_._v("业务逻辑层高可用")]),_._v(" "),t("li",[_._v("实现高可用的关键因素\n"),t("ul",[t("li",[_._v("实现负载均衡 （1s超时没返回再选择其它的服务器）")])])])])])]),_._v(" "),t("h5",{attrs:{id:"怎么负载均衡-【lvs-nginx】"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#怎么负载均衡-【lvs-nginx】"}},[_._v("#")]),_._v(" 怎么负载均衡 【LVS/nginx】")]),_._v(" "),t("ul",[t("li",[_._v("检测服务器可用状态")]),_._v(" "),t("li",[_._v("自动转移失败机器")]),_._v(" "),t("li",[_._v("请求量和需求量较高，流量自动分配到集群中多态服务器")]),_._v(" "),t("li",[_._v("心跳发现服务器不可用，剔除掉")]),_._v(" "),t("li",[_._v("一旦服务器可用，可以自动重新连接恢复")])]),_._v(" "),t("h5",{attrs:{id:"纯异步调用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#纯异步调用"}},[_._v("#")]),_._v(" 纯异步调用")]),_._v(" "),t("ul",[t("li",[t("p",[_._v("什么是同步：阻塞式")])]),_._v(" "),t("li",[t("p",[_._v("什么是异步：不阻塞。多线程处理完后回调通知调用者。或用状态来通知。")]),_._v(" "),t("ul",[t("li",[_._v("优点：吞吐量高")]),_._v(" "),t("li",[_._v("缺点：实现成本高")])])]),_._v(" "),t("li",[t("p",[_._v("为什么异步化")]),_._v(" "),t("ul",[t("li",[_._v("提高吞吐量，减少延时，避免浪费时间")])])]),_._v(" "),t("li",[t("p",[_._v("怎样实现异步")]),_._v(" "),t("ul",[t("li",[_._v("消息队列\n"),t("ul",[t("li",[_._v("例如，用户注册写消息队列返回给客户，然后逻辑层读消息队列写DB与发邮件同时做。做。")])])]),_._v(" "),t("li",[_._v("异步调用的场景（CPU等待IO，效率低，不够优化）\n"),t("ul",[t("li",[_._v("IO")]),_._v(" "),t("li",[_._v("网络IO")]),_._v(" "),t("li",[_._v("IO模型\n"),t("ul",[t("li",[_._v("阻塞IO模型 ： 下一步严重依赖上一步。必须阻塞")]),_._v(" "),t("li",[_._v("轮询非阻塞模型：下一步轮询看上一步是否准备好。效率也不高。")]),_._v(" "),t("li",[_._v("IO复用模型：多多个句柄管理。select是阻塞的，recv是异步\n"),t("ul",[t("li",[t("img",{attrs:{src:"/docs/images/2020-07-11-10-19-32.png",alt:""}})])])])])]),_._v(" "),t("li",[_._v("高性能纯异步调用\n"),t("ul",[t("li",[_._v("sever但连接池，server端收发队列")]),_._v(" "),t("li",[_._v("client端连接池。client端手法队列")]),_._v(" "),t("li",[_._v("超时队列和超时管理起")]),_._v(" "),t("li",[_._v("上下文管理器+状态机")])])])])])])])]),_._v(" "),t("h3",{attrs:{id:"_7-4-逻辑层如何分级管理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-4-逻辑层如何分级管理"}},[_._v("#")]),_._v(" 7.4 逻辑层如何分级管理")]),_._v(" "),t("h5",{attrs:{id:"硬件层面"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#硬件层面"}},[_._v("#")]),_._v(" 硬件层面")]),_._v(" "),t("ul",[t("li",[_._v("核心系统用好的机器")]),_._v(" "),t("li",[_._v("边缘系统用差的")])]),_._v(" "),t("h5",{attrs:{id:"部署层面"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署层面"}},[_._v("#")]),_._v(" 部署层面")]),_._v(" "),t("ul",[t("li",[_._v("服务部署隔离")]),_._v(" "),t("li",[_._v("避免故障带俩连锁反映")]),_._v(" "),t("li",[_._v("核心系统在物理机")]),_._v(" "),t("li",[_._v("核心系统在不同机房")]),_._v(" "),t("li",[_._v("边缘系统用虚拟机")]),_._v(" "),t("li",[_._v("边缘系统私用公用机器")])]),_._v(" "),t("h5",{attrs:{id:"监控"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#监控"}},[_._v("#")]),_._v(" 监控")]),_._v(" "),t("ul",[t("li",[_._v("核心监控，邮件短息通知")])]),_._v(" "),t("h5",{attrs:{id:"响应分级"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#响应分级"}},[_._v("#")]),_._v(" 响应分级")]),_._v(" "),t("ul",[t("li",[_._v("核心，优先响应，优先开发")])]),_._v(" "),t("h3",{attrs:{id:"_7-5-逻辑层如何设置合理的超时"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-5-逻辑层如何设置合理的超时"}},[_._v("#")]),_._v(" 7.5 逻辑层如何设置合理的超时")]),_._v(" "),t("h4",{attrs:{id:"为什么设置超时"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#为什么设置超时"}},[_._v("#")]),_._v(" 为什么设置超时")]),_._v(" "),t("p",[_._v("下游死了，线程死锁了，请求得不到想用\n请求占用资源\n调用方得不到响应，体验查")]),_._v(" "),t("h4",{attrs:{id:"怎么设置？"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#怎么设置？"}},[_._v("#")]),_._v(" 怎么设置？")]),_._v(" "),t("ul",[t("li",[_._v("平均响应延迟的2倍。避免长时间等待")]),_._v(" "),t("li",[_._v("响应延迟高，超时设置长协")]),_._v(" "),t("li",[_._v("响应延迟低，超时短些")]),_._v(" "),t("li",[_._v("继续重试\n"),t("ul",[t("li",[_._v("一般三次")]),_._v(" "),t("li",[_._v("多次五好处")])])]),_._v(" "),t("li",[_._v("请求转移到下游其它同样服务器上")])]),_._v(" "),t("h3",{attrs:{id:"_7-6-逻辑层服务降级如何设计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-6-逻辑层服务降级如何设计"}},[_._v("#")]),_._v(" 7.6 逻辑层服务降级如何设计")]),_._v(" "),t("p",[_._v("问什么有时需要服务被降级？")]),_._v(" "),t("ul",[t("li",[_._v("网络高峰期，并发量大")]),_._v(" "),t("li",[_._v("服务能力有限")]),_._v(" "),t("li",[_._v("宕机")]),_._v(" "),t("li",[_._v("服务雪崩")]),_._v(" "),t("li",[_._v("保证核心服务正常使用")])]),_._v(" "),t("p",[_._v("做降级")]),_._v(" "),t("ul",[t("li",[t("p",[_._v("保证核心服务有用")])]),_._v(" "),t("li",[t("p",[_._v("对非核心服务弱可用甚至不可用")])]),_._v(" "),t("li",[t("p",[_._v("降级方案：")]),_._v(" "),t("ul",[t("li",[_._v("拒绝部分请求\n"),t("ul",[t("li",[_._v("队列方式：入队列出队列时间，超过一定时间，直接返回")]),_._v(" "),t("li",[_._v("优先级请求方式：非核心请求直接丢弃")]),_._v(" "),t("li",[_._v("随机拒绝：\n"),t("ul",[t("li",[_._v("随机丢弃一定比例的请求")]),_._v(" "),t("li",[_._v("网站一会好用一会不好用，大概是这样处理的。")])])])])]),_._v(" "),t("li",[_._v("关闭请求\n"),t("ul",[t("li",[_._v("非核心业务直接关闭")]),_._v(" "),t("li",[_._v("业务逻辑层屏蔽掉（关闭社交，私信，留言，评论）")])])])])])]),_._v(" "),t("h3",{attrs:{id:"_7-7-逻辑层如何做到幂等设计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-7-逻辑层如何做到幂等设计"}},[_._v("#")]),_._v(" 7.7 逻辑层如何做到幂等设计")]),_._v(" "),t("ul",[t("li",[_._v("请求失败后会继续重试")]),_._v(" "),t("li",[_._v("保证服务重复调用和异地调用结果相同")]),_._v(" "),t("li",[_._v("不能保证幂等性（交易必须保证幂等！！！！！！）\n"),t("ul",[t("li",[_._v("结果将是灾难性的\n"),t("ul",[t("li",[_._v("转账")]),_._v(" "),t("li",[_._v("交易")]),_._v(" "),t("li",[_._v("支付")])])])])])]),_._v(" "),t("h5",{attrs:{id:"怎样做到幂等"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#怎样做到幂等"}},[_._v("#")]),_._v(" 怎样做到幂等")]),_._v(" "),t("ul",[t("li",[_._v("天然幂等\n"),t("ul",[t("li",[_._v("离线消息设置为已经读取")])])]),_._v(" "),t("li",[_._v("非天然幂等 （必须去记录状态）\n"),t("ul",[t("li",[_._v("支付\n"),t("ul",[t("li",[_._v("支付ID，支付状态")]),_._v(" "),t("li",[_._v("每次支付钱，判断支付状态，未支付才转支付")])])]),_._v(" "),t("li",[_._v("转账")])])])]),_._v(" "),t("h3",{attrs:{id:"_7-8-逻辑层高可用设计最佳方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-8-逻辑层高可用设计最佳方案"}},[_._v("#")]),_._v(" 7.8 逻辑层高可用设计最佳方案")]),_._v(" "),t("p",[_._v("分布式锁\n分布式事务")]),_._v(" "),t("h3",{attrs:{id:"_7-9-逻辑层我的实践案例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-9-逻辑层我的实践案例"}},[_._v("#")]),_._v(" 7.9 逻辑层我的实践案例")]),_._v(" "),t("p",[_._v("思考：网络编程我还是不熟悉，否则我应该能懂。")]),_._v(" "),t("hr"),_._v(" "),t("h2",{attrs:{id:"第八课，数据存储层设计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第八课，数据存储层设计"}},[_._v("#")]),_._v(" 第八课，数据存储层设计")]),_._v(" "),t("h3",{attrs:{id:"_8-1-高可用架构数据存储层-重要性"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_8-1-高可用架构数据存储层-重要性"}},[_._v("#")]),_._v(" 8.1 高可用架构数据存储层 重要性")]),_._v(" "),t("p",[_._v("命根，一定保住")]),_._v(" "),t("p",[_._v("数据才是真正财产，\n技术服务不是")]),_._v(" "),t("h3",{attrs:{id:"_8-2-高可用架构数据存储层-单机"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_8-2-高可用架构数据存储层-单机"}},[_._v("#")]),_._v(" 8.2 高可用架构数据存储层 单机")]),_._v(" "),t("h5",{attrs:{id:"存储引擎，是存储系统的发动机。"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#存储引擎，是存储系统的发动机。"}},[_._v("#")]),_._v(" 存储引擎，是存储系统的发动机。")]),_._v(" "),t("ul",[t("li",[_._v("支持： CRUD")]),_._v(" "),t("li",[_._v("类型：\n"),t("ul",[t("li",[_._v("哈希\n"),t("ul",[t("li",[_._v("数组 + 链表")]),_._v(" "),t("li",[_._v("支持CRUD ，还有随机读")]),_._v(" "),t("li",[_._v("快")]),_._v(" "),t("li",[_._v("O（1）复杂度")]),_._v(" "),t("li",[_._v("例如，Mysql，Oracle")])])]),_._v(" "),t("li",[_._v("B树\n"),t("ul",[t("li",[_._v("B Tree")]),_._v(" "),t("li",[_._v("支持CRUD")]),_._v(" "),t("li",[_._v("支持顺序扫描，范围查找")]),_._v(" "),t("li",[_._v("Mysql，InnoDB聚簇索引")])])]),_._v(" "),t("li",[_._v("LSM\n"),t("ul",[t("li",[_._v("Log Struct Merge Tree")]),_._v(" "),t("li",[_._v("增量修改保存在内存中，达到一定条件，才批量写入磁盘")]),_._v(" "),t("li",[_._v("读取：需要磁盘+内存 →返回给用户")]),_._v(" "),t("li",[_._v("好处：提高写入性能")]),_._v(" "),t("li",[_._v("缺点：读需要磁盘+内存")]),_._v(" "),t("li",[_._v("重启后会不会内存丢失？ 不会\n"),t("ul",[t("li",[_._v("内存丢失也会从commitlog恢复")])])])])]),_._v(" "),t("li",[_._v("例如 Level DB")])])])]),_._v(" "),t("h5",{attrs:{id:"单机存储原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#单机存储原理"}},[_._v("#")]),_._v(" 单机存储原理")]),_._v(" "),t("ul",[t("li",[_._v("数据模型\n"),t("ul",[t("li",[_._v("模型分类：\n"),t("ul",[t("li",[_._v("文件： 操作系统")]),_._v(" "),t("li",[_._v("关系 ：DB")]),_._v(" "),t("li",[_._v("图：InfoGrid，Infinite，Graph，Neo4j")]),_._v(" "),t("li",[_._v("kvalue：redis memcached")]),_._v(" "),t("li",[_._v("列：Cassadra，Hibase")]),_._v(" "),t("li",[_._v("文档 ：mongoDb，CoachDB")])])])])]),_._v(" "),t("li",[_._v("原理：\n"),t("ul",[t("li",[_._v("事务与并发控制\n"),t("ul",[t("li",[_._v("锁粒度")])])]),_._v(" "),t("li",[_._v("数据恢复\n"),t("ul",[t("li",[_._v("操作日志")])])])])])]),_._v(" "),t("h5",{attrs:{id:"多机存储原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#多机存储原理"}},[_._v("#")]),_._v(" 多机存储原理")]),_._v(" "),t("ul",[t("li",[_._v("数据分布在多节点上，需要负载均衡")]),_._v(" "),t("li",[_._v("数据分布方式\n"),t("ul",[t("li",[_._v("静态方式\n"),t("ul",[t("li",[_._v("取模：静态Hash")]),_._v(" "),t("li",[_._v("uid%32 ：")])])]),_._v(" "),t("li",[_._v("动态方式\n"),t("ul",[t("li",[_._v("一致性hash")]),_._v(" "),t("li",[_._v("有：数据飘移问题")])])])])]),_._v(" "),t("li",[_._v("复制：\n"),t("ul",[t("li",[_._v("分布式存储多个副本，例如HDFS")]),_._v(" "),t("li",[_._v("保证了可靠性和高可用")]),_._v(" "),t("li",[_._v("CommitLog 一旦有问题可以回滚")])])]),_._v(" "),t("li",[_._v("故障检测\n"),t("ul",[t("li",[_._v("心跳")]),_._v(" "),t("li",[_._v("数据迁移")]),_._v(" "),t("li",[_._v("故障恢复")])])])]),_._v(" "),t("h5",{attrs:{id:"flp定理和设计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#flp定理和设计"}},[_._v("#")]),_._v(" FLP定理和设计")]),_._v(" "),t("p",[_._v("1985年FLP不可能")]),_._v(" "),t("ul",[t("li",[t("p",[_._v("异步通信不存在任何一个一致性算法。只能取舍。")])]),_._v(" "),t("li",[t("p",[_._v("出现了CAP定理 2000年")]),_._v(" "),t("ul",[t("li",[_._v("一致性C、可用区A、分区容忍性P（一定要保证）")]),_._v(" "),t("li",[_._v("保证一致性\n"),t("ul",[t("li",[_._v("强同步复制")]),_._v(" "),t("li",[_._v("主副本网络异常，写操作阻塞，可用性无法保证")])])]),_._v(" "),t("li",[_._v("保证可用性\n"),t("ul",[t("li",[_._v("强一致性无法保证")]),_._v(" "),t("li",[_._v("异步复制")]),_._v(" "),t("li",[_._v("保证了存储的可用性")])])]),_._v(" "),t("li",[_._v("权衡 （一致性CP 和 可用性AP ）")]),_._v(" "),t("li",[_._v("金融强调 ：强一致性CP")]),_._v(" "),t("li",[_._v("消息系统： 保证可用性优先 AP")])])]),_._v(" "),t("li",[t("p",[_._v("2PC协议：解决多个数据分片上操作原子性\n两阶段提交")]),_._v(" "),t("ul",[t("li",[_._v("实现分布式事务")]),_._v(" "),t("li",[_._v("两类节点：协调者1个（备份协调者），参与者多个")]),_._v(" "),t("li",[_._v("每个节点都记录CommitLog，保证数据可靠性")]),_._v(" "),t("li",[_._v("两个阶段：\n"),t("ul",[t("li",[_._v("请求阶段")]),_._v(" "),t("li",[_._v("提交阶段")])])]),_._v(" "),t("li",[_._v("应用：分布式事务，")]),_._v(" "),t("li",[_._v("缺点：无法处理协调者宕机")])])]),_._v(" "),t("li",[t("p",[_._v("Paxos协议：解决多个副本上一致性")]),_._v(" "),t("ul",[t("li",[_._v("主节点挂，选举主节点")]),_._v(" "),t("li",[_._v("角色\n"),t("ul",[t("li",[_._v("提议者")]),_._v(" "),t("li",[_._v("接收者")])])]),_._v(" "),t("li",[_._v("执行步骤\n"),t("ul",[t("li",[t("h2",{attrs:{id:"批准"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#批准"}},[_._v("#")]),_._v(" 批准")])]),_._v(" "),t("li",[_._v("确认")])])]),_._v(" "),t("li",[_._v("可以处理协调者宕机")])])]),_._v(" "),t("li",[t("p",[_._v("2PC和Paxos结合使用。")])])]),_._v(" "),t("h3",{attrs:{id:"_8-3-高可用架构数据存储层-冗余如何做"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_8-3-高可用架构数据存储层-冗余如何做"}},[_._v("#")]),_._v(" 8.3 高可用架构数据存储层 冗余如何做")]),_._v(" "),t("ul",[t("li",[_._v("多个数据副本")]),_._v(" "),t("li",[_._v("复制：mysql 、mongoDB。maser-slave，没有主动恢复")]),_._v(" "),t("li",[_._v("ReplicSet： mongoDB")])]),_._v(" "),t("p",[_._v("如何做：")]),_._v(" "),t("ul",[t("li",[_._v("双写 写主也写辅")]),_._v(" "),t("li",[_._v("分布式事务保证读写。性能下降很多")])]),_._v(" "),t("p",[_._v("数据备份：")]),_._v(" "),t("ul",[t("li",[_._v("冷备份\n传统做法，保证不了高可用")]),_._v(" "),t("li",[_._v("热备份 online\n"),t("ul",[t("li",[_._v("异步热备份：写完主就返回。之后主慢慢写从。Mysql，mongoDb")]),_._v(" "),t("li",[_._v("同步热备份 ：写完从才返回。性能低")])])])]),_._v(" "),t("h3",{attrs:{id:"_8-4-高可用架构数据存储层-数据无缝迁移"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_8-4-高可用架构数据存储层-数据无缝迁移"}},[_._v("#")]),_._v(" 8.4 高可用架构数据存储层 数据无缝迁移")]),_._v(" "),t("p",[_._v("都是蜻蜓点水般讲解。")]),_._v(" "),t("p",[_._v("mongo → mysql\n"),t("img",{attrs:{src:"/docs/images/2020-07-11-13-44-32.png",alt:""}})]),_._v(" "),t("p",[_._v("没怎么展开")]),_._v(" "),t("h3",{attrs:{id:"_8-5-高可用架构数据存储层-最佳实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_8-5-高可用架构数据存储层-最佳实践"}},[_._v("#")]),_._v(" 8.5 高可用架构数据存储层 最佳实践")]),_._v(" "),t("ol",[t("li",[_._v("feed")])]),_._v(" "),t("p",[_._v("表：取模，\ndata：水平拆分\n库：分到不同库。\ncache集群")]),_._v(" "),t("ul",[t("li",[_._v("每个机房都有一套cache，冗余")]),_._v(" "),t("li",[_._v("高可用（没必要做高可用？）")]),_._v(" "),t("li",[_._v("增加cache集群机器")])]),_._v(" "),t("h2",{attrs:{id:"第九课，分布式缓存"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第九课，分布式缓存"}},[_._v("#")]),_._v(" 第九课，分布式缓存")]),_._v(" "),t("h3",{attrs:{id:"_9-0-为什么需要焕春"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_9-0-为什么需要焕春"}},[_._v("#")]),_._v(" 9.0 为什么需要焕春")]),_._v(" "),t("p",[_._v("加速响应速度，延迟小\n减少对硬盘的读压力")]),_._v(" "),t("h3",{attrs:{id:"_9-1-使用场景"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_9-1-使用场景"}},[_._v("#")]),_._v(" 9.1 使用场景")]),_._v(" "),t("p",[_._v("尽可能缓存")]),_._v(" "),t("ul",[t("li",[_._v("静态内容：小文本，视频，css，js")]),_._v(" "),t("li",[_._v("较少更改的 ： 性别，年龄。")]),_._v(" "),t("li",[_._v("读多写少的场景。写一次读十次可以放缓存。写一次读一次的不用放缓存。")]),_._v(" "),t("li",[_._v("不适合的场景：\n"),t("ul",[t("li",[_._v("频繁更新")]),_._v(" "),t("li",[_._v("读少写多的场景")])])])]),_._v(" "),t("h3",{attrs:{id:"_9-2-类型，各自作用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_9-2-类型，各自作用"}},[_._v("#")]),_._v(" 9.2 类型，各自作用")]),_._v(" "),t("ul",[t("li",[_._v("本地缓存\n"),t("ul",[t("li",[_._v("类目信息（很少变化），进程重启拉进来。减少IO交互。")]),_._v(" "),t("li",[_._v("这些要是改的话不用网络交互。节省时间")])])]),_._v(" "),t("li",[_._v("进程内缓存\n"),t("ul",[t("li",[_._v("缓存动态数据，\n"),t("ul",[t("li",[_._v("session相关信息，用户在线隐身离开信息")]),_._v(" "),t("li",[_._v("可以定期清除")]),_._v(" "),t("li",[_._v("放在远端缓存的话，没办法定期清除。必须拉出来清理再放回去。代价高")]),_._v(" "),t("li",[_._v("进程内数据和业务耦合，放在进程内缓存还是合适的。")])])])])]),_._v(" "),t("li",[_._v("分布式缓存\n"),t("ul",[t("li",[_._v("Memchached（KV分布式缓存）\n"),t("ul",[t("li",[_._v("高可用（都有脏数据-一致性问题）：解决颁发：时间戳")]),_._v(" "),t("li",[_._v("不支持持久化")]),_._v(" "),t("li")])]),_._v(" "),t("li",[_._v("redis（KV分布式缓存）\n"),t("ul",[t("li",[_._v("5w+吞吐量")]),_._v(" "),t("li",[_._v("高可用（SM）")]),_._v(" "),t("li",[_._v("持久化 RDB快照，AOF配置刷盘")])])]),_._v(" "),t("li",[_._v("自主研发分布式缓存系统\n"),t("ul",[t("li",[_._v("redis就可以满足了。redis 好于 memchache")])])])])])]),_._v(" "),t("h3",{attrs:{id:"_9-3-如何选择缓存"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_9-3-如何选择缓存"}},[_._v("#")]),_._v(" 9.3 如何选择缓存")]),_._v(" "),t("ul",[t("li")]),_._v(" "),t("h3",{attrs:{id:"_9-4-高可用缓存冗余设计？"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_9-4-高可用缓存冗余设计？"}},[_._v("#")]),_._v(" 9.4 高可用缓存冗余设计？")]),_._v(" "),t("h3",{attrs:{id:"_9-5-高可用缓存一致性怎么保证"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_9-5-高可用缓存一致性怎么保证"}},[_._v("#")]),_._v(" 9.5 高可用缓存一致性怎么保证")]),_._v(" "),t("h3",{attrs:{id:"_9-6-高可用缓存命中率如何保证"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_9-6-高可用缓存命中率如何保证"}},[_._v("#")]),_._v(" 9.6 高可用缓存命中率如何保证")]),_._v(" "),t("h3",{attrs:{id:"_9-7-最佳实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_9-7-最佳实践"}},[_._v("#")]),_._v(" 9.7 最佳实践")])],1)}),[],!1,null,null,null);v.default=i.exports}}]);