(window.webpackJsonp=window.webpackJsonp||[]).push([[31],{515:function(s,a,t){"use strict";t.r(a);var e=t(59),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("共享存储，NFS以及DB仍旧有单点故障。Nginx也有单点故障。以后：DB可以做成集群。nginx可以做成主从。NFS换成ceph。")]),s._v(" "),t("p",[s._v("感谢原作者akiya的分享。这篇文章写得已经算是不错了。至少给了一个尝试的方案。我略加整理，并解决了一下小Bug。亲测可以push。\nhttps://juejin.im/post/5d973e246fb9a04dfa0963fb")]),s._v(" "),t("p",[s._v("下面是思路：\nnginx负责负载均衡，nginx提供https。\nnginx后面的两个harobr使用http服务。\n网页访问的时候访问最前端的nginx。\n客户端需要docker的daemon.json中加入最前端nginx的domain。")]),s._v(" "),t("p",[t("img",{attrs:{src:"/docs/images/2020-07-16-10-50-44.png",alt:""}})]),s._v(" "),t("p",[s._v("如果最终生产环境集群中服务器较多，依赖做完LB的Harbor也无法完全达到需求时，可以使用如下架构，部署下级Harbor节点从主节点同步镜像，然后再分发给生产服务器。\n"),t("img",{attrs:{src:"/docs/images/2020-07-16-10-51-12.png",alt:""}})]),s._v(" "),t("h2",{attrs:{id:"背景介绍"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#背景介绍"}},[s._v("#")]),s._v(" 背景介绍")]),s._v(" "),t("p",[s._v("我们简要说明了单机版本harbor的配置。然而这种单机部署显然无法满足在生产中需求，必须要保证应用的高可用性。")]),s._v(" "),t("p",[s._v("目前有两种主流的方案来解决这个问题：")]),s._v(" "),t("ul",[t("li",[s._v("双主复制")]),s._v(" "),t("li",[s._v("多harbor实例共享后端存储")])]),s._v(" "),t("h3",{attrs:{id:"a-双主复制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#a-双主复制"}},[s._v("#")]),s._v(" A. 双主复制")]),s._v(" "),t("h4",{attrs:{id:"a-1-主从同步"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#a-1-主从同步"}},[s._v("#")]),s._v(" A.1 主从同步")]),s._v(" "),t("p",[s._v("harbor官方默认提供主从复制的方案来解决镜像同步问题，通过复制的方式，我们可以实时将测试环境harbor仓库的镜像同步到生产环境harbor，类似于如下流程：")]),s._v(" "),t("p",[s._v("在实际生产运维的中，往往需要把镜像发布到几十或上百台集群节点上。这时，单个Registry已经无法满足大量节点的下载需求，因此要配置多个Registry实例做负载均衡。手工维护多个Registry实例上的镜像，将是十分繁琐的事情。Harbor可以支持一主多从的镜像发布模式，可以解决大规模镜像发布的难题：")]),s._v(" "),t("p",[s._v("只要往一台Registry上发布，镜像就像“仙女散花”般地同步到多个Registry中，高效可靠。")]),s._v(" "),t("p",[s._v("如果是地域分布较广的集群，还可以采用层次型发布方式，如从集团总部同步到省公司，从省公司再同步到市公司：")]),s._v(" "),t("p",[s._v("然而单靠主从同步，仍然解决不了harbor主节点的单点问题。")]),s._v(" "),t("h4",{attrs:{id:"a-2-双主复制说明"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#a-2-双主复制说明"}},[s._v("#")]),s._v(" A.2 双主复制说明")]),s._v(" "),t("p",[s._v("所谓的双主复制其实就是复用主从同步实现两个harbor节点之间的双向同步，来保证数据的一致性，然后在两台harbor前端顶一个负载均衡器将进来的请求分流到不同的实例中去，只要有一个实例中有了新的镜像，就是自动的同步复制到另外的的实例中去，这样实现了负载均衡，也避免了单点故障，在一定程度上实现了Harbor的高可用性：")]),s._v(" "),t("p",[s._v("这个方案有一个问题就是有可能两个Harbor实例中的数据不一致。假设如果一个实例A挂掉了，这个时候有新的镜像进来，那么新的镜像就会在另外一个实例B中，后面即使恢复了挂掉的A实例，Harbor实例B也不会自动去同步镜像，这样只能手动的先关掉Harbor实例B的复制策略，然后再开启复制策略，才能让实例B数据同步，让两个实例的数据一致。")]),s._v(" "),t("p",[s._v("另外，我还需要多吐槽一句，在实际生产使用中，主从复制十分的不靠谱。")]),s._v(" "),t("p",[s._v("所以这里推荐使用下面要说的这种方案。")]),s._v(" "),t("h3",{attrs:{id:"b-多harbor实例共享后端存储"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#b-多harbor实例共享后端存储"}},[s._v("#")]),s._v(" B 多harbor实例共享后端存储")]),s._v(" "),t("p",[s._v("方案说明\n共享后端存储算是一种比较标准的方案，就是多个Harbor实例共享同一个后端存储，任何一个实例持久化到存储的镜像，都可被其他实例中读取。通过前置LB进来的请求，可以分流到不同的实例中去处理，这样就实现了负载均衡，也避免了单点故障：")]),s._v(" "),t("p",[s._v("这个方案在实际生产环境中部署需要考虑三个问题：")]),s._v(" "),t("p",[s._v("共享存储的选取，Harbor的后端存储目前支持"),t("strong",[s._v("AWS S3")]),s._v("、Openstack Swift, Ceph等，在我们的实验环境里，就直接使用nfs\nSession在不同的实例上共享，这个现在其实已经不是问题了，在最新的harbor中，默认session会存放在redis中，我们只需要将redis独立出来即可。可以通过redis sentinel或者redis cluster等方式来保证redis的可用性。在我们的实验环境里，仍然使用单台redis\nHarbor多实例数据库问题，这个也只需要将harbor中的数据库拆出来独立部署即可。让多实例共用一个外部数据库，数据库的高可用也可以通过数据库的高可用方案保证。")]),s._v(" "),t("h4",{attrs:{id:"小结："}},[t("a",{staticClass:"header-anchor",attrs:{href:"#小结："}},[s._v("#")]),s._v(" 小结：")]),s._v(" "),t("p",[s._v("后端存储使用AWS的S3，那就要做外网了。Harbor是私有仓库，主要在局域网内部使用。为了快。但是为了保存私有公司专用镜像的话，并且公司全国甚至跨国的话，S3没毛病。")]),s._v(" "),t("p",[s._v("redis，和mysql的单点问题，可以使用redis集群以及mysql集群来解决。\n集群可以k8s集群也可以传统集群。以后再做。现在毕竟是实验环境。就不考虑集群了。")]),s._v(" "),t("h2",{attrs:{id:"环境"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#环境"}},[s._v("#")]),s._v(" 环境")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("IP")]),s._v(" "),t("th",[s._v("用途")]),s._v(" "),t("th",[s._v("安装的服务")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("192.168.3.120")]),s._v(" "),t("td",[s._v("NFS服务器，Nginx服务器，Harbor存储层")]),s._v(" "),t("td",[s._v("NFS、Redis、PostgressSQL、Nginx、Docker、docker-compose")])]),s._v(" "),t("tr",[t("td",[s._v("192.168.3.108")]),s._v(" "),t("td",[s._v("Harbor无状态节点")]),s._v(" "),t("td",[s._v("docker、docker-compose、harbor（http方式）")])]),s._v(" "),t("tr",[t("td",[s._v("192.168.3.109")]),s._v(" "),t("td",[s._v("Harbor无状态节点")]),s._v(" "),t("td",[s._v("docker、docker-compose、harbor（http方式）")])])])]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("软件")]),s._v(" "),t("th",[s._v("版本")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("Docker")]),s._v(" "),t("td",[s._v("19.06.3-ce")])]),s._v(" "),t("tr",[t("td",[s._v("docker-compose")]),s._v(" "),t("td",[s._v("1.25.0-rc2")])]),s._v(" "),t("tr",[t("td",[s._v("Harbor")]),s._v(" "),t("td",[s._v("1.10.0")])]),s._v(" "),t("tr",[t("td",[s._v("Nginx")]),s._v(" "),t("td",[s._v("1.16.1")])]),s._v(" "),t("tr",[t("td",[s._v("PostgreSQL")]),s._v(" "),t("td",[s._v("9.6.14")])]),s._v(" "),t("tr",[t("td",[s._v("Redis")]),s._v(" "),t("td",[s._v("4.0.14")])])])]),s._v(" "),t("p",[s._v("版本的确定，首先你下载一个Harbor，然后用下面方法确认好redis，postgress的版本。")]),s._v(" "),t("h2",{attrs:{id:"_1-192-168-3-120-部署"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-192-168-3-120-部署"}},[s._v("#")]),s._v(" 1. 192.168.3.120 部署")]),s._v(" "),t("p",[s._v("上安装registry、clair、notarysigner、notaryserver、Redis、NFS、证书")]),s._v(" "),t("h3",{attrs:{id:"怎么查看harbor用的redis版本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#怎么查看harbor用的redis版本"}},[s._v("#")]),s._v(" 怎么查看harbor用的redis版本")]),s._v(" "),t("p",[t("code",[s._v("docker exec -it redis /bin/bash")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("redis [ ~ ]$ redis-server --version\nRedis server v=4.0.14 sha=00000000:0 malloc=jemalloc-4.0.3 bits=64 build=1e2a11bfe971a20a\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h3",{attrs:{id:"怎么查看harbor用的postgress版本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#怎么查看harbor用的postgress版本"}},[s._v("#")]),s._v(" 怎么查看harbor用的postgress版本")]),s._v(" "),t("p",[t("code",[s._v("docker exec -it harbor-db /bin/bash")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('postgres [ / ]$ psql\npsql (9.6.14)\nType "help" for help.\n\npostgres=# select version();\n PostgreSQL 9.6.14 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 6.3.0, 64-bit\n(1 row)\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("h3",{attrs:{id:"_1-1-签发私有证书"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-签发私有证书"}},[s._v("#")]),s._v(" 1.1 签发私有证书")]),s._v(" "),t("p",[s._v("两种方法，推荐第一种。")]),s._v(" "),t("h4",{attrs:{id:"方法一，最先进得方式：使用开源方式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#方法一，最先进得方式：使用开源方式"}},[s._v("#")]),s._v(" 方法一，最先进得方式：使用开源方式")]),s._v(" "),t("p",[s._v("https://github.com/Fishdrowned/ssl")]),s._v(" "),t("p",[s._v("好处，")]),s._v(" "),t("ul",[t("li",[s._v("一步搞定。")]),s._v(" "),t("li",[s._v("有Root.crt供客户端浏览器安装。")])]),s._v(" "),t("p",[s._v("clone 到192.168.3.107")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos3 ssl"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd ssl")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos3 ssl"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls")]),s._v("\nca.cnf  docs  flush.sh  gen.cert.sh  gen.root.sh  LICENSE  README.md\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos3 ssl"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ./gen.cert.sh harbor.ccbjb.com.cn")]),s._v("\nRemoving "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" out\nCreating output structure\nDone\nGenerating a "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2048")]),s._v(" bit RSA private key\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("+++\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".+++\nwriting new private key to "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'out/root.key.pem'")]),s._v("\n-----\nGenerating RSA private key, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2048")]),s._v(" bit long modulus\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("+++\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("+++\ne is "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("65537")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x10001"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nUsing configuration from ./ca.cnf\nCheck that the request matches the signature\nSignature ok\nThe Subject"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s Distinguished Name is as follows\ncountryName           :PRINTABLE:'")]),s._v("CN"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\nstateOrProvinceName   :ASN.1 12:'")]),s._v("Guangdong"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\nlocalityName          :ASN.1 12:'")]),s._v("Guangzhou"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\norganizationName      :ASN.1 12:'")]),s._v("Fishdrowned"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\norganizationalUnitName:ASN.1 12:'")]),s._v("harbor.ccbjb.com.cn"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\ncommonName            :ASN.1 12:'")]),s._v("*.harbor.ccbjb.com.cn'\nCertificate is to be certified "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("until")]),s._v(" Aug  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" 01:54:11 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v(" GMT "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("730")]),s._v(" days"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nWrite out database with "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" new entries\nData Base Updated\n\nCertificates are located in:\nlrwxrwxrwx "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("45")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("月   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" 09:54 /root/ssl/ssl/out/harbor.ccbjb.com.cn/harbor.ccbjb.com.cn.bundle.crt -"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ./20200805-0954/harbor.ccbjb.com.cn .bundle.crt\nlrwxrwxrwx "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("38")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("月   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" 09:54 /root/ssl/ssl/out/harbor.ccbjb.com.cn/harbor.ccbjb.com.cn.crt -"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ./20200805-0954/harbor.ccbjb.com.cn.crt\nlrwxrwxrwx "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("月   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" 09:54 /root/ssl/ssl/out/harbor.ccbjb.com.cn/harbor.ccbjb.com.cn.key.pem -"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("/cert.key.pem\nlrwxrwxrwx "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("月   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" 09:54 /root/ssl/ssl/out/harbor.ccbjb.com.cn/root.crt -"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("/root.crt\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@centos3 ssl"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br")])]),t("p",[s._v("out/有")]),s._v(" "),t("ul",[t("li",[s._v("harbor.ccbjb.com.cn.bundle.crt")]),s._v(" "),t("li",[s._v("harbor.ccbjb.com.cn.crt")]),s._v(" "),t("li",[s._v("harbor.ccbjb.com.cn.key.pem")]),s._v(" "),t("li",[s._v("root.crt")])]),s._v(" "),t("h4",{attrs:{id:"方法二：手动一个个命令生成私钥"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#方法二：手动一个个命令生成私钥"}},[s._v("#")]),s._v(" 方法二：手动一个个命令生成私钥")]),s._v(" "),t("h4",{attrs:{id:"正式生产环境建议使用商业证书！"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#正式生产环境建议使用商业证书！"}},[s._v("#")]),s._v(" 正式生产环境建议使用商业证书！")]),s._v(" "),t("h5",{attrs:{id:"使用openssl工具生成一个rsa私钥"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用openssl工具生成一个rsa私钥"}},[s._v("#")]),s._v(" 使用openssl工具生成一个RSA私钥")]),s._v(" "),t("p",[t("code",[s._v("# openssl genrsa -des3 -out harbor1.key 2048")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("Generating RSA private key, 2048 bit long modulus\n.......................+++\n......+++\ne is 65537 (0x10001)\nEnter pass phrase for harbor.key:                   # 输入一个至少4位的密码\nVerifying - Enter pass phrase for harbor.key:       # 重复输入密码\n复制代码删除harbor.key中的密码\n# openssl rsa -in harbor.key -out harbor.key\nEnter pass phrase for harbor.key:                 # 输入刚才创建时的密码\nwriting RSA key\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("h5",{attrs:{id:"去掉key的密码"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#去掉key的密码"}},[s._v("#")]),s._v(" 去掉key的密码")]),s._v(" "),t("p",[t("code",[s._v("openssl rsa -in harbor1.key -out harbor.key")])]),s._v(" "),t("h5",{attrs:{id:"生成csr（证书签名请求）"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#生成csr（证书签名请求）"}},[s._v("#")]),s._v(" 生成CSR（证书签名请求）")]),s._v(" "),t("p",[t("code",[s._v("# openssl req -new -key harbor.key -out harbor.csr")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("You are about to be asked to enter information that will be incorporated\ninto your certificate request.\nWhat you are about to enter is what is called a Distinguished Name or a DN.\nThere are quite a few fields but you can leave some blank\nFor some fields there will be a default value,\nIf you enter '.', the field will be left blank.\n-----\nCountry Name (2 letter code) [XX]:cn             # 国家\nState or Province Name (full name) []:Sichuan    # 地区 \nLocality Name (eg, city) [Default City]:Chengdu  # 城市\nOrganization Name (eg, company) [Default Company Ltd]:akiya  # 组织\nOrganizational Unit Name (eg, section) []:akiya  # 组织单位\nCommon Name (eg, your name or your server's hostname) []:akiya    # 常用名可填自己名字或域名\nEmail Address []:a@b.com                         # 邮件地址\n\nPlease enter the following 'extra' attributes\nto be sent with your certificate request      \nA challenge password []:       # 可留空\nAn optional company name []:   # 可留空\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("h5",{attrs:{id:"生成自签名证书"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#生成自签名证书"}},[s._v("#")]),s._v(" 生成自签名证书")]),s._v(" "),t("p",[s._v("注意：在使用自签名的临时证书时，浏览器会提示证书的颁发机构是未知的。\n"),t("code",[s._v("# echo subjectAltName = IP:192.168.3.120 > extfile.cnf")])]),s._v(" "),t("p",[t("code",[s._v("# openssl x509 -req -days 365 -in harbor.csr -signkey harbor.key -out harbor.crt -extfile extfile.cnf")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("Signature ok\nsubject=/C=cn/ST=Sichuan/L=Chengdu/O=akiya/OU=akiya/CN=akiya/emailAddress=a@b.com\nGetting Private key\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h5",{attrs:{id:"存放证书"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#存放证书"}},[s._v("#")]),s._v(" 存放证书")]),s._v(" "),t("p",[s._v("复制证书到/www/certs待用\n"),t("code",[s._v("# mkdir -p /www/certs && cp harbor.crt harbor.key /www/certs")]),s._v("\n拷贝到nginx的证书目录\n"),t("code",[s._v("cp /www/certs/* /etc/nginx/certs/")])]),s._v(" "),t("h2",{attrs:{id:"_1-2-docker"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-docker"}},[s._v("#")]),s._v(" 1.2 Docker")]),s._v(" "),t("h5",{attrs:{id:"官方一键脚本安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#官方一键脚本安装"}},[s._v("#")]),s._v(" 官方一键脚本安装")]),s._v(" "),t("p",[t("code",[s._v("# curl -sSL https://get.docker.com/ | sh")])]),s._v(" "),t("h5",{attrs:{id:"先安装必要的依赖环境"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#先安装必要的依赖环境"}},[s._v("#")]),s._v(" 先安装必要的依赖环境")]),s._v(" "),t("p",[t("code",[s._v("# yum -y install yum-utils device-mapper-persistent-data lvm2")])]),s._v(" "),t("h5",{attrs:{id:"添加软件源信息使用阿里云源安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#添加软件源信息使用阿里云源安装"}},[s._v("#")]),s._v(" 添加软件源信息使用阿里云源安装")]),s._v(" "),t("p",[t("code",[s._v("# yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo")])]),s._v(" "),t("h5",{attrs:{id:"更新缓存"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#更新缓存"}},[s._v("#")]),s._v(" 更新缓存")]),s._v(" "),t("p",[t("code",[s._v("# yum makecache fast")])]),s._v(" "),t("h5",{attrs:{id:"安装docker或安装指定版本docker"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装docker或安装指定版本docker"}},[s._v("#")]),s._v(" 安装Docker或安装指定版本Docker")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# yum -y install docker\n# yum -y install docker-ce-18.06.3.ce-3.el7\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h5",{attrs:{id:"查看docker版本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看docker版本"}},[s._v("#")]),s._v(" 查看Docker版本")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# docker --version\nDocker version 18.06.3-ce, build d7080c1\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h5",{attrs:{id:"修改docker仓库为国内镜像站"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#修改docker仓库为国内镜像站"}},[s._v("#")]),s._v(" 修改Docker仓库为国内镜像站")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# curl -sSL https://get.daocloud.io/daotools/set_mirror.sh | sh -s http://f1361db2.m.daocloud.io\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h5",{attrs:{id:"启动docker服务并添加至开机自启"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动docker服务并添加至开机自启"}},[s._v("#")]),s._v(" 启动Docker服务并添加至开机自启")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# systemctl start docker\n# systemctl enable docker\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h2",{attrs:{id:"_1-3-compose"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-compose"}},[s._v("#")]),s._v(" 1.3 Compose")]),s._v(" "),t("p",[s._v("compose是Docker提供的一个命令行工具，用来定义和运行由多个容器组成的应用。使用compose，我们可以通过YAML文件声明式的定义应用程序的各个服务，并由单个命令完成应用的创建和启动。\n由于国内政策原因，可能在海外网站上下载文件速度较慢，建议下载本地后上传至服务器")]),s._v(" "),t("h5",{attrs:{id:"下载docker-compose并赋予可执行权限"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#下载docker-compose并赋予可执行权限"}},[s._v("#")]),s._v(" 下载docker-compose并赋予可执行权限")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# curl -L https://github.com/docker/compose/releases/download/1.25.0-rc2/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose\n\n# chmod +x /usr/local/bin/docker-compose\n\n//查看compose本地版本\n# docker-compose -v\n\ndocker-compose version 1.25.0-rc2, build 661ac20e\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("h2",{attrs:{id:"_1-4-四个服务的安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-四个服务的安装"}},[s._v("#")]),s._v(" 1.4 四个服务的安装")]),s._v(" "),t("p",[s._v("由于Harbor v1.9.0使用的是PostgreSQL，我们也同样独立部署一套PostgreSQL与Redis，此次演示使用Docker部署，实际生产环境按需要选择是否部署至宿主机。")]),s._v(" "),t("h5",{attrs:{id:"postgresql"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#postgresql"}},[s._v("#")]),s._v(" PostgreSQL")]),s._v(" "),t("p",[s._v("通过查看已安装的Harbor v1.9.0单机版中运行的harbor-db容器可得知此次运行的PostgreSQL版本为9.6.14")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('# docker exec -it harbor-db /bin/bash\npostgres [ / ]$ psql\npsql (9.6.14)\nType "help" for help.\n\npostgres=# select version();\n                                    version\n-------------------------------------------------------------------------------\n PostgreSQL 9.6.14 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 6.3.0, 64-bit\n(1 row)\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("h5",{attrs:{id:"redis"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redis"}},[s._v("#")]),s._v(" Redis")]),s._v(" "),t("p",[s._v("根据官方文档描述，使用Redis需要4.0.10-1.ph2版本。同样，此次我们为了演示也使用docker-compose来部署。")]),s._v(" "),t("h5",{attrs:{id:"yaml脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#yaml脚本"}},[s._v("#")]),s._v(" yaml脚本")]),s._v(" "),t("p",[s._v("那么我们使用同一版本的PostgreSQL与Redis，编写docker-compose.yml 内容如下：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('# author:akiya\nversion: "3"\n\nnetworks:\n  harbor:\n    driver: bridge\n\nservices:\n  registry:\n    image: postgres:9.6.14\n    container_name: harbor-registry\n    restart: always\n    environment:\n      POSTGRES_DB: registry\n      POSTGRES_PASSWORD: root123\n    volumes:\n      - $PWD/postgres/registry:/var/lib/postgresql/data\n    networks:\n      - harbor\n    ports:\n      - 20010:5432\n  clair:\n    image: postgres:9.6.14\n    container_name: harbor-clair\n    restart: always\n    environment:\n      POSTGRES_DB: clair\n      POSTGRES_PASSWORD: root123\n    volumes:\n      - $PWD/postgres/clair:/var/lib/postgresql/data\n    networks:\n      - harbor\n    ports:\n      - 20011:5432\n  notarysigner:\n    image: postgres:9.6.14\n    container_name: harbor-notarysigner\n    restart: always\n    environment:\n      POSTGRES_DB: notarysigner\n      POSTGRES_PASSWORD: root123\n    volumes:\n      - $PWD/postgres/notarysigner:/var/lib/postgresql/data\n    networks:\n      - harbor\n    ports:\n      - 20012:5432\n  notaryserver:\n    image: postgres:9.6.14\n    container_name: harbor-notaryserver\n    restart: always\n    environment:\n      POSTGRES_DB: notaryserver\n      POSTGRES_PASSWORD: root123\n    volumes:\n      - $PWD/postgres/notaryserver:/var/lib/postgresql/data\n    networks:\n      - harbor\n    ports:\n      - 20013:5432\n  Redis:\n    image: redis:4.0.10\n    container_name: harbor-redis\n    command: redis-server /usr/local/etc/redis/redis.conf\n    restart: always\n    volumes:\n      - $PWD/redis/data:/data\n      - $PWD/redis/redis.conf:/usr/local/etc/redis/redis.conf\n    networks:\n      - harbor\n    ports:\n      - 20000:6379\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br"),t("span",{staticClass:"line-number"},[s._v("62")]),t("br"),t("span",{staticClass:"line-number"},[s._v("63")]),t("br"),t("span",{staticClass:"line-number"},[s._v("64")]),t("br"),t("span",{staticClass:"line-number"},[s._v("65")]),t("br"),t("span",{staticClass:"line-number"},[s._v("66")]),t("br"),t("span",{staticClass:"line-number"},[s._v("67")]),t("br"),t("span",{staticClass:"line-number"},[s._v("68")]),t("br"),t("span",{staticClass:"line-number"},[s._v("69")]),t("br"),t("span",{staticClass:"line-number"},[s._v("70")]),t("br"),t("span",{staticClass:"line-number"},[s._v("71")]),t("br"),t("span",{staticClass:"line-number"},[s._v("72")]),t("br")])]),t("p",[s._v("保存后我们用"),t("code",[s._v("docker-compose up -d")]),s._v("命令启动相应的容器.\n并在防火墙中开放对应的端口")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# docker-compose up -d\n# firewall-cmd --zone=public --permanent --add-port=20000/tcp\n# firewall-cmd --zone=public --permanent --add-port=20010/tcp\n# firewall-cmd --zone=public --permanent --add-port=20011/tcp\n# firewall-cmd --zone=public --permanent --add-port=20012/tcp\n# firewall-cmd --zone=public --permanent --add-port=20013/tcp\n# firewall-cmd --reload\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("blockquote",[t("p",[s._v("我一般推荐关闭防火墙。在内网里面开启防火墙没有任何意义。")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("systemctl stop firewalld\nsystemctl disable firewalld\nsed -i 's/enforcing/disabled/' /etc/selinux/config\nsetenforce 0\nsystemctl stop NetworkManager\nsystemctl disable NetworkManager\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h5",{attrs:{id:"troubleshooting"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#troubleshooting"}},[s._v("#")]),s._v(" TroubleShooting")]),s._v(" "),t("h6",{attrs:{id:"error"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#error"}},[s._v("#")]),s._v(" Error:")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("ERROR: Failed to Setup IP tables: Unable to enable SKIP DNAT rule:  (iptables failed: iptables --wait -t nat -I DOCKER -i br-02aaea983fab -j RETURN: iptables: No chain/target/match by that name.\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("解决：")]),s._v(" "),t("ul",[t("li",[s._v("1.查看nginx日志/var/log/nginx/access.log")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('2020/08/04 12:04:29 [emerg] 24778#24778: cannot load certificate key "/etc/nginx/certs/harbor.key": PEM_read_bio_PrivateKey() failed (SSL: error:0906406D:PEM routines:PEM_def_callback:problems getting password error:0906A068:PEM routines:PEM_do_header:bad password read)\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("原来是，自己的密钥忘了去掉密码了。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("openssl rsa -in harbor1.key -out harbor.key\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("2.另外，3.108和3.109的防火墙允许80端口，或者干脆关闭两台机器的防火墙。")])]),s._v(" "),t("h2",{attrs:{id:"_1-5-nfs"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-nfs"}},[s._v("#")]),s._v(" 1.5 NFS")]),s._v(" "),t("h3",{attrs:{id:"_1-5-1-服务端-192-168-3-120"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-1-服务端-192-168-3-120"}},[s._v("#")]),s._v(" 1.5.1 服务端 192.168.3.120")]),s._v(" "),t("h5",{attrs:{id:"创建nfs共享文件路径"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建nfs共享文件路径"}},[s._v("#")]),s._v(" 创建NFS共享文件路径")]),s._v(" "),t("p",[t("code",[s._v("# mkdir -p /data")])]),s._v(" "),t("h5",{attrs:{id:"安装nfs（在安装完nfs-utils后，rpcbind默认是启动了的）"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装nfs（在安装完nfs-utils后，rpcbind默认是启动了的）"}},[s._v("#")]),s._v(" 安装NFS（在安装完nfs-utils后，rpcbind默认是启动了的）")]),s._v(" "),t("p",[t("code",[s._v("sudo yum -y install nfs-utils")])]),s._v(" "),t("h5",{attrs:{id:"启动nfs相关服务并设置开机启动"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动nfs相关服务并设置开机启动"}},[s._v("#")]),s._v(" 启动NFS相关服务并设置开机启动")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("systemctl start rpcbind\nsystemctl enable rpcbind\nsystemctl start nfs-server\nsystemctl enable nfs-server\nsystemctl start nfs-lock\nsystemctl enable nfs-lock\nsystemctl start nfs-idmap\nsystemctl enable nfs-idmap\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("h5",{attrs:{id:"使用如下命令像-etc-exports中添加配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用如下命令像-etc-exports中添加配置"}},[s._v("#")]),s._v(" 使用如下命令像/etc/exports中添加配置")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# echo '/data     192.168.3.0/24(rw,sync,no_root_squash,no_all_squash)' >> /etc/exports\n# exportfs -a      # 使exports的修改生效\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h5",{attrs:{id:"检查nfs共享目录是否正确"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#检查nfs共享目录是否正确"}},[s._v("#")]),s._v(" 检查NFS共享目录是否正确")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# showmount -e localhost\nExport list for localhost:\n/data 192.168.3.0/24\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h5",{attrs:{id:"放行防火墙相应服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#放行防火墙相应服务"}},[s._v("#")]),s._v(" 放行防火墙相应服务")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# firewall-cmd --add-service=nfs --permanent --zone=public\n# firewall-cmd --add-service=mountd --permanent --zone=public\n# firewall-cmd --add-service=rpc-bind --permanent --zone=public\n# firewall-cmd --reload\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[t("strong",[s._v("我推荐关闭防火墙")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("yum -y install wget vim net-tools ntpdate\nsystemctl stop firewalld\nsystemctl disable firewalld\nsed -i 's/enforcing/disabled/' /etc/selinux/config\nsetenforce 0\nsystemctl stop NetworkManager\nsystemctl disable NetworkManager\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("h3",{attrs:{id:"_1-5-2-客户端-192-168-3-108，192-168-3-109"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-2-客户端-192-168-3-108，192-168-3-109"}},[s._v("#")]),s._v(" 1.5.2 客户端 192.168.3.108，192.168.3.109")]),s._v(" "),t("h5",{attrs:{id:"创建nfs挂载文件路径"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建nfs挂载文件路径"}},[s._v("#")]),s._v(" 创建NFS挂载文件路径")]),s._v(" "),t("p",[t("code",[s._v("# mkdir /data")])]),s._v(" "),t("h5",{attrs:{id:"安装nfs"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装nfs"}},[s._v("#")]),s._v(" 安装NFS")]),s._v(" "),t("p",[t("code",[s._v("# yum -y install nfs-utils")])]),s._v(" "),t("h5",{attrs:{id:"检查nfs远程共享目录是否存在"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#检查nfs远程共享目录是否存在"}},[s._v("#")]),s._v(" 检查NFS远程共享目录是否存在")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# showmount -e 192.168.3.120\nExport list for 192.168.3.120:\n/data 192.168.3.0/24\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h5",{attrs:{id:"挂载远程nfs共享文件路径"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#挂载远程nfs共享文件路径"}},[s._v("#")]),s._v(" 挂载远程NFS共享文件路径")]),s._v(" "),t("p",[t("code",[s._v("# mount -t nfs 192.168.3.120:/data /data")])]),s._v(" "),t("h5",{attrs:{id:"添加到系统开机自动挂载"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#添加到系统开机自动挂载"}},[s._v("#")]),s._v(" 添加到系统开机自动挂载")]),s._v(" "),t("p",[t("code",[s._v("# echo '192.168.3.120:/data /data nfs defaults 0 0' >> /etc/fstab")])]),s._v(" "),t("h5",{attrs:{id:"测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#测试"}},[s._v("#")]),s._v(" 测试")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("在客户端上挂载完NFS后创建一个测试文件\n# touch /data/test\n然后切换到服务器查看是否存在\n# ls /data/nfs/\ntest\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h2",{attrs:{id:"_1-6-nginx"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-6-nginx"}},[s._v("#")]),s._v(" 1.6 Nginx")]),s._v(" "),t("h3",{attrs:{id:"安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[s._v("#")]),s._v(" 安装")]),s._v(" "),t("h5",{attrs:{id:"添加nginx源"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#添加nginx源"}},[s._v("#")]),s._v(" 添加Nginx源")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# rpm -ivh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h5",{attrs:{id:"yum安装nginx"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#yum安装nginx"}},[s._v("#")]),s._v(" yum安装Nginx")]),s._v(" "),t("p",[t("code",[s._v("# yum -y install nginx")])]),s._v(" "),t("h5",{attrs:{id:"启动nginx"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动nginx"}},[s._v("#")]),s._v(" 启动Nginx")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# systemctl start nginx\n# systemctl enable nginx\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h5",{attrs:{id:"编写配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#编写配置"}},[s._v("#")]),s._v(" 编写配置")]),s._v(" "),t("p",[s._v("创建"),t("code",[s._v("/etc/nginx/conf.d/harbor.conf")]),s._v("文件，并写入如下内容")]),s._v(" "),t("div",{staticClass:"language-json line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[s._v("upstream harbor "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    ip_hash;\n    server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v("."),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.108")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(";\n    server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v("."),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.109")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(";\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nserver "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n   listen       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(";\n   # 提供访问的域名或者IP\n   server_name  harbor.ccbjb.com.cn;\n   return      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("308")]),s._v(" https"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//$host$request_uri;")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nserver "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    listen  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v(" ssl;\n    server_name harbor.ccbjb.com.cn;\n    \n    # SSL 证书\n    ssl_certificate ./certs/harbor.crt;\n    # SSL 私钥\n    ssl_certificate_key ./certs/harbor.key;\n    client_max_body_size "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(";\n    chunked_transfer_encoding on;\n\n    location / "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header Host $host;\n        proxy_set_header X-Forwarded-Proto https;\n        proxy_redirect off;\n        proxy_ssl_verify off;\n        proxy_ssl_session_reuse on;\n        proxy_pass http"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//harbor;")]),s._v("\n        proxy_http_version "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.1")]),s._v(";\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    location /v2/ "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        proxy_pass http"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//harbor/v2/;")]),s._v("\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_ssl_verify off;\n        proxy_ssl_session_reuse on;\n        proxy_buffering off;\n        proxy_request_buffering off;\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br")])]),t("h4",{attrs:{id:"启动nginx-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动nginx-2"}},[s._v("#")]),s._v(" 启动Nginx")]),s._v(" "),t("h5",{attrs:{id:"验证nginx配置正确性"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#验证nginx配置正确性"}},[s._v("#")]),s._v(" 验证Nginx配置正确性")]),s._v(" "),t("p",[t("code",[s._v("# nginx -t")])]),s._v(" "),t("h5",{attrs:{id:"平滑重启nginx"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#平滑重启nginx"}},[s._v("#")]),s._v(" 平滑重启Nginx")]),s._v(" "),t("p",[t("code",[s._v("# nginx -s reload")])]),s._v(" "),t("h5",{attrs:{id:"开放防火墙80-443端口"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#开放防火墙80-443端口"}},[s._v("#")]),s._v(" 开放防火墙80/443端口")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# firewall-cmd --zone=public --permanent --add-port=80/tcp\n# firewall-cmd --zone=public --permanent --add-port=443/tcp\n# firewall-cmd --reload\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h3",{attrs:{id:"问题处理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#问题处理"}},[s._v("#")]),s._v(" 问题处理")]),s._v(" "),t("p",[s._v("Nginx")]),s._v(" "),t("h5",{attrs:{id:"问题：使用自签证书时报错"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#问题：使用自签证书时报错"}},[s._v("#")]),s._v(" 问题：使用自签证书时报错")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("emerg] 31815#31815: cannot load certificate \"/www/certs/harbor.crt\": BIO_new_file() failed (SSL: error:0200100D:system library:fopen:Permission denied:fopen('/www/certs/harbor.crt','r') error:2006D002:BIO routines:BIO_new_file:system lib)\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h5",{attrs:{id:"解决方法：创建-etc-nginx-certs路径，并复制证书到此路径"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#解决方法：创建-etc-nginx-certs路径，并复制证书到此路径"}},[s._v("#")]),s._v(" 解决方法：创建/etc/nginx/certs路径，并复制证书到此路径")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mkdir -p /etc/nginx/certs && cp /www/certs/ ./certs\n// 修改harbor.conf中证书相关路径\n# 刚才我们自己签发的证书\nssl_certificate ./certs/harbor.crt;\n# 证书对应的私钥\nssl_certificate_key ./certs/harbor.key;\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h2",{attrs:{id:"_2-两台harbor节点安装harbor"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-两台harbor节点安装harbor"}},[s._v("#")]),s._v(" 2. 两台Harbor节点安装Harbor")]),s._v(" "),t("h3",{attrs:{id:"下载harbor安装包"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#下载harbor安装包"}},[s._v("#")]),s._v(" 下载harbor安装包")]),s._v(" "),t("p",[s._v("https://goharbor.io/\nhttps://github.com/goharbor/harbor/releases")]),s._v(" "),t("p",[s._v("最新稳定版：v2.0.2\n"),t("a",{attrs:{href:"https://github.com/goharbor/harbor/releases/download/v2.0.2/harbor-offline-installer-v2.0.2.tgz",target:"_blank",rel:"noopener noreferrer"}},[s._v("harbor-offline-installer-v2.0.2.tgz"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("我下面使用的是：v1.10.4\n"),t("a",{attrs:{href:"https://github.com/goharbor/harbor/releases/download/v1.10.4/harbor-offline-installer-v1.10.4.tgz",target:"_blank",rel:"noopener noreferrer"}},[s._v("harbor-offline-installer-v1.10.4.tgz"),t("OutboundLink")],1)]),s._v(" "),t("div",{staticClass:"custom-block warning"},[t("p",{staticClass:"custom-block-title"},[s._v("WARNING")]),s._v(" "),t("p",[s._v("使用v2.0.2也好用。而且速度快。")])]),s._v(" "),t("p",[s._v("解压缩：\n"),t("img",{attrs:{src:"/docs/images/2020-08-25-11-34-43.png",alt:""}})]),s._v(" "),t("h3",{attrs:{id:"_2-1-修改配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-修改配置文件"}},[s._v("#")]),s._v(" 2.1 修改配置文件")]),s._v(" "),t("h4",{attrs:{id:"修改harbor-yml配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#修改harbor-yml配置文件"}},[s._v("#")]),s._v(" 修改harbor.yml配置文件")]),s._v(" "),t("p",[t("code",[s._v("# vim harbor.yml")])]),s._v(" "),t("ul",[t("li",[s._v("使用NFS存储/data存储harobr的磁盘数据，NFS服务端磁盘在3.120上")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# The default data volume\ndata_volume: /data\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("ul",[t("li",[s._v("使用120上配置的postgress和redis等服务，外部存储数据也在3.120\n主要配置参数如下，由于我们这里使用外置PostgreSQL与Redis所以直接注释掉database相关配置改用external_database与external_redis")])]),s._v(" "),t("p",[s._v("以192.168.3.108为例，192.168.3.109只需要修改hostname")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改为当前服务器内网IP地址即可")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hostname")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.168.3.108 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 另一台修改为192.168.3.109")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# HTTP相关配置")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("http")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# HTTPS相关配置，这里由于我们会在前端加一个Nginx")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 所以我们直接使用HTTP，而在Nginx上做SSL")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#https:")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  # HTTPS端口")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  port: 443")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  # TLS证书")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  certificate: /www/certs/harbor.crt")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  # TLS私钥")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  private_key: /www/certs/harbor.key")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认管理员密码")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("harbor_admin_password")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Harbor12345\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Harbor DB配置，由于使用外部数据库，所以这里我们注释掉")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# database:")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   password: root123")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   max_idle_conns: 50")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   max_open_conns: 100")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 外部PostgreSQL，由于Harbor使用了4个数据库，这里我们也需要对相应数据库地址进行配置")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("external_database")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("harbor")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("host")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.168.3.120\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20010")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("db_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" registry\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("username")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" postgres\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("password")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" root123\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ssl_mode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" disable\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("max_idle_conns")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("max_open_conns")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("clair")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("host")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.168.3.120\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20011")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("db_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" clair\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("username")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" postgres\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("password")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" root123\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ssl_mode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" disable\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("notary_signer")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("host")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.168.3.120\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20012")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("db_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" notarysigner\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("username")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" postgres\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("password")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" root123\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ssl_mode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" disable\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("notary_server")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("host")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.168.3.120\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20013")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("db_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" notaryserver\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("username")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" postgres\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("password")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" root123\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ssl_mode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" disable\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用外部Redis，取消相应注释即可")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("external_redis")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("host")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.168.3.120\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20000")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("password")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("registry_db_index")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("jobservice_db_index")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("chartmuseum_db_index")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br"),t("span",{staticClass:"line-number"},[s._v("62")]),t("br")])]),t("ul",[t("li",[s._v("所以 3.120存在单点问题。\n3.120要是损坏了。就什么都完了。\n改进：我写了个shell，每天备份3.120数据到另外一个机器。")])]),s._v(" "),t("h3",{attrs:{id:"_2-2-安装harbor"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-安装harbor"}},[s._v("#")]),s._v(" 2.2 安装Harbor")]),s._v(" "),t("h5",{attrs:{id:"生成harbor运行的必要文件（环境）以及docker-compose-yml文件；"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#生成harbor运行的必要文件（环境）以及docker-compose-yml文件；"}},[s._v("#")]),s._v(" 生成harbor运行的必要文件（环境）以及docker-compose.yml文件；")]),s._v(" "),t("p",[s._v("执行后会通过网络获取Docker Image，建议提前修改好国内镜像站加速。\n"),t("code",[s._v("# ./install.sh")])]),s._v(" "),t("ul",[t("li",[s._v("会执行"),t("code",[s._v("prepare")]),s._v("、")]),s._v(" "),t("li",[s._v("会生成common/config/* 、会生成docker-compose.yml")]),s._v(" "),t("li",[t("code",[s._v("docker-compose down")]),s._v("、"),t("code",[s._v("docker-compose up -d")])])]),s._v(" "),t("div",{staticClass:"custom-block warning"},[t("p",{staticClass:"custom-block-title"},[s._v("WARNING")]),s._v(" "),t("p",[s._v("后面要修改common/config/nginx/conf.d/harbor.conf\n所以，需要修改完改配置文件之后，需要手工执行\n"),t("code",[s._v("docker-compose down")]),s._v("、"),t("code",[s._v("docker-compose up -d")])])]),s._v(" "),t("h5",{attrs:{id:"开放harbor端口"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#开放harbor端口"}},[s._v("#")]),s._v(" 开放Harbor端口")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# firewall-cmd --zone=public --permanent --add-port=80/tcp\n# firewall-cmd --reload\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("blockquote",[t("p",[s._v("推荐关闭防火墙，就不需要这步了")])]),s._v(" "),t("h4",{attrs:{id:"以上就是原文的全部了。这里有一处漏记。"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#以上就是原文的全部了。这里有一处漏记。"}},[s._v("#")]),s._v(" 以上就是原文的全部了。这里有一处漏记。")]),s._v(" "),t("p",[s._v("如果不处理，会有push镜像失败的问题。")]),s._v(" "),t("h3",{attrs:{id:"_2-3-修改harbor的nginx配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-修改harbor的nginx配置"}},[s._v("#")]),s._v(" 2.3 修改harbor的nginx配置")]),s._v(" "),t("h6",{attrs:{id:"参考："}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考："}},[s._v("#")]),s._v(" 参考：")]),s._v(" "),t("p",[s._v("https://goharbor.io/docs/2.0.0/install-config/troubleshoot-installation/")]),s._v(" "),t("blockquote",[t("p",[s._v("使用nginx或负载平衡\n如果Harbor在nginx代理或弹性负载平衡之后运行，请打开文件common/config/nginx/nginx.conf并搜索以下行。\nproxy_set_header X-Forwarded-Proto $scheme;\n如果代理已经有类似的设置，从部分删除\nlocation /，\nlocation /v2/\nlocation /service/\n和重新部署港湾。有关如何重新部署Harbor的说明，请参阅 重新配置Harbor和管理Harbor生命周期。")])]),s._v(" "),t("h5",{attrs:{id:"首先，修改两个nginx节点的nginx配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#首先，修改两个nginx节点的nginx配置文件"}},[s._v("#")]),s._v(" 首先，修改两个nginx节点的nginx配置文件")]),s._v(" "),t("p",[s._v("harbor安装目录（harbor.xml同级目录）"),t("code",[s._v("/root/harbor")]),s._v("，修改nginx的配置文件\n"),t("code",[s._v("/root/harbor/common/config/nginx/nginx.conf")]),s._v(" 三处，注意只改三处。\n否则，push的时候会一直retring！！！！！！！！\n"),t("font",{attrs:{color:"red"}},[s._v("该配置文件的注释会有误导，导致你都注释掉，就怎么也push不成功,  注意只改三处（/，/v2/,/service/）! 注释“proxy_set_header X-Forwarded-Proto $scheme;”")])],1),s._v(" "),t("div",{staticClass:"custom-block warning"},[t("p",{staticClass:"custom-block-title"},[s._v("WARNING")]),s._v(" "),t("p",[s._v("修改common/config/nginx/conf.d/harbor.conf\n所以，需要修改完改配置文件之后，需要手工执行\n"),t("code",[s._v("docker-compose down")]),s._v("、"),t("code",[s._v("docker-compose up -d")])])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v(" location / {\n      proxy_pass http://portal/;\n      proxy_set_header Host $host;\n      proxy_set_header X-Real-IP $remote_addr;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\n      # When setting up Harbor behind other proxy, such as an Nginx instance, remove the below line if the proxy already has similar settings.\n      # proxy_set_header X-Forwarded-Proto $scheme;\n\n      proxy_buffering off;\n      proxy_request_buffering off;\n    }\nlocation /v2/ {\n      proxy_pass http://core/v2/;\n      proxy_set_header Host $http_host;\n      proxy_set_header X-Real-IP $remote_addr;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\n      # When setting up Harbor behind other proxy, such as an Nginx instance, remove the below line if the proxy already has similar settings.\n      # proxy_set_header X-Forwarded-Proto $scheme;\n      proxy_buffering off;\n      proxy_request_buffering off;\n\n      proxy_send_timeout 900;\n      proxy_read_timeout 900;\n    }\n location /service/ {\n      proxy_pass http://core/service/;\n      proxy_set_header Host $host;\n      proxy_set_header X-Real-IP $remote_addr;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\n      # When setting up Harbor behind other proxy, such as an Nginx instance, remove the below line if the proxy already has similar settings.\n      # proxy_set_header X-Forwarded-Proto $scheme;\n\n      proxy_buffering off;\n      proxy_request_buffering off;\n    }\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br")])]),t("h5",{attrs:{id:"然后，重启harbor服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#然后，重启harbor服务"}},[s._v("#")]),s._v(" 然后，重启harbor服务")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker-compose down\ndocker-compose up -d\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h2",{attrs:{id:"_3-dockers客户端测试push"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-dockers客户端测试push"}},[s._v("#")]),s._v(" 3. dockers客户端测试push")]),s._v(" "),t("h5",{attrs:{id:"_192-168-3-107-上测试push"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_192-168-3-107-上测试push"}},[s._v("#")]),s._v(" 192.168.3.107 上测试push")]),s._v(" "),t("h6",{attrs:{id:"客户端上修改docker配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#客户端上修改docker配置文件"}},[s._v("#")]),s._v(" 客户端上修改docker配置文件")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('# vi /etc/docker/daemon.json\n{\n "insecure-registries": ["harbor.ccbjb.com.cn"]\n}\n\n// 修改/etc/docker/daemon.json完成后reload配置文件\n# sudo systemctl daemon-reload\n\n// 重启docker服务\n# sudo systemctl restart docker.service\n\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("不修改login不进去，push不让")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# docker login -u admin harbor.ccbjb.com.cn\npassword:\n输入harbor.xml里Harbor12345（当然我已经改成别的了，输入你自己的密码）\nLogin Succeeded\n\n# docker tag node harbor.ccbjb.com.cn/library/vue/js\n\n# docker push harbor.ccbjb.com.cn/library/vue/js\nThe push refers to a repository [harbor.ccbjb.com.cn/library/vuejs/ci]\n3cb56e88501e: Pushed\n5fe5f08a709e: Pushed\n99ad6967cf69: Pushed\n2aa1c54ebc66: Pushed\n89cb25530034: Pushed\nc4b55423085b: Pushed\nb5e9932b9936: Pushed\nd5644f4d8741: Pushed\n4a03ae8d3bee: Pushed\na9286fedbd63: Pushed\nd50e7be1e737: Pushed\n6b114a2dd6de: Pushed\nbb9315db9240: Pushed\nlatest: digest: sha256:3b766dda613fcd2dce50e4e2ba6ef9ae0e322a52ca1fff6d9e466a06e2a8a0e6 size: 3063\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br")])]),t("h5",{attrs:{id:"同一个网段192-168-3-随便哪台机器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#同一个网段192-168-3-随便哪台机器"}},[s._v("#")]),s._v(" 同一个网段192.168.3.*随便哪台机器")]),s._v(" "),t("p",[s._v("https://harbor.ccbjb.com.cn/\nadmin\nHarbor12345\n都能够看到已经上传的镜像文件。")]),s._v(" "),t("hr"),s._v(" "),t("h1",{attrs:{id:"以下：一次失败的把-harbor安装在samba挂载上的经历（不要尝试）"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#以下：一次失败的把-harbor安装在samba挂载上的经历（不要尝试）"}},[s._v("#")]),s._v(" 以下：一次失败的把 Harbor安装在samba挂载上的经历（不要尝试）")]),s._v(" "),t("p",[s._v("修改docker卷位置\n首先把公司分给我的raid盘挂载过来。\n然后把harbor默认的dockers卷修改在这块磁盘上。这样至少存储上提高了点安全性。")]),s._v(" "),t("h2",{attrs:{id:"_1，作为samba的客户端挂载服务端的磁盘"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1，作为samba的客户端挂载服务端的磁盘"}},[s._v("#")]),s._v(" 1，作为samba的客户端挂载服务端的磁盘")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://githubshirongxin.github.io/Smba%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E7%A3%81%E7%9B%98/",target:"_blank",rel:"noopener noreferrer"}},[s._v("samba实现分布式磁盘"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("已经挂完 /data_cjb/")]),s._v(" "),t("ul",[t("li",[s._v("确认一下挂载情况：")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mount | grep data_cjb\n或者\ndf -hT | grep data_cjb\n或者\ncat /etc/fstab\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h2",{attrs:{id:"_2，修改harbor-docker-compose-yml-harbor-yml"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2，修改harbor-docker-compose-yml-harbor-yml"}},[s._v("#")]),s._v(" 2，修改harbor/docker-compose.yml , harbor.yml")]),s._v(" "),t("h3",{attrs:{id:"harbor-yml"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#harbor-yml"}},[s._v("#")]),s._v(" harbor.yml")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v(" # Log configurations\n   location: /var/log/harbor # 不改了，这块丢就丢了。\n # The default data volume\n #  data_volume: /data #这得改成mount好的raid盘目录\n data_volume: /data_cjb/harbordata\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h3",{attrs:{id:"docker-compose-yml"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#docker-compose-yml"}},[s._v("#")]),s._v(" docker-compose.yml")]),s._v(" "),t("p",[s._v("所有/data/ 都改成/data_cjb/harbordata/")]),s._v(" "),t("h2",{attrs:{id:"_3，执行-install-sh"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3，执行-install-sh"}},[s._v("#")]),s._v(" 3，执行"),t("code",[s._v("./install.sh")])]),s._v(" "),t("p",[s._v("最后/root/harbor/prepare 执行的时候报错。\n说容器内没有/data/secret/cert/目录没有permission denied")]),s._v(" "),t("h2",{attrs:{id:"结论：samba共享目录上无法安装harbor"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#结论：samba共享目录上无法安装harbor"}},[s._v("#")]),s._v(" 结论：samba共享目录上无法安装harbor")]),s._v(" "),t("p",[s._v("另外，我在nfs上共享目录上就能安装harbor。")]),s._v(" "),t("hr")])}),[],!1,null,null,null);a.default=n.exports}}]);