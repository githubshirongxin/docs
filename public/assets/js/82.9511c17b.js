(window.webpackJsonp=window.webpackJsonp||[]).push([[82],{570:function(s,a,t){"use strict";t.r(a);var e=t(59),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("作者：HanlyJiang\n链接：https://www.jianshu.com/p/4111534b339f")]),s._v(" "),t("h2",{attrs:{id:"请参考补记。"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#请参考补记。"}},[s._v("#")]),s._v(" 请参考补记。")]),s._v(" "),t("p",[s._v("最佳实践。")]),s._v(" "),t("h2",{attrs:{id:"建立认证目录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#建立认证目录"}},[s._v("#")]),s._v(" 建立认证目录")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("sudo mkdir -p /etc/gitlab/ssl\nsudo chmod 700 /etc/gitlab/ssl\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h2",{attrs:{id:"建立证书"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#建立证书"}},[s._v("#")]),s._v(" 建立证书")]),s._v(" "),t("h3",{attrs:{id:"建立自签名证书"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#建立自签名证书"}},[s._v("#")]),s._v(" 建立自签名证书")]),s._v(" "),t("h4",{attrs:{id:"_1-创建-private-key"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-创建-private-key"}},[s._v("#")]),s._v(" 1. 创建 Private Key")]),s._v(" "),t("p",[t("code",[s._v("sudo openssl genrsa -des3 -out /etc/gitlab/ssl/gitlab.domain.com.key 2048")])]),s._v(" "),t("p",[s._v("记住输入的密码（Pass phrase）")]),s._v(" "),t("h4",{attrs:{id:"_2-生成-certificate-request"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-生成-certificate-request"}},[s._v("#")]),s._v(" 2. 生成 Certificate Request")]),s._v(" "),t("p",[t("code",[s._v("sudo openssl req -new -key /etc/gitlab/ssl/gitlab.domain.com.key -out /etc/gitlab/ssl/gitlab.domain.com.csr")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("Enter Country Name US\nEnter State or Province Full Name\nEnter City Name\nEnter Organization Name\nEnter Company Name\nEnter Organizational Unit Name\nEnter server hostname i.e. URL gitlab.domain.com\nEnter Admin Email Address\nSkip Challenge Password (Hit Enter)\nSkip Optional Company Name (Hit Enter)\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("h4",{attrs:{id:"注-第一步和第二部可以合并成一条命令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#注-第一步和第二部可以合并成一条命令"}},[s._v("#")]),s._v(" 注: 第一步和第二部可以合并成一条命令")]),s._v(" "),t("p",[t("code",[s._v("openssl req -nodes -newkey rsa:2048 -keyout gitlab.domain.com.key -out gitlab.domain.com.csr")])]),s._v(" "),t("h4",{attrs:{id:"_3-移除private-key-中的密码短语"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-移除private-key-中的密码短语"}},[s._v("#")]),s._v(" 3. 移除Private Key 中的密码短语")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("sudo cp -v /etc/gitlab/ssl/gitlab.domain.com.{key,original}\nsudo openssl rsa -in /etc/gitlab/ssl/gitlab.domain.com.original -out /etc/gitlab/ssl/gitlab.domain.com.key\nsudo rm -v /etc/gitlab/ssl/gitlab.domain.com.original\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h4",{attrs:{id:"_4-创建证书"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-创建证书"}},[s._v("#")]),s._v(" 4. 创建证书")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("sudo openssl x509 -req -days 1460 -in /etc/gitlab/ssl/gitlab.domain.com.csr -signkey /etc/gitlab/ssl/gitlab.domain.com.key -out /etc/gitlab/ssl/gitlab.domain.com.crt\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h4",{attrs:{id:"_5-移除证书请求文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-移除证书请求文件"}},[s._v("#")]),s._v(" 5. 移除证书请求文件")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("sudo rm -v /etc/gitlab/ssl/gitlab.domain.com.csr    \n// 设置文件权限\nsudo chmod 600 /etc/gitlab/ssl/gitlab.domain.com.*\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h4",{attrs:{id:"gitlab-配置更改"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-配置更改"}},[s._v("#")]),s._v(" gitlab 配置更改")]),s._v(" "),t("p",[t("code",[s._v("sudo vim /etc/gitlab/gitlab.rb")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("external_url 'https://gitlab.domain.com'\n可选配置：\ngitlab 网站https：\nnginx['redirect_http_to_https'] = true\ngitlab ci 网站https：\nci_nginx['redirect_http_to_https'] = true\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("h4",{attrs:{id:"复制证书到gitlab目录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#复制证书到gitlab目录"}},[s._v("#")]),s._v(" 复制证书到gitlab目录：")]),s._v(" "),t("p",[t("code",[s._v("sudo cp /etc/gitlab/ssl/etc/gitlab/ssl/gitlab.domain.com.crt /etc/gitlab/trusted-certs/")])]),s._v(" "),t("h4",{attrs:{id:"gitlab重新配置-更新"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#gitlab重新配置-更新"}},[s._v("#")]),s._v(" gitlab重新配置+更新：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("sudo gitlab-ctl reconfigure\nsudo gitlab-ctl restart\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h4",{attrs:{id:"z-注意事项"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#z-注意事项"}},[s._v("#")]),s._v(" Z. 注意事项")]),s._v(" "),t("h6",{attrs:{id:"z1-gitlab如何找到对应的证书"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#z1-gitlab如何找到对应的证书"}},[s._v("#")]),s._v(" Z1. gitlab如何找到对应的证书？")]),s._v(" "),t("p",[s._v("/etc/gitlab/gitlab.rb 配置的external_url 如果是https://gitlab.domain.com 那么gitlab会自动去找/etc/gitlab/ssl/ 目录中的gitlab.domain.com.crt 和gitlab.domain.com.key 文件，所以如果需要更换external_url，可以采取如下办法：")]),s._v(" "),t("p",[s._v("将原先的crt和key文件改名为新的external_url 对应的域名\n直接通过配置指定证书和key文件的路径\nnginx['ssl_certificate'] = \"/etc/gitlab/ssl/gitlab.domain.com.crt\"\n　　\nnginx['ssl_certificate_key'] = \"/etc/gitlab/ssl/gitlab.domain.com.key\"\n别忘了reconfigure")]),s._v(" "),t("h2",{attrs:{id:"_2020-8-14-补记"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2020-8-14-补记"}},[s._v("#")]),s._v(" 2020-8-14 补记")]),s._v(" "),t("p",[s._v("自签证书已经不用自己敲许多命令了。\n直接用一个命令+域名就能生成所有证书。")]),s._v(" "),t("p",[s._v("https://github.com/Fishdrowned/ssl")]),s._v(" "),t("p",[s._v("clone 到192.168.3.107")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("[root@centos3 ssl]# cd ssl\n[root@centos3 ssl]# ls\nca.cnf  docs  flush.sh  gen.cert.sh  gen.root.sh  LICENSE  README.md\n[root@centos3 ssl]# ./gen.cert.sh nexus.ccbjb.com.cn\nRemoving dir out\nCreating output structure\nstateOrProvinceName   :ASN.1 12:'Guangdong'\nlocalityName          :ASN.1 12:'Guangzhou'\norganizationName      :ASN.1 12:'Fishdrowned'\norganizationalUnitName:ASN.1 12:'nexus.ccbjb.com.cn'\ncommonName            :ASN.1 12:'*.nexus.ccbjb.com.cn'\nCertificate is to be certified until Aug  5 01:54:11 2022 GMT (730 days)\n\nWrite out database with 1 new entries\nData Base Updated\n\nCertificates are located in:\nlrwxrwxrwx 1 root root 45 8月   5 09:54 /root/ssl/ssl/out/nexus.ccbjb.com.cn/nexus.ccbjb.com.cn.bundle.crt -> ./20200805-0954/nexus.ccbjb.com.cn .bundle.crt\nlrwxrwxrwx 1 root root 38 8月   5 09:54 /root/ssl/ssl/out/nexus.ccbjb.com.cn/nexus.ccbjb.com.cn.crt -> ./20200805-0954/nexus.ccbjb.com.cn.crt\nlrwxrwxrwx 1 root root 15 8月   5 09:54 /root/ssl/ssl/out/nexus.ccbjb.com.cn/nexus.ccbjb.com.cn.key.pem -> ../cert.key.pem\nlrwxrwxrwx 1 root root 11 8月   5 09:54 /root/ssl/ssl/out/nexus.ccbjb.com.cn/root.crt -> ../root.crt\n[root@centos3 ssl]#\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br")])])])}),[],!1,null,null,null);a.default=n.exports}}]);