(window.webpackJsonp=window.webpackJsonp||[]).push([[52],{466:function(s,e,t){"use strict";t.r(e);var a=t(48),r=Object(a.a)({},(function(){var s=this,e=s.$createElement,t=s._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("https://linuxacademy.com/cp/courses/lesson/course/4420/lesson/7/module/347")]),s._v(" "),t("p",[s._v("Relevant Documentation\nhttps://docs.docker.com/registry/deploying/\nhttps://docs.docker.com/registry/configuration/\nhttps://docs.docker.com/registry/insecure/")]),s._v(" "),t("p",[s._v("Lesson Reference\nRun a simple registry:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker run -d -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v(":5000 --restart"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("always --name registry registry:2\ndocker container stop registry "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" docker container "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -v registry\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("Override the log level using an environment variable:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker logs registry\ndocker container stop registry "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" docker container "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -v registry\ndocker run -d -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v(":5000 --restart"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("always --name registry -e "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REGISTRY_LOG_LEVEL")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("debug registry:2\ndocker logs registry\ndocker container stop registry "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" docker container "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" -v registry\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("Secure the registry by generating an htpasswd file to be used for authentication:")]),s._v(" "),t("h2",{attrs:{id:"registry-ssl"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#registry-ssl"}},[s._v("#")]),s._v(" registry ssl")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" ~/registry\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" ~/registry\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" auth\ndocker run --entrypoint htpasswd registry:2.7.0 -Bbn testuser password "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" auth/htpasswd\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("Generate a self-signed certificate. When generating the cert, leave the prompts blank except for Common Name*. For *Common Name, put the public hostname of the registry server. The public hostname is in the playground interface:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" certs\nopenssl req "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -newkey rsa:4096 -nodes -sha256 -keyout certs/domain.key "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -x509 -days "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("365")]),s._v(" -out certs/domain.crt\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("Run the registry with authentication and TLS enabled:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker run -d -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v(":443 --restart"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("always --name registry "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -v /home/cloud_user/registry/certs:/certs "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -v /home/cloud_user/registry/auth:/auth "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -e "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REGISTRY_HTTP_ADDR")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0:443 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -e "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REGISTRY_HTTP_TLS_CERTIFICATE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/certs/domain.crt "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -e "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REGISTRY_HTTP_TLS_KEY")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/certs/domain.key "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -e "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REGISTRY_AUTH")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("htpasswd "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -e "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  -e "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REGISTRY_AUTH_HTPASSWD_PATH")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/auth/htpasswd "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  registry:2\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("h2",{attrs:{id:"client-docker-login-to-registry"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#client-docker-login-to-registry"}},[s._v("#")]),s._v(" Client： docker login to registry")]),s._v(" "),t("p",[s._v("// registry 自签了之后docker login失败的解决方案：\n"),t("img",{attrs:{src:"/docs/images/2020-08-11-10-24-52.png",alt:""}})]),s._v(" "),t("p",[s._v("Relevant Documentation\nhttps://docs.docker.com/engine/reference/commandline/push/\nhttps://docs.docker.com/engine/reference/commandline/pull/\nhttps://docs.docker.com/engine/reference/commandline/login/\nhttps://docs.docker.com/registry/insecure/\nhttps://docs.docker.com/engine/reference/commandline/search/")]),s._v(" "),t("p",[s._v("Lesson Reference\nPull and search images on Docker hub:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker pull ubuntu\ndocker search ubuntu\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("Attempt to authenticate against the private registry:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker login "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("registry public hostname"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("Log in with the credentials we created earlier (testuser and password). A certificate signed by unknown authority message should pop up, because we are using a self-signed certificate.")]),s._v(" "),t("p",[s._v("Configure docker to ignore certificate verification when accessing the private registry:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/docker/daemon.json\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"insecure-registries"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"<registry public hostname>"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("Restart docker:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl restart docker\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("Try docker login again:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker login "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("registry public hostname"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("This time it should work!")]),s._v(" "),t("p",[s._v("However, this method of accessing the registry is very insecure. It turns off certificate verification entirely, exposing us to man-in-the-middle attacks. So, let's do this the right way.")]),s._v(" "),t("p",[s._v("First, log out of the private registry:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("logout")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("registry public hostname"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("Next, remove the insecure-registries key and value from /etc/docker/daemon.json.")]),s._v(" "),t("p",[s._v("Restart Docker:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" systemctl restart docker\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("Download the cert public key from the registry and configure the local docker engine to use it:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /etc/docker/certs.d/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("registry public hostname"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" cloud_user@"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("registry public hostname"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(":/home/cloud_user/registry/certs/domain.crt /etc/docker/certs.d/"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("registry public hostname"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("Try docker login:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker login "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("registry public hostname"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("Push to and pull from your private registry:")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("docker pull ubuntu\ndocker tag ubuntu "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("registry public hostname"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/ubuntu\ndocker push "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("registry public hostname"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/ubuntu\ndocker image "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("registry public hostname"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/ubuntu\ndocker image "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" ubuntu\ndocker pull "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("registry public hostname"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/ubuntu\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])])])}),[],!1,null,null,null);e.default=r.exports}}]);