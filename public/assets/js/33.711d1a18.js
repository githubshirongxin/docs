(window.webpackJsonp=window.webpackJsonp||[]).push([[33],{510:function(t,e,s){"use strict";s.r(e);var a=s(55),n=Object(a.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("单机版。写个shell每天备份该机器/srv目录到公司的raid盘。先公司内部凑合用。\n存储高可用的，我现在还不知道怎么做。")]),t._v(" "),s("p",[t._v("完全基于"),s("a",{attrs:{href:"https://juejin.im/post/5b55bf1c6fb9a04fac0d13b3",target:"_blank",rel:"noopener noreferrer"}},[t._v("[Docker折腾记: (3)Docker Compose构建Gitlab,从配置(https,邮箱验证)到基本可用]"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("成功部署在192.168.3.111上，验证好用。")]),t._v(" "),s("h1",{attrs:{id:"gitlab-docker-compose-install"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-docker-compose-install"}},[t._v("#")]),t._v(" gitlab docker-compose install")]),t._v(" "),s("p",[t._v("这才是我想要的gitlab docker-compose部署的方式\n配置写得非常好")]),t._v(" "),s("h2",{attrs:{id:"版本二的docker-compose-xml，基本可用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#版本二的docker-compose-xml，基本可用"}},[t._v("#")]),t._v(" 版本二的docker-compose.xml，基本可用")]),t._v(" "),s("p",[t._v("唯独一点：2222:22 → 22:22 .否则"),s("code",[t._v("git clone git@gitlab.ccbjb.com.cn:shirongxin/edusite.git")]),t._v(" 永远提示输入密码，输入什么也不对。具体做法下面有。")]),t._v(" "),s("h3",{attrs:{id:"修改docker-compose-yml"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#修改docker-compose-yml"}},[t._v("#")]),t._v(" 修改docker-compose.yml")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("version: '3.6'\nservices:\n  gitlab:\n    container_name: gitlab\n    privileged: true\n    image: gitlab/gitlab-ce:latest\n    restart: always\n    hostname: 'gitlab.ccbjb.com.cn'\n    environment:\n      GITLAB_OMNIBUS_CONFIG: |\n        external_url 'https://gitlab.ccbjb.com.cn'\n        gitlab_rails['smtp_enable'] = true\n        gitlab_rails['smtp_address'] = \"（邮件服务器IP）.100.5\"\n        gitlab_rails['smtp_port'] = 25\n        gitlab_rails['smtp_user_name'] = \"shirx@ccbjb.com.cn\"\n        gitlab_rails['smtp_password'] = \"密码\"\n        gitlab_rails['smtp_domain'] = \"ccbjb.com.cn\"\n        gitlab_rails['smtp_authentication'] = \"login\"\n        gitlab_rails['smtp_enable_starttls_auto'] = true\n        gitlab_rails['smtp_tls'] = false\n        gitlab_rails['gitlab_email_from'] = 'shirx@ccbjb.com.cn'\n        gitlab_rails['gitlab_email_reply_to'] = 'shirx@ccbjb.com.cn'\n        nginx['enable'] = true\n        nginx['client_max_body_size'] = '250m'\n        nginx['redirect_http_to_https'] = true\n        nginx['ssl_certificate'] = \"/etc/gitlab/ssl/gitlab.ccbjb.com.cn_chain.crt\"\n        nginx['ssl_certificate_key'] = \"/etc/gitlab/ssl/gitlab.ccbjb.com.cn_key.key\"\n        nginx['ssl_ciphers'] = \"ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256\"\n        nginx['ssl_prefer_server_ciphers'] = \"on\"\n        nginx['ssl_protocols'] = \"TLSv1.1 TLSv1.2\"\n        nginx['ssl_session_cache'] = \"builtin:1000  shared:SSL:10m\"\n        nginx['listen_addresses'] = [\"0.0.0.0\"]\n        nginx['http2_enabled'] = true\n    ports:\n      - '80:80'\n      - '443:443'\n      - '22:22'\n    volumes:\n      - '/srv/gitlab/config:/etc/gitlab'\n      - '/srv/gitlab/logs:/var/log/gitlab'\n      - '/srv/gitlab/data:/var/opt/gitlab'\n  gitlab-runner:\n    image: gitlab/gitlab-runner:alpine\n")])])]),s("h3",{attrs:{id:"_1-重新安装的时候，因为gitlab的数据已经有一些更新了。并备份了一下数据。"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-重新安装的时候，因为gitlab的数据已经有一些更新了。并备份了一下数据。"}},[t._v("#")]),t._v(" 1. 重新安装的时候，因为gitlab的数据已经有一些更新了。并备份了一下数据。")]),t._v(" "),s("p",[s("code",[t._v("tar cvf srv.tar /srv")])]),t._v(" "),s("p",[t._v("如果需要在别的机器安装，或者本3.111机器因为某种原因重新安装虚拟机了，\n需要把srv.tar备份到某处，千万不要放到一台机器上，太危险。\n另外，也需要至少每天备份一次。")]),t._v(" "),s("p",[t._v("先这么手动备份把，之后我准备把gitlab安装成主从备份模式。\n成功之后我准备安装到k8s上，多节点，数据也是多节点。这样就不怕单点失败了。")]),t._v(" "),s("h3",{attrs:{id:"_2-运行docker-compose之前，免费证书申请"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-运行docker-compose之前，免费证书申请"}},[t._v("#")]),t._v(" 2. 运行docker-compose之前，免费证书申请")]),t._v(" "),s("p",[t._v("https://freessl.org/apply?domains=gitlab.ccbjb.com.cn&product=buypass01&from=")]),t._v(" "),s("p",[s("img",{attrs:{src:"/docs/images/2020-07-03-16-27-18.png",alt:""}}),t._v(" "),s("img",{attrs:{src:"/docs/images/2020-07-03-16-27-33.png",alt:""}}),t._v(" "),s("img",{attrs:{src:"/docs/images/2020-07-03-16-28-18.png",alt:""}})]),t._v(" "),s("ul",[s("li",[s("p",[t._v("KeyManage 选择导出的时候选择"),s("strong",[t._v("ngix方式")]),t._v("，因为gitlab的证书是配置在nginx里的。")])]),t._v(" "),s("li",[s("p",[t._v("并用DNS验证的方式验证。下载下来压缩包解压后是两个文件，\ngitlab.ccbjb.com.cn_chain.crt\ngitlab.ccbjb.com.cn_key.key")])]),t._v(" "),s("li",[s("p",[t._v("拷贝到/etc/gitlab/ssl/(容器内视角)\n或拷贝到宿主机srv/gitlab/config/ssl（宿主机视角）")])]),t._v(" "),s("li",[s("p",[t._v("修改docker-compose.yml对应的证书的部分。")])])]),t._v(" "),s("h3",{attrs:{id:"_3-把宿主机3-111的ssh端口22空出来。供容器映射用，必须这么做。很重要！！！！"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-把宿主机3-111的ssh端口22空出来。供容器映射用，必须这么做。很重要！！！！"}},[t._v("#")]),t._v(" 3. 把宿主机3.111的ssh端口22空出来。供容器映射用，必须这么做。很重要！！！！")]),t._v(" "),s("p",[t._v("参考： "),s("a",{attrs:{href:"https://blog.csdn.net/ZanShichun/article/details/78029561?utm_source=blogxgwz5",target:"_blank",rel:"noopener noreferrer"}},[t._v("Centos7如何修改ssh默认端口"),s("OutboundLink")],1)]),t._v(" "),s("h4",{attrs:{id:"_3-1-停掉firewall，停掉selinux"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-停掉firewall，停掉selinux"}},[t._v("#")]),t._v(" 3.1 停掉firewall，停掉selinux")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("systemctl stop firewalld\nsystemctl disable firewalld\nsed -i 's/enforcing/disabled/' /etc/selinux/config\nsetenforce 0\nsystemctl stop NetworkManager\nsystemctl disable NetworkManager\n")])])]),s("h4",{attrs:{id:"_3-2-增加2020为ssh端口"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-增加2020为ssh端口"}},[t._v("#")]),t._v(" 3.2 增加2020为ssh端口")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$ vi /etc/ssh/sshd_config\n Port 22  \n Port 2020\n\n//重启sshd服务\nsystemctl restart sshd.service\n\n//验证2020为ssh\n$ ssh -p 2020 root@192.168.3.111 //成功\n\n//删除Port 22 这一行，只留下我们的Port 2020\nvim /etc/ssh/sshd_config\n\n//然后重启ssh服务\nsystemctl restart sshd.service\n")])])]),s("h4",{attrs:{id:"_3-3-必须重新启动docker服务。否则执行docker-compose会报如下错误：-因为停掉firewall"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-必须重新启动docker服务。否则执行docker-compose会报如下错误：-因为停掉firewall"}},[t._v("#")]),t._v(" 3.3 必须重新启动docker服务。否则执行docker-compose会报如下错误：(因为停掉firewall)")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("Error response from daemon: driver failed programming external connectivity\n on endpoint jenkins (a8ea15bf9b3dbed599d059d638f79f9dd5e875556c39bfb41e6563d3feedb81b):\n  (iptables failed: iptables --wait -t nat -A DOCKER -p tcp -d 0/0 --dport 50000 -j DNAT\n --to-destination 172.18.0.6:50000 ! -i br-031aa3930383: iptables: No chain/target/match\n by that name.\n")])])]),s("p",[t._v("光看这个报错: iptables: No chain/target/match by that name，就能够看出是跟iptables有关,如果再启动docker service的时候网关是关闭的，那么docker管理网络的时候就不会操作网管的配置（chain docker），然后网关重新启动了，导致docker network无法对新container进行网络配置，也就是没有网管的操作权限，做重启处理.")]),t._v(" "),s("h4",{attrs:{id:"_3-4【处理】-必须重启docker服务，这步必须做！！"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-4【处理】-必须重启docker服务，这步必须做！！"}},[t._v("#")]),t._v(" 3.4【处理】: 必须重启docker服务，这步必须做！！")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("service docker restart\n或\nsystemctl restart  docker\n")])])]),s("h2",{attrs:{id:"_4-然后，启动docker-compose"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-然后，启动docker-compose"}},[t._v("#")]),t._v(" 4.然后，启动docker-compose")]),t._v(" "),s("p",[s("code",[t._v("docker-compose up -d")]),t._v("\n即可。")]),t._v(" "),s("h2",{attrs:{id:"_5-验证gitlab运行状态"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-验证gitlab运行状态"}},[t._v("#")]),t._v(" 5. 验证gitlab运行状态")]),t._v(" "),s("h4",{attrs:{id:"_5-1-docker-logs-看容器启动日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-docker-logs-看容器启动日志"}},[t._v("#")]),t._v(" 5.1 docker logs 看容器启动日志")]),t._v(" "),s("p",[s("img",{attrs:{src:"/docs/images/2020-07-03-20-08-21.png",alt:""}}),t._v(" "),s("code",[t._v("docker logs -f 32de52f7ae22")]),t._v(" 查看容器日志，看到gitlab启动情况")]),t._v(" "),s("p",[t._v("现在能看到,别的都正常！")]),t._v(" "),s("p",[t._v("【残留课题】：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("ERROR: Failed to load config stat /etc/gitlab-runner/config.toml: no such file or directory  builds=0\n")])])]),s("h4",{attrs:{id:"_5-2-画面正常启动，原来的内容都保留着。"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-画面正常启动，原来的内容都保留着。"}},[t._v("#")]),t._v(" 5.2 画面正常启动，原来的内容都保留着。")]),t._v(" "),s("p",[s("img",{attrs:{src:"/docs/images/2020-07-03-20-20-38.png",alt:""}})]),t._v(" "),s("h4",{attrs:{id:"_5-3-git-clone-ssh看看是否正常"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-git-clone-ssh看看是否正常"}},[t._v("#")]),t._v(" 5.3 git clone ssh看看是否正常")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("srx@DESKTOP-UQ03MQF MINGW64 /c/work/gitlab.ccbjb.com.cn\n$ git clone git@gitlab.ccbjb.com.cn:shirongxin/edusite.git\n")])])]),s("blockquote",[s("p",[t._v("Cloning into 'edusite'...\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\nIT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!\nSomeone could be eavesdropping on you right now (man-in-the-middle attack)!\nIt is also possible that a host key has just been changed.\nThe fingerprint for the ECDSA key sent by the remote host is\nSHA256:wsq50fWrV3xiqsKGem5DUWqGCglzR/WP1F3FhfBVH2A.\nPlease contact your system administrator.\nAdd correct host key in /c/Users/srx/.ssh/known_hosts to get rid of this message.\nOffending ECDSA key in /c/Users/srx/.ssh/known_hosts:12\nECDSA host key for gitlab.ccbjb.com.cn has changed and you have requested strict checking.\nHost key verification failed.\nfatal: Could not read from remote repository.\nPlease make sure you have the correct access rights\nand the repository exists.")])]),t._v(" "),s("p",[t._v("处理：把自己用户c:/users/srx/.ssh/know_hosts里删掉\ngitlab.ccbjb.com.cn这一行")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("srx@DESKTOP-UQ03MQF MINGW64 /c/work/gitlab.ccbjb.com.cn\n$ git clone git@gitlab.ccbjb.com.cn:shirongxin/edusite.git\n")])])]),s("blockquote",[s("p",[t._v("Cloning into 'edusite'...\nThe authenticity of host 'gitlab.ccbjb.com.cn (192.168.3.111)' can't be established.\nECDSA key fingerprint is SHA256:wsq50fWrV3xiqsKGem5DUWqGCglzR/WP1F3FhfBVH2A.\nAre you sure you want to continue connecting (yes/no)? yes\nWarning: Permanently added 'gitlab.ccbjb.com.cn' (ECDSA) to the list of known hosts.\nWarning: the ECDSA host key for 'gitlab.ccbjb.com.cn' differs from the key for the IP address '192.168.3.111'\nOffending key for IP in /c/Users/srx/.ssh/known_hosts:11\nAre you sure you want to continue connecting (yes/no)? yes\nremote: Enumerating objects: 38, done.\nremote: Counting objects: 100% (38/38), done.\nremote: Compressing objects: 100% (28/28), done.\nremote: Total 38 (delta 4), reused 38 (delta 4), pack-reused 0\nReceiving objects: 100% (38/38), 4.67 KiB | 239.00 KiB/s, done.\nResolving deltas: 100% (4/4), done.")])]),t._v(" "),s("p",[t._v("ssh方式clone OK了")]),t._v(" "),s("p",[t._v("能够免密了。（公钥已经放到了gitlab的SSH-KEY）中了。")]),t._v(" "),s("h4",{attrs:{id:"_5-4-git-clone-https-验证"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-git-clone-https-验证"}},[t._v("#")]),t._v(" 5.4 git clone https 验证")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$ git clone https://gitlab.ccbjb.com.cn/shirongxin/edusite.git\n")])])]),s("blockquote",[s("p",[t._v("Cloning into 'edusite'...\nremote: Enumerating objects: 38, done.\nremote: Counting objects: 100% (38/38), done.\nremote: Compressing objects: 100% (28/28), done.\nremote: Total 38 (delta 4), reused 38 (delta 4), pack-reused 0\nUnpacking objects: 100% (38/38), done.")])]),t._v(" "),s("p",[t._v("成功！\n至此，就差防止gitlab单点故障问题了。")]),t._v(" "),s("h3",{attrs:{id:"_6-todo："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-todo："}},[t._v("#")]),t._v(" 6.TODO：")]),t._v(" "),s("ul",[s("li",[t._v("方案1： 主从gitlab实时备份")]),t._v(" "),s("li",[t._v("方案2： k8s运行gitlab多节点共享数据，共享数据多点同步")])])])}),[],!1,null,null,null);e.default=n.exports}}]);